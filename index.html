<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order Management</title>
    
    <!-- PWA Meta Tags & Manifest -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#005f73">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48Y2lyY2xlIGN4PSI5NiIgY3k9Ijk2IiByPSI5NiIgZmlsbD0iIzAwNWY3MyIvPjx0ZXh0IHg9Ijk2IiB5PSIxMzYiIGZvbnQtZm1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iOTAiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIj5NRjwvdGV4dD48L3N2Zz4=">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add this line inside the <head> tag of your HTML file -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- LeafletJS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, initializeFirestore, persistentLocalCache, persistentMultipleTabManager, getDocs, getDoc, collection, doc, setDoc, onSnapshot, deleteDoc, writeBatch, query, updateDoc, deleteField, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyDdECOGyNKFsKtWDiArUPp0DVd_bN0BjAY",
        authDomain: "bigmarket-order-app.firebaseapp.com",
        projectId: "bigmarket-order-app",
        storageBucket: "bigmarket-order-app.firebasestorage.app",
        messagingSenderId: "905682701991",
        appId: "1:905682701991:web:77b4028bbed29204a59582"
      };

      const app = initializeApp(firebaseConfig);
      
      const db = initializeFirestore(app, {
          localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
      });

      window.firebaseDB = db;
      window.firebaseTools = { getDocs, getDoc, collection, doc, setDoc, onSnapshot, deleteDoc, writeBatch, query, updateDoc, deleteField, addDoc };

    </script>
    
    <style>

        :root {
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --accent-color: #ee9b00;
            --light-bg: #e0f7fa;
            --text-color: #212529;
            --light-text-color: #fff;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 15px rgba(0, 95, 115, 0.1);
            --border-radius: 12px;
            --danger-color: #e63946;
            --success-color: #2a9d8f;
            --warning-color: #fb8500;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            background-color: var(--light-bg); 
            color: var(--text-color); 
            overscroll-behavior-y: contain;
            overflow-x: hidden;
        }
        .page { display: none; flex-direction: column; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background-color: var(--light-bg); transition: transform 0.3s ease-in-out; }
        .page.active { display: flex; }

        .header { background-color: var(--primary-color); color: var(--light-text-color); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; }
        .header h1 { font-size: 1.4rem; font-weight: 600; text-align: center; flex-grow: 1; }
        .header .icon-button { background: none; border: none; color: var(--light-text-color); cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; position: relative; flex-shrink: 0; }
        .header .icon-button:active { background-color: rgba(255, 255, 255, 0.15); }
        .header .header-actions { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }

        #cart-item-count {
            position: absolute; top: -4px; right: -6px; background-color: var(--danger-color); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold; line-height: 1; min-width: 20px; text-align: center; border: 2px solid var(--primary-color);
        }

        .content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .footer { display: flex; justify-content: space-around; background-color: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); padding: 5px 0 10px 0; flex-shrink: 0; }
        .footer-button { background: none; border: none; color: #888; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; cursor: pointer; padding: 5px 10px; border-radius: var(--border-radius); transition: color 0.2s; text-align: center; flex: 1; }
        .footer-button.active { color: var(--secondary-color); font-weight: 600; }
        .footer-button svg { width: 26px; height: 26px; margin-bottom: 2px; }

        .card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 16px; margin-bottom: 16px; }
        .card h3 { margin: 0 0 15px 0; color: var(--primary-color); font-size: 1.2rem; }
        
        .button { display: inline-block; width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600; text-align: center; color: var(--light-text-color); background: linear-gradient(45deg, var(--secondary-color), var(--primary-color)); border: none; border-radius: var(--border-radius); cursor: pointer; transition: opacity 0.3s ease, transform 0.1s ease; box-shadow: 0 4px 10px rgba(0, 95, 115, 0.25); }
        .button:active { transform: scale(0.98); opacity: 0.9; }
        .button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; opacity: 0.7; }
        .button-accent { background: linear-gradient(45deg, #ffb703, #fb8500); }
        .button-outline { background: #fff; color: var(--primary-color); border: 2px solid var(--border-color); box-shadow: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .button-outline:active { background-color: #f8f9fa; }

        input[type="text"], input[type="number"], input[type="date"], input[type="file"], .form-group select, textarea { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit; }
        textarea { line-height: 1.5; }
        input:focus, .form-group select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 2px rgba(10, 147, 150, 0.2); }
        
        .search-bar { position: relative; }
        .search-bar input { padding-left: 40px; border-radius: 50px; }
        .search-bar svg { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; width: 20px; height: 20px; }
        
        .filter-bar { display: flex; gap: 15px; align-items: center; padding: 10px; background-color: #ffffffcc; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: var(--border-radius); margin: -5px -5px 15px -5px; position: sticky; top: 5px; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .filter-bar .search-bar { flex: 2; margin-bottom: 0; }
        .filter-bar .form-group { flex: 1.5; margin-bottom: 0; }
        .filter-bar input, .filter-bar select { margin-bottom: 0; }
        .filter-bar select { border-radius: 50px; }

        .between-date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
            background-color: #fff;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        /* Add this new CSS to your main style block */

.date-input-wrapper {
    position: relative;
    overflow: hidden; /* Ensures the oversized input doesn't spill out */
    flex: 1; /* Make it fill space like the button did */
    min-width: 120px;
}

.between-date-filter .date-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0; /* Make it completely transparent */
    cursor: pointer; /* Ensure it has a pointer cursor */
    border: none;
}
        .between-date-filter .date-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--primary-color);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .between-date-filter .date-btn.has-date {
            background-color: var(--light-bg);
            border-color: var(--secondary-color);
        }
        .between-date-filter .date-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--secondary-color);
            flex-shrink: 0;
        }
        .between-date-filter .filter-action-btn {
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .between-date-filter .clear-btn {
            background: #fff;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        .between-date-filter .clear-btn:active {
            background-color: #fff1f2;
        }
        .between-date-filter .date-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            border: 0;
            padding: 0;
            pointer-events: none;
        }
                #password-error-message {
            margin-top: 10px;
            font-weight: 500;
        }
                /* --- Enhanced Password Modal Styles --- */
                /* --- Enhanced Password Modal Styles --- */
                /* --- Enhanced Password Modal Styles --- */
                /* --- Enhanced Password Modal Styles --- */
        #password-modal .modal-content {
            text-align: center;
        }

        .password-icon-container {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px auto;
            background-color: var(--light-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
        }

        .password-icon-container svg {
            width: 32px;
            height: 32px;
            stroke: var(--secondary-color);
            stroke-width: 1.5;
        }

        /* This is the container for the label AND the input */
        #password-form-group {
            max-width: 280px;   /* Constrain the width of the group */
            margin: 0 auto;     /* Horizontally center the entire group */
            text-align: center; /* Force all text inside (like the label) to be centered */
        }

        #password-form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color); /* Corrected color for better contrast */
            margin-bottom: 8px;
            display: block; /* Ensure it behaves as a block to respect centering */
        }

        #password-input {
    /* Add these two new lines */
    max-width: 280px;
    margin: 0 auto 5px auto;

    /* Existing styles below */
    text-align: center;
    font-size: 1.5rem;
    letter-spacing: 0.3em;
    padding: 12px 15px;
            margin-bottom: 5px;
        }
        
        #password-input::placeholder {
            letter-spacing: normal;
        }
        
        #password-error-message {
            margin-top: 10px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--danger-color);
        }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: #fff; border-radius: var(--border-radius); margin-bottom: 12px; box-shadow: var(--card-shadow); transition: transform 0.2s ease, box-shadow 0.2s, opacity 0.5s, max-height 0.5s, padding 0.5s, margin-bottom 0.5s; }
        .list-item:active { transform: scale(0.99); box-shadow: 0 2px 8px rgba(0, 95, 115, 0.1); }
        .list-item .info { flex: 1; font-size: 1rem; font-weight: 500; line-height: 1.4; margin-right: 15px; }
        .list-item-action { flex-shrink: 0; padding: 12px 15px; min-width: 110px; text-align: center; font-size: 1rem; color: var(--light-text-color); background-color: var(--secondary-color); border: none; border-radius: 8px; cursor: pointer; }
        .list-item-action.packing { background-color: var(--warning-color); }
        .list-item-action:disabled { background-color: #bdc3c7; }
        .list-item.removing {
            opacity: 0;
            transform: translateX(-100%);
            max-height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            overflow: hidden;
            border-top: none;
            border-bottom: none;
        }

        .customer-item-container { background-color: #fff; border-radius: var(--border-radius); margin-bottom: 12px; box-shadow: var(--card-shadow); overflow: hidden; transition: box-shadow 0.2s; }
        .customer-item-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 15px; cursor: pointer; }
        .customer-item-header .info { font-size: 1.1rem; font-weight: 500; }
        .customer-item-header .arrow { width: 24px; height: 24px; transition: transform 0.3s ease; }
        .customer-item-container.expanded .arrow { transform: rotate(180deg); }
        .customer-actions-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; display: flex; justify-content: space-around; background-color: #f8f9fa; border-top: 1px solid var(--border-color); }
        .customer-item-container.expanded .customer-actions-panel { max-height: 100px; padding: 12px 0; }
        .action-button { display: flex; flex-direction: column; align-items: center; gap: 5px; background: none; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 500; color: var(--primary-color); padding: 5px 10px; border-radius: 8px; transition: background-color 0.2s; }
        .action-button:active { background-color: rgba(0, 95, 115, 0.1); }
        .action-button svg { width: 28px; height: 28px; stroke: var(--primary-color); stroke-width: 2; }

        .cash-bill-item { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 15px; background-color: #fff; border-radius: var(--border-radius); margin-bottom: 12px; box-shadow: var(--card-shadow); gap: 15px;}

        .history-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin-bottom: 15px; overflow: hidden; transition: all 0.4s ease-out; }
        .history-card-header { padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .history-card-header .info { flex-grow: 1; }
        .history-card-header .actions { display: flex; gap: 15px; flex-shrink: 0; margin-left: 10px; align-items: center; }
        .history-card-header p { margin: 0 0 5px; }
        .history-card-header p strong { font-weight: 600; color: var(--primary-color); }
        .history-card .date-display { font-size:0.9rem; color:#666; }
        .history-card .toggle-details { font-size: 0.9rem; font-weight: 500; color: var(--secondary-color); cursor: pointer; padding: 10px 15px; display: block; background: #f8f9fa; border-top: 1px solid #f0f0f0; }
        .history-card-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .history-card-body.visible { max-height: 5000px; transition: max-height 0.4s ease-in; }
        .history-item-table { width: 100%; border-collapse: collapse; }
        .history-item-table th, .history-item-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .history-item-table th { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .history-item-table td.numeric, .history-item-table th.numeric { text-align: right; white-space: nowrap; }
        .history-item-table tr:last-child td { border-bottom: none; }
        .history-item-table .col-item-name { width: 45%; white-space: normal; word-break: break-word; line-height: 1.4; }
        .history-action-btn { background: none; border: none; cursor: pointer; padding: 0; }
        .history-action-btn svg { width: 20px; height: 20px; }
        .delete-history-btn svg { stroke: var(--danger-color); }
        .print-history-btn svg, .print-loading-slip-btn svg { stroke: var(--secondary-color); }
        .download-bill-btn svg { stroke: var(--primary-color); }
        .edit-packing-slip-btn svg { stroke: var(--warning-color); }
        .history-card.removing {
            opacity: 0;
            transform: scale(0.95);
            max-height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            overflow: hidden;
            border-top: none;
            border-bottom: none;
        }
        .bill-type-badge {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .payment-method-options { display: flex; gap: 10px; margin: 15px 0; }
        .payment-method-option { flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .payment-method-option.selected { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); font-weight: bold; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background-color: #fff; margin: auto; padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 500px; text-align: left; max-height: 80vh; display: flex; flex-direction: column; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: scale(1); }
        .modal-content h2 { text-align: center; margin-bottom: 15px; color: var(--primary-color); }
        .modal .button { margin-top: 10px; }
        .modal-body { overflow-y: auto; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .modal-footer .button { margin-top: 0; }
        
        #item-tiles-container { display: grid; grid-template-columns: 1fr; gap: 15px; padding-top: 15px; }
        @media (min-width: 680px) { #item-tiles-container { grid-template-columns: 1fr 1fr; } }
        .item-tile { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .item-tile-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .item-tile .item-name { font-weight: 600; font-size: 1rem; word-break: break-word; }
        .item-tile .item-info-tags { font-size: 0.8rem; font-weight: 500; color: #6c757d; white-space: nowrap; }
        .item-tile .item-controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; align-items: flex-start; }
        .item-tile .control-cell { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .item-tile .price-box { width: 100%; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border-color); border-radius: 6px; background-color: #f8f9fa; cursor: pointer; transition: all 0.2s ease; }
        .item-tile .price-box.active { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .item-tile .control-label { font-size: 0.75rem; color: #555; font-weight: 500; }
        .item-tile .control-input { width: 100%; height: 40px; padding: 6px; text-align: center; font-size: 1rem; margin-bottom: 0; border-radius: 6px; -moz-appearance: textfield; }
        .item-tile .control-input::-webkit-outer-spin-button,
        .item-tile .control-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .item-tile .add-to-cart-btn { width: 100%; height: 40px; padding: 0; font-size: 0.9rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        .item-tile .add-to-cart-btn.added { background-color: var(--success-color); }

        #order-summary-list .order-item-card { display: flex; flex-direction: column; gap: 10px; align-items: stretch; padding: 12px 15px; margin-bottom: 12px; }
        #order-summary-list .item-primary-row { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        #order-summary-list .item-name-group { display: flex; align-items: flex-start; gap: 10px; flex-grow: 1; min-width: 0; }
        #order-summary-list .item-serial-no { font-weight: 600; color: var(--secondary-color); font-size: 1.05rem; padding-top: 2px; }
        #order-summary-list .item-name { font-weight: 600; font-size: 1.05rem; color: var(--text-color); word-break: break-word; }
        #order-summary-list .item-actions { flex-shrink: 0; margin-left: 10px; }
        #order-summary-list .item-action-btn { background: none; border: none; cursor: pointer; padding: 0; }
        #order-summary-list .item-action-btn svg { width: 22px; height: 22px; stroke-width: 2.5; }
        #order-summary-list .delete-btn svg { stroke: var(--danger-color); }
        #order-summary-list .item-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        #order-summary-list .detail-item { text-align: center; }
        #order-summary-list .detail-item .label { font-size: 0.8rem; color: #6c757d; margin-bottom: 2px; }
        #order-summary-list .detail-item .value { font-weight: 500; font-size: 0.95rem; }
        #order-summary-list .detail-item.total .value { font-weight: 700; color: var(--primary-color); }
        
        #order-summary-grand-total { margin-top: 20px; padding: 15px; background-color: var(--primary-color); color: white; font-size: 1.2rem; font-weight: bold; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; }
        .total-margin-badge { font-size: 1rem; font-weight: 700; color: #fff; padding: 4px 10px; border-radius: 50px; }
        
        #order-summary-actions { padding: 15px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }

        .search-toggle-buttons { display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 10px; font-size: 0.9rem; font-weight: 500; text-align: center; color: var(--primary-color); background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .toggle-btn.active { background-color: var(--secondary-color); color: #fff; border-color: var(--secondary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-view { display: none; }
        .search-view.active { display: block; }

        #offer-item-search-results, #offer-item-search-results-bulk, #info-salesman-item-search-results, #info-item-search-results, #packing-item-search-results, #billing-item-search-results, #assistant-packing-item-search-results, #purchase-item-search-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 var(--border-radius) var(--border-radius); max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        #item-finder-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

/*
  Final Fix for Cart Icon Color:
  Using maximum specificity to override any conflicting styles.
*/
body #page-order.page.active .header #cart-icon-btn svg {
    stroke: var(--success-color) !important;
}

#item-finder-search-results .search-result-item {
    padding: 15px;
    cursor: pointer;
    font-weight: 500;
    border-bottom: 1px solid #f0f0f0;
}

#item-finder-search-results .search-result-item:last-child {
    border-bottom: none;
}

#item-finder-search-results .search-result-item:hover {
    background-color: var(--light-bg);
}

#item-finder-display-card .price-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

#item-finder-display-card h3 {
    text-align: center;
    font-size: 1.3rem;
    color: var(--primary-color);
    word-break: break-word;
}

#item-finder-display-card .price-item {
    text-align: center;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

#item-finder-display-card .price-item .label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #6c757d;
}

#item-finder-display-card .price-item .value {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-top: 5px;
    word-wrap: break-word;
}
        .search-result-item { padding: 12px 15px; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; border-bottom: 1px solid #f0f0f0; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: var(--light-bg); }
        .search-result-item .item-name { font-weight: 500; width: 100%; white-space: normal; margin-bottom: 8px; font-size: 1rem; }
        .search-result-item .item-details-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; text-align: center; }
        .search-result-item .detail-cell .label { display: block; font-size: 0.7rem; color: #6c757d; text-transform: uppercase; margin-bottom: 2px; }
        .search-result-item .detail-cell .value { font-size: 0.85rem; font-weight: 600; }
        .search-result-item .item-p2 { color: var(--primary-color); }
        .search-result-item .item-margin.profit { color: var(--success-color); }
        .search-result-item .item-margin.loss { color: var(--danger-color); }
        
        #packing-slip-wrapper, #payment-receipt-wrapper, #payment-summary-print-wrapper, #sale-bill-wrapper, #loading-slip-wrapper, #purchase-planner-print-wrapper { display: none; }
        #collection-report-wrapper { position: absolute; left: -9999px; top: -9999px; }
        #collection-report { background: #fff; padding: 40px; }
        
        #packing-slip-content, #sale-bill-content { font-family: 'Segoe UI', sans-serif; color: #222; padding: 0; font-size: 14px; }
        .slip-page-number { text-align: right; font-size: 0.8rem; color: #555; }
        .slip-header, .bill-header { text-align: center; margin-bottom: 10px; }
        .slip-header h2, .bill-header h2 { margin: 0; font-size: 1.8rem; color: #000; font-weight: 700; }
        .slip-header p, .bill-header p { font-size: 0.8rem; color: #555; margin: 2px 0 0; }
        .slip-details, .bill-details { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #333; font-size: 0.85rem; }
        .slip-details div, .bill-details div { line-height: 1.4; }
        .slip-details div strong, .bill-details div strong { font-weight: 600; }
        .slip-table, .bill-table { width: 100%; border-collapse: collapse; }
        .slip-table th, .slip-table td, .bill-table th, .bill-table td { padding: 5px 8px; text-align: left; border-bottom: 1px solid #333; }
        .slip-table th, .bill-table th { background-color: #f2f2f2; font-weight: 600; font-size: 0.8rem; }
        .slip-table td, .bill-table td { font-size: 0.85rem; vertical-align: top; }
        .slip-table .col-item-name, .bill-table .col-item-name { width: 45%; white-space: normal; }
        .slip-table .col-qty, .slip-table .col-price, .bill-table .col-qty, .bill-table .col-price, .bill-table .col-total { text-align: right; white-space: nowrap; }
        .slip-table .col-mrp, .bill-table .col-mrp { white-space: nowrap; }
        .slip-table .price-type { font-size: 0.7em; color: #444; margin-left: 2px; }
        .slip-footer, .bill-footer { margin-top: 15px; padding-top: 10px; border-top: 2px solid #333; text-align: right; font-size: 1rem; }
        .slip-footer .sorted-by { display: inline-block; text-align: left; }
        .slip-footer .signature-line { display: block; border-bottom: 1px solid #333; width: 180px; margin-top: 25px; }
        .bill-footer div { margin-bottom: 5px; }

        .receipt-container { font-family: Calibri, sans-serif; color: black; padding: 20px; width: 100%;}
        .receipt-header { text-align: center; margin-bottom: 25px; }
        .receipt-header h2 { font-size: 2rem; font-weight: bold; margin: 0; }
        .receipt-header p { margin: 5px 0 0; font-size: 1rem; }
        .receipt-details { margin-bottom: 20px; line-height: 1.6; font-size: 1.1rem; border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 15px 0; }
        .receipt-details p { display: flex; justify-content: space-between; margin: 8px 0; }
        .receipt-details strong { font-weight: normal; margin-right: 15px; white-space: nowrap; }
        .receipt-details span { font-weight: bold; text-align: right; }
        .receipt-details span#receipt-customer { white-space: normal; word-break: break-word; flex-shrink: 1; }
        .receipt-amount { text-align: center; margin: 30px 0; }
        .receipt-amount .amount-label { font-size: 1.1rem; color: #555; }
        .receipt-amount .amount-value { font-size: 2.5rem; font-weight: bold; color: black; }
        .receipt-footer { text-align: center; margin-top: 30px; font-size: 0.9rem; color: #777; border-top: 1px dashed #ccc; padding-top: 15px;}
        
        .dashboard-grid { display: grid; gap: 15px; grid-template-columns: 1fr; }
        .kpi-card-small { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 15px; text-align: center; }
        .kpi-card-small .value { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); line-height: 1.2; overflow-wrap: break-word; }
        .kpi-card-small .label { font-size: 0.85rem; color: #6c757d; margin-top: 5px; }
        .data-list-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 20px; display: flex; flex-direction: column; }
        .data-list-card h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .data-list-container, .payment-summary-list, .live-activity-list { list-style: none; padding: 0; margin: 0; }
        .data-list-container, .live-activity-list { max-height: 300px; overflow-y: auto; }
        .data-list-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 12px 5px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
        .data-list-item:hover { background-color: var(--light-bg); }
        .data-list-item:last-child { border-bottom: none; }
        .data-list-item .item-main {
            font-weight: 600;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .data-list-item .item-details { text-align: right; }
        .item-details .value-primary { font-weight: 600; color: var(--text-color); display: block; font-size: 1rem; }
        .item-details .value-secondary { font-size: 0.8rem; color: #6c757d; }
        .item-details .value-secondary .profit, .item-details .value-secondary .loss { color: var(--success-color); font-weight: 500; }
        .item-details .value-secondary .loss { color: var(--danger-color); }
        .profit { color: var(--success-color); }
        .loss { color: var(--danger-color); }
        #page-salesman-report .content, #page-customer-report .content, #page-customer-ledger .content { padding-top: 10px; }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th, .report-table td { padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .report-table th { font-weight: 600; background-color: #f8f9fa; }
        .report-table td.numeric, .report-table th.numeric { text-align: right; }
        .report-header-card { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; padding: 0; background-color: transparent; border-radius: 0; margin-bottom: 20px; box-shadow: none; }
        .report-header-card > div { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 15px; text-align: center; }
        .report-header-card > div > .label { font-size: 0.8rem; color: #6c757d; }
        .report-header-card > div > .value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .payment-summary-list li { display: flex; justify-content: space-between; padding: 10px 5px; font-size: 1rem; border-bottom: 1px solid #f0f0f0; }
        .payment-summary-list li:last-child { border-bottom: none; }
        .payment-summary-list li strong { color: var(--primary-color); }
        .payment-summary-list .salesman-header { font-weight: 600; color: var(--secondary-color); margin-top: 15px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        .payment-summary-list .salesman-breakdown li { padding-left: 20px; font-size: 0.9rem; }
        .payment-summary-list .salesman-breakdown li:last-child { font-weight: bold; }

        #page-admin-dashboard .between-date-filter,
        #page-admin-dashboard .dashboard-grid,
        #admin-operations-view .between-date-filter,
        #admin-operations-view .operations-content {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        #admin-operations-view .operations-content {
            display: flex;
            flex-direction: column;
            gap: 20px; /* Uniform spacing */
        }

        #crm-filters { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        #crm-filters select { margin-bottom: 0; }
        #crm-customer-count { text-align: center; font-weight: 500; color: var(--primary-color); margin-bottom: 20px; }
        #crm-flyer-preview-container { text-align: center; min-height: 150px; display:flex; align-items:center; justify-content:center; border: 1px solid #eee; border-radius: 8px; margin-top: 15px; background-color: #f8f9fa; }
        #crm-flyer-preview-container img { max-width: 100%; border-radius: var(--border-radius); }
        
        #offer-builder-item-list, #crm-flyer-item-list { max-height: 250px; overflow-y: auto; margin-bottom: 20px; }
        .offer-builder-item { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .offer-builder-item .item-info .item-name { font-weight: 500; }
        .offer-builder-item .item-info .item-price { font-size: 0.9rem; color: #666; }
        .offer-builder-item .item-action-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .offer-builder-item .item-action-btn svg { width: 20px; height: 20px; }
        .offer-builder-item .delete-btn svg { stroke: var(--danger-color); }
        .offer-builder-item .edit-btn svg { stroke: var(--secondary-color); }

        #flyer-template-wrapper { position: absolute; left: -9999px; top: -9999px; width: 500px; }
        #flyer-content { font-family: 'Segoe UI', Roboto, sans-serif; color: #fff; padding: 30px; background-color: #65A30D; background-image: radial-gradient(circle at 10% 10%, #84CC16 0%, transparent 50%), linear-gradient(145deg, #84CC16 0%, #65A30D 100%); position: relative; overflow: hidden; }
        #flyer-content::before { content: ''; position: absolute; top: -50px; left: -50px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.05); border-radius: 50%; }
        #flyer-header { text-align: center; margin-bottom: 25px; }
        #flyer-logo { font-size: 2.8rem; font-weight: 800; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        #flyer-tagline { font-size: 1rem; opacity: 0.9; }
        #flyer-offer-details { margin-bottom: 25px; }
        #flyer-headline { font-size: 2.2rem; font-weight: 800; text-align: center; color: #fff; margin-bottom: 25px; line-height: 1.3; text-shadow: 2px 2px 5px rgba(0,0,0,0.25); }
        #flyer-headline .customer-name-highlight { color: #FEFE00; }
        #flyer-item-list { list-style: none; padding: 0; margin: 0; }
        .flyer-item { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .flyer-item-name { font-size: 1.1rem; font-weight: 600; max-width: 70%; color: #27272A; }
        .flyer-item-price { font-size: 1.2rem; font-weight: 700; color: #27272A; background-color: #FEFE00; padding: 5px 12px; border-radius: 50px; }
        #flyer-footer { margin-top: 30px; text-align: center; font-size: 0.9rem; opacity: 0.8; }
        #offer-flyer-preview-container img { max-width: 100%; border-radius: 8px; }
        
        .table-responsive-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-responsive-wrapper .report-table { min-width: 600px; }
        .table-responsive-wrapper .report-table td, 
        .table-responsive-wrapper .report-table th { white-space: nowrap; }
        .report-table .customer-info small { color: #6c757d; font-size: 0.8rem; }
        
        .summary-totals-card { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .summary-totals-card .kpi-card-small { margin-bottom: 0; }
        .summary-totals-card .grand-total { grid-column: 1 / -1; }
        
        .summary-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .summary-table th, .summary-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .summary-table th { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: #888; background-color: #f8f9fa; }
        .summary-table td { font-size: 0.9rem; }
        .summary-table .col-customer { width: 50%; word-break: break-word; font-weight: 500; }
        .summary-table .col-mode { width: 25%; }
        .summary-table .col-amount { width: 25%; text-align: right; font-weight: 600; color: var(--primary-color); }
        .summary-table th.col-amount { text-align: right; }

        .leaflet-container { height: 100%; width: 100%; }
        
        #location-summary-list .list-item { flex-direction: column; align-items: flex-start; gap: 8px; }
        #location-summary-list .list-item p { margin: 0; font-size: 0.95rem; color: #333; }
        #location-summary-list .list-item .button-outline { width: auto; padding: 5px 15px; font-size: 0.9rem; margin-top: 5px; }
        #location-details-list .list-item-action { background-color: transparent; border: 1px solid var(--secondary-color); color: var(--secondary-color); }

        #professional-modal .modal-content { text-align: center; }
        #professional-modal-message { font-size: 1.1rem; color: #555; margin: 20px 0; line-height: 1.5; }
        #professional-modal .modal-footer { justify-content: center; }

        #payment-summary-print-content { display: none; font-family: 'Segoe UI', 'Helvetica Neue', sans-serif; color: #000; }
        .print-header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .print-header h2 { margin: 0; font-size: 24pt; }
        .print-header p { margin: 5px 0 0; font-size: 11pt; color: #555; }
        .print-details { display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 11pt; }
        .print-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        .print-table th, .print-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ccc; }
        .print-table th { background-color: #f2f2f2; font-weight: 600; }
        .print-table td.numeric, .print-table th.numeric { text-align: right; }
        .print-totals-footer { margin-top: 25px; padding-top: 15px; border-top: 2px solid #333; float: right; width: 40%; min-width: 250px; }
        .print-totals-footer div { display: flex; justify-content: space-between; font-size: 12pt; margin-bottom: 8px; }
        .print-totals-footer div.grand-total { font-weight: 700; font-size: 14pt; border-top: 1px solid #333; padding-top: 8px; }

        #product-info-display-card { margin-top: 20px; }
        #product-info-display-card h3 { font-size: 1.3rem; word-break: break-word; }
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin-top: 15px; }
        .price-item { text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .price-item .label { font-size: 0.9rem; font-weight: 500; color: #6c757d; }
        .price-item .value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .stock-info { text-align: center; margin-top: 20px; font-weight: 500; }

        #edit-slip-item-list .order-item-card { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; background: #fff; border-radius: var(--border-radius); padding: 15px; box-shadow: var(--card-shadow); }
        #edit-slip-item-list .item-primary-row { display: flex; justify-content: space-between; align-items: center; }
        #edit-slip-item-list .item-name { font-weight: 600; flex-grow: 1; margin-right: 10px; }
        #edit-slip-item-list .delete-btn svg { stroke: var(--danger-color); }
        #edit-slip-item-list .item-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; padding-top: 10px; margin-top: 10px; border-top: 1px solid #f0f0f0; }
        #edit-slip-item-list .form-group { margin-bottom: 0; }
        #edit-slip-item-list .form-group label { font-size: 0.8rem; color: #555; font-weight: 500; margin-bottom: 4px; }
        #edit-slip-item-list input { margin-bottom: 0; padding: 10px; }
        
        #outstanding-list-container .list-item { display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center; padding: 12px 15px; }
        #outstanding-list-container .outstanding-balance { font-size: 1rem; font-weight: 600; padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); text-align: right; background-color: #f8f9fa; -moz-appearance: textfield; max-width: 120px; }
        #outstanding-list-container .outstanding-balance::-webkit-outer-spin-button,
        #outstanding-list-container .outstanding-balance::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #outstanding-list-container .outstanding-balance:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 2px rgba(10, 147, 150, 0.2); }
        #outstanding-list-container .reminder-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        #outstanding-list-container .reminder-btn svg { width: 28px; height: 28px; stroke: var(--secondary-color); stroke-width: 2; }
        
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .toast-notification.show {
            opacity: 1;
            bottom: 30px;
        }

        :root {
            --light-bg: #f0f8ff; 
            --text-color-light: #576c7f;
            --border-radius-lg: 24px;
            --border-radius-md: 16px;
            
            --sales-accent: #ffb703;
            --sales-accent-light: #fffbeb;
            --admin-accent: #8e44ad;
            --admin-accent-light: #f3e5f5;
            --packing-accent: #27ae60;
            --packing-accent-light: #e8f5e9;
            --loading-accent: #2980b9;
            --loading-accent-light: #eaf2f8;
            --delivery-accent: #e67e22;
            --delivery-accent-light: #fdf3e6;
            --billing-accent: #7f8c8d;
            --billing-accent-light: #f2f4f4;
            --accounts-accent: #2c3e50;
            --accounts-accent-light: #e5e7e9;
            --purchase-accent: #34495e;
            --purchase-accent-light: #ebedef;
            --hr-accent: #c0392b;
            --hr-accent-light: #f9ebea;

        }

        @keyframes float {
            0% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(-20px) translateX(10px); }
            100% { transform: translateY(0px) translateX(0px); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #page-login {
            background: linear-gradient(135deg, #e0f7fa 0%, #f0f8ff 100%);
        }

        .login-page-container {
            position: relative;
            display: grid;
            grid-template-rows: 1fr auto 1fr; 
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            z-index: 1;
        }
        
        .login-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            animation: fadeIn 0.8s ease-out;
            grid-row: 2; 
        }
        
        .login-header {
            text-align: center;
            grid-row: 1; 
            align-self: end; 
            animation: fadeIn 0.8s ease-out;
            margin-bottom: 80px;
        }
        .login-header h1 {
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin: 0;
        }
        .login-header p {
            margin-top: 12px;
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: var(--text-color-light);
            font-weight: 500;
            letter-spacing: 0.5px;
        }
       
        .select-role-button {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 150px;
            height: 150px;
            background: linear-gradient(145deg, #ffffff, #e6f7fa);
            border: 1px solid rgba(0, 95, 115, 0.1);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            gap: 12px;
        }

        .select-role-button:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 95, 115, 0.2);
        }

        .select-role-button:active {
            transform: translateY(-2px) scale(0.97);
        }

        .select-role-button svg {
            width: 48px;
            height: 48px;
            stroke: var(--primary-color);
            stroke-width: 1.5;
        }

        .select-role-button span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .role-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 31, 38, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        .role-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .role-modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 420px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .role-modal.active .role-modal-content {
            transform: scale(1);
        }

        .role-modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.4rem;
            color: var(--primary-color);
            text-align: center;
        }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .role-tile {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            color: var(--text-color);
            gap: 5px;
            padding: 5px;
            box-sizing: border-box;
        }
        
        .role-tile.dummy {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .role-tile:not(.dummy):active {
            transform: scale(0.95);
        }
        
        .role-tile svg {
            width: 32px;
            height: 32px;
            stroke-width: 1.5;
            color: var(--primary-color);
            transition: all 0.2s ease;
        }
        
        .role-tile:hover:not(.dummy) svg {
            transform: scale(1.1);
        }
        
        .role-tile span {
            font-weight: 500;
            font-size: 0.8rem;
            text-align: center;
        }

        .role-tile[data-role="UNNI"], .role-tile[data-role="RIYAS"] { border-color: var(--sales-accent); }
        .role-tile[data-role="SUNNY"], .role-tile[data-role="ANISHAD"], .role-tile[data-role="MUFEEDA"] { border-color: var(--packing-accent); }
        .role-tile[data-role="ADMIN"] { border-color: var(--admin-accent); }
        .role-tile[data-role="SHAJU"] { border-color: var(--loading-accent); }
        .role-tile[data-role="BENNY"] { border-color: var(--delivery-accent); }
        .role-tile[data-role="ARFATH"] { border-color: var(--billing-accent); }
        .role-tile[data-role="NANDU"] { border-color: var(--accounts-accent); }
        .role-tile[data-role="FASAL"] { border-color: var(--purchase-accent); }
        .role-tile[data-role="HR"] { border-color: var(--hr-accent); }
        
        .role-tile[data-role="UNNI"]:hover,
        .role-tile[data-role="RIYAS"]:hover {
            background-color: var(--sales-accent-light);
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(255, 183, 3, 0.2);
        }
        .role-tile[data-role="UNNI"]:hover svg,
        .role-tile[data-role="RIYAS"]:hover svg {
            color: #c28802;
        }
        
        .role-tile[data-role="SUNNY"]:hover,
        .role-tile[data-role="ANISHAD"]:hover,
        .role-tile[data-role="MUFEEDA"]:hover {
            background-color: var(--packing-accent-light);
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2);
             transform: translateY(-4px);
        }
        .role-tile[data-role="SUNNY"]:hover svg,
        .role-tile[data-role="ANISHAD"]:hover svg,
        .role-tile[data-role="MUFEEDA"]:hover svg {
            color: #1e8449;
        }

        .role-tile[data-role="ADMIN"]:hover {
            background-color: var(--admin-accent-light);
            box-shadow: 0 4px 10px rgba(142, 68, 173, 0.2);
             transform: translateY(-4px);
        }
        .role-tile[data-role="ADMIN"]:hover svg {
            color: #6c3483;
        }

        .role-tile[data-role="SHAJU"]:hover {
            background-color: var(--loading-accent-light);
            box-shadow: 0 4px 10px rgba(41, 128, 185, 0.2);
            transform: translateY(-4px);
        }
        .role-tile[data-role="SHAJU"]:hover svg { color: #21618c; }

        .role-tile[data-role="BENNY"]:hover {
            background-color: var(--delivery-accent-light);
            box-shadow: 0 4px 10px rgba(230, 126, 34, 0.2);
            transform: translateY(-4px);
        }
        .role-tile[data-role="BENNY"]:hover svg { color: #b9671b; }

        .role-tile[data-role="ARFATH"]:hover {
            background-color: var(--billing-accent-light);
            box-shadow: 0 4px 10px rgba(127, 140, 141, 0.2);
            transform: translateY(-4px);
        }
        .role-tile[data-role="ARFATH"]:hover svg { color: #626567; }

        .role-tile[data-role="NANDU"]:hover {
            background-color: var(--accounts-accent-light);
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2);
        }
        .role-tile[data-role="NANDU"]:hover svg { color: #1c2833; }
        
        .role-tile[data-role="FASAL"]:hover {
            background-color: var(--purchase-accent-light);
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(52, 73, 94, 0.2);
        }
        .role-tile[data-role="FASAL"]:hover svg { color: #212f3d; }

        .role-tile[data-role="HR"]:hover {
            background-color: var(--hr-accent-light);
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(192, 57, 43, 0.2);
        }
        .role-tile[data-role="HR"]:hover svg { color: #943126; }

        .workflow-container {
            grid-row: 3;
            align-self: center;
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.8s ease-out 0.2s;
            animation-fill-mode: backwards;
        }
        
        .workflow-container svg {
            width: 32px;
            height: 32px;
            stroke-width: 1.5;
            opacity: 0.7;
        }
        #icon-sales { color: var(--sales-accent); }
        #icon-billing { color: var(--billing-accent); }
        #icon-packing { color: var(--packing-accent); }
        #icon-delivery { color: var(--delivery-accent); }
        #icon-accounts { color: var(--accounts-accent); }

        #billing-item-list .list-item,
        #packing-item-list .list-item,
        #assistant-packing-item-list .list-item,
        #loader-order-list .list-item {
            gap: 15px;
            align-items: center;
        }
        #billing-item-list .list-item input[type="checkbox"],
        #packing-item-list .list-item input[type="checkbox"],
        #assistant-packing-item-list .list-item input[type="checkbox"],
        #loader-order-list .list-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        #billing-item-list .list-item .info,
        #packing-item-list .list-item .info,
        #assistant-packing-item-list .list-item .info,
        #loader-order-list .list-item .info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-grow: 1;
            margin: 0;
        }
        .packing-item-name, .billing-item-name, .assistant-packing-item-name, .loader-item-name {
            font-weight: 600;
            font-size: 1rem;
        }
        .packing-item-details, .billing-item-details, .assistant-packing-item-details, .loader-item-details {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }
        .page-actions {
             padding: 15px; flex-shrink: 0;
        }

        .ledger-table { table-layout: fixed; width: 100%; }
        .ledger-table th, .ledger-table td { padding: 10px 5px; font-size: 0.85rem; }
        .ledger-table th:nth-child(1), .ledger-table td:nth-child(1) { width: 22%; } /* Date */
        .ledger-table th:nth-child(2), .ledger-table td:nth-child(2) { width: 33%; white-space: normal; } /* Particulars */
        .ledger-table th:nth-child(3), .ledger-table td:nth-child(3) { width: 22%; } /* Debit */
        .ledger-table th:nth-child(4), .ledger-table td:nth-child(4) { width: 23%; } /* Credit */
        .ledger-sale-row { cursor: pointer; }
        .ledger-sale-row:hover { background-color: var(--light-bg); }
        .ledger-details-row { display: none; }
        .ledger-details-row.visible { display: table-row; }
        .ledger-details-cell { padding: 10px 15px !important; background-color: #f8f9fa; }
        .ledger-item-list { list-style: none; padding: 0 0 10px 0; margin: 0; font-size: 0.8rem; }
        .ledger-item-list li { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; }
        .ledger-item-list li:last-child { border-bottom: none; }
        .ledger-item-name { max-width: 70%; }
        .ledger-item-qty { font-weight: 500; }
        .ledger-details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .ledger-details-header h4 { margin: 0; font-size: 1rem; color: var(--primary-color); }
        #accountant-salesman-toggle { display: flex; gap: 10px; margin-bottom: 20px; }

        #loading-slip-content { font-family: 'Segoe UI', sans-serif; color: #222; padding: 0; font-size: 14px; }
        .loading-slip-header { text-align: center; margin-bottom: 20px; }
        .loading-slip-header h2 { margin: 0; font-size: 1.6rem; }
        .loading-slip-details { margin-bottom: 20px; font-size: 1rem; }
        .loading-slip-details p { margin: 5px 0; }
        .loading-slip-table { width: 100%; border-collapse: collapse; }
        .loading-slip-table th, .loading-slip-table td { padding: 8px; text-align: left; border-bottom: 1px solid #333; font-size: 1rem; }
        .loading-slip-table th { font-weight: 600; }
        .loading-slip-table .col-qty { text-align: right; }

        .operations-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .user-status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .user-status-card { background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 15px; }
        .user-status-card h4 { margin: 0 0 12px 0; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; cursor: pointer; transition: color 0.2s; }
        .user-status-card h4:hover { color: var(--secondary-color); }
        .user-status-card p { font-size: 0.9rem; margin: 0 0 8px; color: #555; word-break: break-word; }
        .user-status-card p strong { font-weight: 600; color: #333; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; color: #fff; }
        .status-badge.idle { background-color: #7f8c8d; }
        .status-badge.active { background-color: var(--success-color); }
        
        .timeline-order-card { background: #fff; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 15px; margin-bottom: 15px; }
        .timeline-order-card h4 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--primary-color); }
        .timeline-order-card .detail-row { display: flex; justify-content: space-between; font-size: 0.9rem; padding: 5px 0; }
        .timeline-order-card .detail-row .label { font-weight: 500; color: #555; }
        .timeline-order-card .detail-row .value { font-weight: 600; }
        .timeline-order-card .total-duration { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-weight: bold; }
        
        @media (max-width: 767px) {
            #page-admin-dashboard .content { padding: 10px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .summary-totals-card { grid-template-columns: 1fr; }
            #page-outstanding-balances .filter-bar { flex-direction: column; align-items: stretch; }
        }
        @media (min-width: 768px) {
            .report-header-card > div > .label { font-size: 0.9rem; }
            .report-header-card > div > .value { font-size: 1.5rem; }
        }

        @media print {
            @page { size: A4; margin: 20mm; }
            body, html { background: #fff !important; height: auto !important; overflow: visible !important; }
            body > * { display: none !important; }
            body.printing-packing-slip #packing-slip-wrapper,
            body.printing-receipt #payment-receipt-wrapper,
            body.printing-summary #payment-summary-print-wrapper,
            body.printing-loading-slip #loading-slip-wrapper,
            body.printing-sale-bill #sale-bill-wrapper,
            body.printing-purchase-planner #purchase-planner-print-wrapper { display: block !important; position: static !important; }
            #payment-summary-print-content { display: block !important; }
            .slip-page-break, .bill-page-break { page-break-before: always; }
            .slip-table thead, .bill-table thead { display: table-header-group; }
            .slip-table tr, .bill-table tr { page-break-inside: avoid; }
        }
        #admin-operations-content .report-table {
            font-size: 0.8rem;
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
        }

        #admin-operations-content .report-table th,
        #admin-operations-content .report-table td {
            padding: 10px 6px;
            text-align: right;
            white-space: nowrap;
            vertical-align: top;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid #f0f0f0;
        }

        #admin-operations-content .report-table th:last-child,
        #admin-operations-content .report-table td:last-child {
            border-right: none;
        }

        #admin-operations-content .report-table th:first-child,
        #admin-operations-content .report-table td:first-child {
            text-align: left;
            width: 35%;
            white-space: normal;
            word-break: break-word;
        }

        #admin-operations-content .report-table .customer-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
        }

        #admin-operations-content .report-table th:not(:first-child),
        #admin-operations-content .report-table td:not(:first-child) {
            width: 16.25%;
        }

        #admin-operations-content .report-table .customer-info small {
            font-size: 0.75rem;
        }

        #transfer-modal .modal-content {
            text-align: center;
        }
        #transfer-assistant-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .fab-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
        }
        .fab-button svg { width: 28px; height: 28px; }
        
        .purchase-view { display: none; }
        .purchase-view.active { display: block; }

        .tile-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .purchase-tile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 18px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: left;
        }
        .purchase-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 95, 115, 0.12);
        }
        .purchase-tile h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        .purchase-tile p {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-color);
        }
        .purchase-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 95, 115, 0.15);
        }
        .purchase-tile h4 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin: 0;
            word-break: break-word;
        }
        .purchase-tile p {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        /* --- Add these new styles for the Purchase Planner --- */

.purchase-tile {
    /* This rule is updated */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.purchase-tile-info {
    /* This is a new rule */
    flex-grow: 1;
    cursor: pointer;
}

.purchase-tile-manage-btn {
    /* This is a new rule */
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    color: var(--text-color-light);
    background-color: transparent;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
}

.purchase-tile-manage-btn:hover {
    /* This is a new rule */
    background-color: var(--light-bg);
    color: var(--primary-color);
}

.vendor-manage-options {
    /* This is a new rule */
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.button.button-danger {
    /* This is a new rule */
    background: white;
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
    box-shadow: none;
}

.button.button-danger:active {
    /* This is a new rule */
    background-color: #fff1f2;
}
        #purchase-planner-print-content .print-header {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        #purchase-planner-print-content .print-table {
            font-size: 9pt;
        }
        #purchase-planner-print-content .print-table th, #purchase-planner-print-content .print-table td {
            padding: 8px;
        }
        #purchase-planner-print-content .blank-col {
            border: 1px solid #ccc !important;
            width: 100px;
        }
        .purchase-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .purchase-detail-table th, .purchase-detail-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .purchase-detail-table th {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #888;
            background-color: #f8f9fa;
        }
        .purchase-detail-table td {
            font-size: 0.95rem;
        }
        .purchase-detail-table .col-item-name {
            font-weight: 500;
            color: var(--text-color);
            width: 60%;
        }
        .purchase-detail-table .col-stock, .purchase-detail-table .col-suggest {
            text-align: right;
            font-weight: 600;
            width: 20%;
        }
        .purchase-detail-table .col-suggest {
            color: var(--primary-color);
        }
        /* --- Add these new styles for the Vendor Items Page --- */

#vendor-current-items-list .list-item .info {
    flex-grow: 1; /* Allow the name to take up space */
}

#vendor-current-items-list .delete-vendor-item-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    flex-shrink: 0;
}

#vendor-current-items-list .delete-vendor-item-btn svg {
    width: 24px;
    height: 24px;
    stroke: var(--danger-color);
    stroke-width: 2.5;
}

        /* --- HR Dashboard Styles --- */
        #hr-user-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(2, 1fr); /* 2 columns on mobile */
        }

        .hr-user-tile {
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative; /* Needed for positioning the status dot */
        }
        .hr-user-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 95, 115, 0.15);
        }
        .hr-user-tile svg {
            width: 36px;
            height: 36px;
            stroke-width: 1.5;
            color: var(--primary-color);
        }
        .hr-user-tile span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        /* Special style for Admin tile in HR dashboard */
        .hr-user-tile.admin-tile {
            background-color: var(--admin-accent-light);
            border: 1px solid var(--admin-accent);
        }
        .hr-user-tile.admin-tile svg {
            color: var(--admin-accent);
        }

        /* Responsive grid for desktop */
        @media (min-width: 768px) {
            #hr-user-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 columns on desktop */
            }
        }
        
        .hr-user-tile .status-dot {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            background-color: var(--success-color);
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            display: none; /* Hidden by default */
        }

        .hr-user-tile[data-status="clock_in"] .status-dot {
            display: block; /* Show dot if user is clocked IN */
        }
        
        .hr-user-tile .calendar-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .hr-user-tile .calendar-btn svg {
            width: 20px;
            height: 20px;
            color: var(--text-color-light);
        }
        .hr-user-tile .calendar-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }

        /* --- Attendance Modal Button Styles --- */
        #attendance-modal .modal-body .button {
            flex: 1;
            margin: 0;
        }
        
        /* --- Attendance Calendar Modal Styles --- */
        #calendar-grid .day-name { 
            font-weight: 600; 
            font-size: 0.8rem; 
            color: var(--text-color-light);
            padding-bottom: 5px;
        }
        #calendar-grid .day-cell { 
            aspect-ratio: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-size: 0.9rem;
        }
        #calendar-grid .day-cell.other-month { color: #ccc; }
        #calendar-grid .day-cell.present { background-color: var(--success-color); color: white; font-weight: bold; }
        #calendar-grid .day-cell.half-day { background-color: var(--warning-color); color: white; font-weight: bold; }
        #calendar-grid .day-cell.absent { background-color: var(--danger-color); color: white; font-weight: bold; }
        #calendar-grid .day-cell.today { border: 2px solid var(--primary-color); }

        /* --- HR Report Table Styles --- */
        #hr-report-container .report-table .duration-col {
            font-weight: bold;
            color: var(--primary-color);
        }
        #hr-report-container .report-table .col-hours {
            font-weight: 600;
        }
    </style>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-page-container">
            <header class="login-header">
                <h1>MF SALES & OPERATION</h1>
                <p>Wholesale. Simplified.</p>
            </header>
            <div class="login-box">
                <button class="select-role-button" id="open-role-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
                    <span>Select Role</span>
                </button>
            </div>
            <div class="workflow-container">
                <svg id="icon-sales" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <svg id="icon-billing" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                <svg id="icon-packing" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                <svg id="icon-delivery" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                <svg id="icon-accounts" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            </div>
        </div>
    
        <div class="role-modal" id="role-modal">
            <div class="role-modal-content">
                <h2>Select Your Role</h2>
                <div class="role-grid">
                    <button class="role-tile" data-role="UNNI">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>UNNI</span>
                    </button>
                    <button class="role-tile" data-role="RIYAS">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>RIYAS</span>
                    </button>
                    <button class="role-tile" data-role="SUNNY">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        <span>SUNNY</span>
                    </button>
                    <button class="role-tile" data-role="ADMIN">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                        <span>ADMIN</span>
                    </button>
                    <button class="role-tile" data-role="SHAJU">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <span>SHAJU</span>
                    </button>
                    <button class="role-tile" data-role="BENNY">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                        <span>BENNY</span>
                    </button>
                     <button class="role-tile" data-role="ARFATH">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                        <span>ARFATH</span>
                    </button>
                     <button class="role-tile" data-role="NANDU">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        <span>NANDU</span>
                    </button>
                    <button class="role-tile" data-role="ANISHAD">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>ANISHAD</span>
                    </button>
                    <button class="role-tile" data-role="MUFEEDA">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>MUFEEDA</span>
                    </button>
                    <button class="role-tile" data-role="FASAL">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <span>FASAL</span>
                    </button>
                    <button class="role-tile" data-role="HR">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
                        <span>HR</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-main-view" class="page">
        <div class="header">
            <button class="icon-button" id="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1 id="main-view-header">Customers</h1>
            <div class="header-actions">
                <button class="icon-button" id="product-info-icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                </button>
                 <button class="icon-button" id="pending-balance-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </button>
                <button class="icon-button" id="billed-orders-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </button>
                <button class="icon-button" id="history-icon-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                </button>
                <button class="icon-button" id="settings-icon-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="customer-view">
                <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="customer-search-input" placeholder="Search customers...">
                    </div>
                    <div class="form-group">
                        <select id="customer-route-filter">
                            <option value="ALL">All Routes</option>
                        </select>
                    </div>
                </div>
                <div id="customer-list-container"></div>
            </div>
            <div id="payment-view" style="display:none;">
                 <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="payment-customer-search-input" placeholder="Search customers...">
                    </div>
                     <div class="form-group">
                        <select id="payment-route-filter">
                            <option value="ALL">All Routes</option>
                        </select>
                    </div>
                </div>
                <div id="payment-customer-list-container"></div>
            </div>
            <div id="cash-bill-view" style="display:none;">
                <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="cash-bill-customer-search-input" placeholder="Search customers...">
                    </div>
                </div>
                <div id="cash-bill-customer-list-container"></div>
            </div>

            <div id="cash-bill-collection-view" style="display:none;">
                <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="cash-collection-customer-search-input" placeholder="Search pending collections...">
                    </div>
                </div>
                <div id="cash-bill-collection-list-container"></div>
            </div>
        </div>
        <div id="footer" class="footer">
            <button class="footer-button active" id="orders-tab-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Customers</span>
            </button>
            <button class="footer-button" id="payments-tab-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                <span>Credit Pay</span>
            </button>
            <button class="footer-button" id="cash-bill-tab-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                <span>Cash Bill</span>
            </button>
            <button class="footer-button" id="cash-collection-tab-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <span>Collection</span>
            </button>
        </div>
    </div>

    <div id="page-order" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-customers-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="order-customer-name">New Order</h1>
            <div class="header-actions">
                <button class="icon-button" id="cart-icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    <span id="cart-item-count" style="display: none;">0</span>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="credit-bill-search-container">
                 <div class="card">
                    <div class="search-toggle-buttons">
                        <button class="toggle-btn active" data-search-type="salesman">Salesman List</button>
                        <button class="toggle-btn" data-search-type="master">Master List</button>
                    </div>
                    <div id="salesman-search-view" class="search-view active">
                        <div class="search-bar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="salesman-item-search-input" placeholder="Search salesman list...">
                        </div>
                    </div>
                    <div id="master-search-view" class="search-view">
                         <div class="search-bar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="item-search-input" placeholder="Search all items...">
                        </div>
                    </div>
                </div>
            </div>
            <div id="item-tiles-container"></div>
        </div>
    </div>
    
    <div id="page-order-summary" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-order-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="order-summary-header">Order Summary</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <h3 style="margin-bottom: 10px;">Current Order</h3>
            <div id="order-summary-list"></div>
            <div id="order-summary-grand-total"></div>
        </div>
        <div id="order-summary-actions">
            <button id="save-update-slip-btn" class="button">Save Packing Slip</button>
        </div>
    </div>

    <div id="page-payment" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-btn-payment">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="payment-customer-name">Collect Payment</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <input type="number" id="payment-amount" placeholder="Enter Amount" min="0">
                <div class="payment-method-options">
                    <div class="payment-method-option selected" data-method="Cash">Cash</div>
                    <div class="payment-method-option" data-method="UPI">UPI</div>
                </div>
                <button id="confirm-payment-btn" class="button">Confirm Payment</button>
                <div id="payment-actions-container" style="display: none; flex-direction: row; gap: 10px; margin-top: 10px;">
                    <button id="print-receipt-btn" class="button button-outline" style="margin: 0; flex: 1;">Print Receipt</button>
                    <button id="share-receipt-btn" class="button button-outline" style="margin: 0; flex: 1;">Share Receipt</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-order-history" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-btn-order-history">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Packing Slip History</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="order-history-date-filter" class="between-date-filter">
    <!-- Start Date Wrapper -->
    <div class="date-input-wrapper">
        <button class="date-btn start-date-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span class="date-label">Start Date</span>
        </button>
        <input type="date" class="date-input start-date-input">
    </div>

    <!-- End Date Wrapper -->
    <div class="date-input-wrapper">
        <button class="date-btn end-date-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span class="date-label">End Date</span>
        </button>
        <input type="date" class="date-input end-date-input">
    </div>

    <button class="filter-action-btn clear-btn">Clear</button>
</div>
            <div id="order-history-list"></div>
        </div>
    </div>
    
    <div id="page-payment-history" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-btn-payment-history">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Payment History</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <button id="view-collection-summary-btn" class="button" style="margin-bottom: 20px;">View Collection Summary</button>
            <div id="payment-history-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="payment-history-list"></div>
        </div>
    </div>
    
    <div id="page-outstanding-balances" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-main-from-outstanding-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Pending Balances</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="filter-bar">
                <div class="search-bar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="outstanding-search-input" placeholder="Search customers...">
                </div>
                <div class="form-group">
                    <select id="outstanding-route-filter">
                        <option value="ALL">All Routes</option>
                    </select>
                </div>
                <button id="outstanding-sort-btn" class="button button-outline" style="margin: 0; flex: 1; min-width: 150px; padding: 10px; font-size: 0.9rem;">Sort by Amount</button>
            </div>
            <div class="card">
                <div class="kpi-card-small" style="padding: 20px; box-shadow: none; border: 1px solid var(--border-color);">
                    <div id="total-outstanding-value" class="value" style="color: var(--danger-color);"></div>
                    <div class="label">Total Outstanding Balance</div>
                </div>
            </div>
            <div id="outstanding-list-container"></div>
        </div>
    </div>

    <div id="page-payment-summary" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-payment-history-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Collection Summary <span id="summary-date-range" style="font-size: 0.9rem; font-weight: 400; opacity: 0.8;"></span></h1>
            <div class="header-actions">
                 <button class="icon-button" id="print-summary-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                </button>
            </div>
        </div>
        <div class="content" id="payment-summary-content"></div>
    </div>
    
    <div id="page-customer-profile" class="page">
        <div class="header">
             <button class="icon-button" data-action="back-to-main">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="customer-profile-name">Customer Profile</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" id="customer-profile-content"></div>
    </div>

    <div id="page-customer-ledger" class="page">
        <div class="header">
             <button class="icon-button" data-action="back-to-main">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="customer-ledger-name">Customer Ledger</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" id="customer-ledger-content">
        </div>
    </div>

    <div id="page-product-info" class="page">
        <div class="header">
             <button class="icon-button" id="back-to-main-from-info-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Product Info</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Search Item</h3>
                <div class="search-toggle-buttons">
                    <button class="toggle-btn active" data-search-type="info-salesman">Salesman List</button>
                    <button class="toggle-btn" data-search-type="info-master">Master List</button>
                </div>
                <div id="info-salesman-search-view" class="search-view active">
                    <div style="position: relative;">
                        <div class="search-bar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="info-salesman-item-search-input" placeholder="Search salesman list...">
                        </div>
                        <div id="info-salesman-item-search-results"></div>
                    </div>
                </div>
                <div id="info-master-search-view" class="search-view">
                    <div style="position: relative;">
                        <div class="search-bar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="info-item-search-input" placeholder="Search all items...">
                        </div>
                        <div id="info-item-search-results"></div>
                    </div>
                </div>
            </div>
            <div id="product-info-display-card" class="card" style="display: none;"></div>
        </div>
    </div>


    <div id="page-settings" class="page">
        <div class="header">
            <button class="icon-button" id="back-from-settings-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Manage Data</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Upload New Data</h3>
                <p style="margin-bottom: 15px; font-style: italic; color: #555;">Uploading will replace existing data.</p>
                <div class="file-upload-wrapper"><div class="file-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>Upload Customer CSV</p><input type="file" id="customer-file-upload" accept=".csv"></div></div>
                 <div class="file-upload-wrapper"><div class="file-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>Upload Item (Master) CSV</p><input type="file" id="item-file-upload" accept=".csv"></div></div>
                 <div class="file-upload-wrapper"><div class="file-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>Upload Salesman Item List CSV</p><input type="file" id="salesman-item-file-upload" accept=".csv"></div></div>
                 <div class="file-upload-wrapper"><div class="file-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>Upload Cash Only Items CSV</p><input type="file" id="cash-item-file-upload" accept=".csv"></div></div>
            </div>
            <div class="card">
                <h3>Edit Existing Data</h3>
                <button class="button button-outline" id="set-shop-location-btn" style="margin-bottom: 10px; display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    Set Shop Location
                </button>
                <button class="button button-outline" id="edit-customers-btn" style="margin-bottom: 10px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Edit Customers</button>
                <button class="button button-outline" id="edit-items-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Edit Items</button>
            </div>
        </div>
    </div>

    <div id="page-edit-data" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-settings-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="edit-data-header">Edit</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="search-bar"><input type="text" id="edit-data-search" placeholder="Search..."></div>
            <div id="edit-data-list"></div>
        </div>
    </div>

    <div id="page-admin-dashboard" class="page">
        <div class="header">
            <button class="icon-button" id="admin-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1 id="admin-header">Admin Dashboard</h1>
            <div class="header-actions">
                 <button class="icon-button" id="admin-settings-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="admin-dashboard-view">
                <div id="admin-date-filter" class="between-date-filter">
                    <input type="date" class="date-input start-date-input">
                    <button class="date-btn start-date-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="date-label">Start Date</span>
                    </button>
                    <input type="date" class="date-input end-date-input">
                    <button class="date-btn end-date-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="date-label">End Date</span>
                    </button>
                    <button class="filter-action-btn clear-btn">Clear</button>
                </div>
                <div id="admin-dashboard-content"></div>
            </div>
            <div id="admin-operations-view" style="display: none;">
                <div id="operations-date-filter" class="between-date-filter">
                     <input type="date" class="date-input start-date-input">
                    <button class="date-btn start-date-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="date-label">Start Date</span>
                    </button>
                    <input type="date" class="date-input end-date-input">
                    <button class="date-btn end-date-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="date-label">End Date</span>
                    </button>
                    <button class="filter-action-btn clear-btn">Clear</button>
                </div>
                <div id="admin-operations-content" class="operations-content"></div>
            </div>
        </div>
        <div id="admin-footer" class="footer">
            <button class="footer-button active" id="admin-dashboard-tab">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>Dashboard</span>
            </button>
            <button class="footer-button" id="admin-operations-tab">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                <span>Operations</span>
            </button>
        </div>
    </div>

    <div id="page-edit-packing-slip" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-history-from-edit-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="edit-packing-slip-header">Edit Packing Slip</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Add Item</h3>
                <div class="search-bar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="edit-slip-item-search-input" placeholder="Search all items...">
                    <div id="edit-slip-item-search-results"></div>
                </div>
            </div>
            <h3 style="margin-bottom: 10px;">Current Items</h3>
            <div id="edit-slip-item-list"></div>
            <div id="edit-slip-grand-total" style="margin-top: 20px; padding: 15px; background-color: var(--primary-color); color: white; font-size: 1.2rem; font-weight: bold; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center;"></div>
        </div>
        <div style="padding: 20px; flex-shrink: 0; display: flex; gap: 10px;">
            <button id="save-packing-slip-btn" class="button" style="flex: 1; margin:0;">Save Changes</button>
        </div>
    </div>

    <div id="page-location-report" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-admin-from-location-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Location Report</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" id="location-report-content"></div>
    </div>
    
    <div id="page-salesman-report" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-admin-dashboard-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="salesman-report-header">Salesman Report</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" id="salesman-report-content"></div>
    </div>

    <div id="page-customer-report" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-salesman-report-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="customer-report-header">Customer Report</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" id="customer-report-content"></div>
    </div>

    <div id="page-crm" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-admin-from-crm-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Bulk Messaging (CRM)</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>1. Target Customers</h3>
                <div id="crm-filters">
                    <div class="form-group"><label for="crm-salesman-filter">Filter by Salesman</label><select id="crm-salesman-filter"><option value="ALL">All Salesmen</option></select></div>
                    <div class="form-group"><label for="crm-route-filter">Filter by Route</label><select id="crm-route-filter"><option value="ALL">All Routes</option></select></div>
                </div>
                <div id="crm-customer-count"></div>
            </div>
             <div class="card">
                <h3>2. Build Your Flyer</h3>
                <div id="crm-flyer-builder-content">
                    <div class="form-group"><label for="crm-flyer-headline">Flyer Headline</label><input type="text" id="crm-flyer-headline" placeholder="e.g., Weekend Super Sale!"></div>
                    <hr style="border: 1px solid #f0f0f0; margin: 20px 0;">
                    <h4 style="margin-bottom:10px;">Add Items to Offer</h4>
                    <div id="crm-flyer-item-list"></div>
                    <div id="offer-item-search-container-bulk" style="position: relative;"><input type="text" id="offer-item-search-input-bulk" placeholder="Search for products..."><div id="offer-item-search-results-bulk"></div></div>
                </div>
                <div id="crm-flyer-preview-container"><p style="color:#888;">Flyer preview will appear here.</p></div>
            </div>
             <button class="button" id="generate-bulk-flyer-btn">Generate Flyer Preview</button>
             <button class="button button-accent" id="share-bulk-flyer-btn" style="display:none; margin-top:10px;">Share Flyer with Customers</button>
        </div>
    </div>
    
    <div id="page-packer-home" class="page">
        <div class="header">
            <button class="icon-button" id="packer-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1>Pending Orders</h1>
            <div class="header-actions">
                <button class="icon-button" id="packer-history-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="packer-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="packer-order-list"></div>
        </div>
    </div>

    <div id="page-packer-history" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-packer-home-from-history-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Packing History</h1>
             <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="packer-history-list"></div>
        </div>
    </div>
    
    <div id="page-billed-orders" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-main-from-billed-orders-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Billed Orders</h1>
            <div class="header-actions" style="width:24px;"></div>
        </div>
        <div class="content">
            <div id="billed-orders-list"></div>
        </div>
    </div>

    <div id="page-biller-home" class="page">
        <div class="header">
            <button class="icon-button" id="biller-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1>Pending for Billing</h1>
            <div class="header-actions">
                <button class="icon-button" id="biller-history-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="biller-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="biller-order-list"></div>
        </div>
    </div>

    <div id="page-billing-interface" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-biller-home-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="billing-order-customer">Billing Order</h1>
            <div class="header-actions" style="width:24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Add Product</h3>
                <div class="search-bar">
                    <input type="text" id="billing-item-search" placeholder="Search for an item...">
                    <div id="billing-item-search-results"></div>
                </div>
            </div>
            <div id="freight-input-container" class="card" style="display: none;">
                <h3>Add Freight</h3>
                <div class="form-group">
                    <label for="freight-amount">Freight Amount ()</label>
                    <input type="number" id="freight-amount" placeholder="Enter freight charge" min="0">
                </div>
            </div>
            <div id="billing-item-list"></div>
        </div>
        <div style="padding: 15px;">
            <button id="confirm-billing-btn" class="button">Confirm Billing</button>
        </div>
    </div>

    <div id="page-biller-history" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-biller-home-from-history-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Billing History</h1>
            <div class="header-actions" style="width:24px;"></div>
        </div>
        <div class="content">
            <div id="biller-history-list"></div>
        </div>
    </div>
    
    <div id="page-accountant-dashboard" class="page">
        <div class="header">
            <button class="icon-button" id="accountant-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1 id="accountant-header">Customer Ledger</h1>
            <div class="header-actions">
                <button class="icon-button" id="accountant-print-collection-btn" style="display: none;" title="Print Collection Summary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="accountant-ledger-view">
                <div class="search-bar" style="margin-bottom: 20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="accountant-customer-search" placeholder="Search all customers...">
                </div>
                <div id="accountant-customer-list"></div>
            </div>
            <div id="accountant-collection-view" style="display: none;">
                <div id="accountant-date-filter" class="between-date-filter">
                    <input type="date" class="date-input start-date-input">
                    <button class="date-btn start-date-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="date-label">Start Date</span>
                    </button>
                    <input type="date" class="date-input end-date-input">
                    <button class="date-btn end-date-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="date-label">End Date</span>
                    </button>
                    <button class="filter-action-btn clear-btn">Clear</button>
                </div>
                <div id="accountant-salesman-toggle" class="search-toggle-buttons">
                    <button class="toggle-btn active" data-salesman="UNNI">UNNI</button>
                    <button class="toggle-btn" data-salesman="RIYAS">RIYAS</button>
                </div>
                <div id="accountant-collection-content"></div>
            </div>
        </div>
        <div class="footer">
            <button class="footer-button active" id="accountant-ledger-tab">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <span>Ledger</span>
            </button>
            <button class="footer-button" id="accountant-collection-tab">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <span>Collection</span>
            </button>
        </div>
    </div>

    <div id="page-accountant-customer-ledger" class="page">
         <div class="header">
             <button class="icon-button" data-action="back-to-accountant-main">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="accountant-customer-ledger-name">Customer Ledger</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" id="accountant-customer-ledger-content"></div>
    </div>

    <div id="page-user-timeline" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-operations-from-timeline-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="user-timeline-header">User Timeline</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" id="user-timeline-content"></div>
    </div>

    <div id="page-loader-home" class="page">
        <div class="header">
            <button class="icon-button" id="loader-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1>Pending Loads</h1>
            <div class="header-actions">
                <button class="icon-button" id="loader-history-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="loader-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="loader-order-list"></div>
        </div>
        <div class="page-actions">
            <button id="start-loading-batch-btn" class="button" disabled>Start Loading Batch</button>
        </div>
    </div>

    <div id="page-loading-interface" class="page">
        <div class="header">
            <h1 id="loading-interface-header">Loading in Progress</h1>
        </div>
        <div class="content">
            <div class="card">
                <h3>Customers in this Batch</h3>
                <div id="loading-batch-customer-list"></div>
            </div>
        </div>
        <div class="page-actions">
            <button id="finish-loading-btn" class="button">Finish Loading</button>
        </div>
    </div>

    <div id="page-loader-history" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-loader-home-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Loading History</h1>
             <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="loader-history-list"></div>
        </div>
    </div>
    
    <div id="page-delivery-home" class="page">
        <div class="header">
            <button class="icon-button" id="delivery-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1>Pending Deliveries</h1>
            <div class="header-actions">
                <button class="icon-button" id="delivery-history-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                </button>
            </div>
        </div>
        <div class="content">
            <div id="delivery-batch-list"></div>
        </div>
    </div>

    <div id="page-delivery-interface" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-delivery-home-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Delivery Batch</h1>
            <div class="header-actions" id="delivery-header-actions"></div>
        </div>
        <div class="content">
            <div id="delivery-customer-list"></div>
        </div>
    </div>

    <div id="page-delivery-history" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-delivery-home-from-history-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Delivery History</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="delivery-history-list"></div>
        </div>
    </div>

    <div id="page-packer-assistant" class="page">
        <div class="header">
            <button class="icon-button" id="packer-assistant-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1 id="packer-assistant-header">Assigned Orders</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="packer-assistant-order-list"></div>
        </div>
    </div>

    <div id="page-packing-interface" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-packer-assistant-home-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="packing-interface-order-customer">Packing Order</h1>
            <div class="header-actions" style="width:24px;"></div>
        </div>
        <div class="content">
            <div class="card">
                <h3>Add Product</h3>
                <div class="search-bar">
                    <input type="text" id="assistant-packing-item-search" placeholder="Search for an item...">
                    <div id="assistant-packing-item-search-results"></div>
                </div>
            </div>
            <div id="assistant-packing-item-list"></div>
        </div>
        <div class="page-actions">
            <button id="finish-packing-btn" class="button">Finish Packing</button>
        </div>
    </div>

    <div id="page-purchase-planner" class="page">
        <div class="header">
             <button class="icon-button" id="purchase-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1 id="purchase-planner-header">Items</h1>
            <div class="header-actions" id="purchase-planner-header-actions" style="width: 24px;"></div>
        </div>
        <div class="content" style="padding-bottom: 80px;"> 
            <div id="purchase-item-finder-view" class="purchase-view">
    <div class="card" style="display: flex; flex-direction: column; align-items: center; padding-top: 30px; padding-bottom: 30px;">
        <div class="search-bar" style="width: 100%; max-width: 500px; position: relative;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="item-finder-search-input" placeholder="Search any product...">
            <div id="item-finder-search-results"></div>
        </div>
        <div id="item-finder-display-card" style="display: none; margin-top: 20px; width: 100%; max-width: 500px;"></div>
    </div>
</div>
            <div id="purchase-vendors-view" class="purchase-view active">
                <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="purchase-vendor-search" placeholder="Search vendors...">
                    </div>
                </div>
                <div id="purchase-vendor-list" class="tile-grid"></div>
                <button class="fab-button" id="add-vendor-fab">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
            <div id="purchase-locations-view" class="purchase-view">
                 <div class="filter-bar">
                    <div class="search-bar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="purchase-location-search" placeholder="Search locations...">
                    </div>
                </div>
                <div id="purchase-location-list" class="tile-grid"></div>
                 <button class="fab-button" id="add-location-fab">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
        </div>
        <div class="footer">
    <button class="footer-button active" id="purchase-item-finder-tab">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <span>Item Finder</span>
    </button>
    <button class="footer-button" id="purchase-vendors-tab">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        <span>Vendors</span>
    </button>
    <button class="footer-button" id="purchase-locations-tab">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
        <span>Locations</span>
    </button>
</div>
    </div>

    <div id="page-purchase-detail" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-purchase-planner-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="purchase-detail-header"></h1>
            <div class="header-actions">
                 <button class="icon-button" id="print-planner-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                </button>
            </div>
        </div>
        <div class="content" style="padding-bottom: 80px;">
             <div id="purchase-detail-list"></div>
             <button class="fab-button" id="add-item-to-purchase-list-fab">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>
    </div>

    <!-- ======================= HR ATTENDANCE PAGE ======================= -->
    <div id="page-hr" class="page">
        <div class="header">
            <button class="icon-button" id="hr-logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
            </button>
            <h1>HR Dashboard</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="hr-user-grid">
                <!-- User tiles will be dynamically inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ======================= HR ATTENDANCE REPORT PAGE ======================= -->
    <div id="page-hr-admin-report" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-hr-dashboard-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1>Attendance Report</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
            <div id="hr-report-date-filter" class="between-date-filter">
                <input type="date" class="date-input start-date-input">
                <button class="date-btn start-date-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">Start Date</span>
                </button>
                <input type="date" class="date-input end-date-input">
                <button class="date-btn end-date-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="date-label">End Date</span>
                </button>
                <button class="filter-action-btn clear-btn">Clear</button>
            </div>
            <div id="hr-report-container" class="card table-responsive-wrapper">
                <!-- Report table will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Hidden elements for generation -->
    <div id="packing-slip-wrapper"><div id="packing-slip-content"></div></div>
    <div id="sale-bill-wrapper"><div id="sale-bill-content"></div></div>
    <div id="loading-slip-wrapper"><div id="loading-slip-content"></div></div>
    <div id="payment-receipt-wrapper"><div class="receipt-container"><div class="receipt-header"><h2 id="receipt-title">Payment Receipt</h2><p>MF BIGMARKET</p></div><div class="receipt-details"><p><strong>Date:</strong><span id="receipt-date"></span></p><p><strong>Salesman:</strong><span id="receipt-salesman"></span></p><p><strong>Customer:</strong><span id="receipt-customer"></span></p><p id="receipt-method-container"><strong>Pay Method:</strong><span id="receipt-method"></span></p></div><div class="receipt-amount"><div id="receipt-amount-label" class="amount-label">Amount Received</div><div class="amount-value" id="receipt-amount"></div></div><div class="receipt-footer">Thank you for your business!<br>For queries, contact: 9961195050</div></div></div>
    <div id="collection-report-wrapper"><div id="collection-report"><div class="report-header"><h2>MF BIGMARKET</h2><p>Daily Collection Report</p></div><div class="report-details"><div id="report-salesman"></div><div id="report-date"></div></div><table class="report-table"><thead><tr><th>CUSTOMER</th><th class="col-method">MODE</th><th class="col-amount">AMOUNT</th></tr></thead><tbody id="report-table-body"></tbody></table><div class="report-footer"><div id="report-totals"></div><div class="grand-total" id="report-grand-total"></div></div></div></div>
    <div id="flyer-template-wrapper"></div>
    <div id="payment-summary-print-wrapper"><div id="payment-summary-print-content"><div class="print-header"><h2>MF BIGMARKET</h2><p>Collection Summary Report</p></div><div class="print-details"><div id="print-summary-salesman"></div><div id="print-summary-daterange"></div></div><table class="print-table"><thead><tr><th>Date & Time</th><th>Customer</th><th>Mode</th><th class="numeric">Amount</th></tr></thead><tbody id="print-summary-table-body"></tbody></table><div class="print-totals-footer"><div><span>Total Cash:</span> <span id="print-summary-cash"></span></div><div><span>Total UPI:</span> <span id="print-summary-upi"></span></div><div class="grand-total"><span>Grand Total:</span> <span id="print-summary-grandtotal"></span></div></div></div></div>
    <div id="purchase-planner-print-wrapper"><div id="purchase-planner-print-content"></div></div>

    <div id="offer-modal" class="modal"><div class="modal-content"><h2 id="offer-modal-title">Flyer Builder</h2><div class="modal-body" id="offer-modal-body"></div><div class="modal-footer"><button class="button button-outline" id="close-offer-modal-btn">Cancel</button><button class="button" id="generate-flyer-btn">Generate Flyer</button><button class="button button-accent" id="share-flyer-btn" style="display:none;">Share Flyer</button></div></div></div>
    <div id="edit-modal" class="modal"><div class="modal-content"><h2 id="edit-modal-title">Edit</h2><div class="modal-body" id="edit-modal-body"></div><div class="modal-footer"><button class="button button-outline" id="close-edit-modal-btn">Cancel</button><button class="button" id="save-edit-btn">Save Changes</button></div></div></div>
    <div id="professional-modal" class="modal"><div class="modal-content"><h2 id="professional-modal-title">Success</h2><div class="modal-body"><p id="professional-modal-message">Your action was successful.</p></div><div class="modal-footer"><button class="button" id="professional-modal-close-btn">Close</button></div></div></div>
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <h2>Transfer Order</h2>
            <div id="transfer-assistant-buttons">
                <button class="button" data-assistant="ANISHAD">Transfer to ANISHAD</button>
                <button class="button" data-assistant="MUFEEDA">Transfer to MUFEEDA</button>
            </div>
        </div>
    </div>
    <div id="add-vendor-modal" class="modal">
        <div class="modal-content">
            <h2>Add New Vendor</h2>
            <div class="modal-body">
                <div class="form-group"><label>Vendor Name</label><input type="text" id="new-vendor-name"></div>
                <div class="form-group"><label>Landing Frequency (in days)</label><input type="number" id="new-vendor-frequency" placeholder="e.g., 7"></div>
            </div>
            <div class="modal-footer">
                <button class="button button-outline" data-action="close">Cancel</button>
                <button class="button" id="save-new-vendor-btn">Save Vendor</button>
            </div>
        </div>
    </div>
    <div id="add-location-modal" class="modal">
         <div class="modal-content">
            <h2>Add New Location</h2>
            <div class="modal-body">
                <div class="form-group"><label>Location Name</label><input type="text" id="new-location-name"></div>
                <div class="form-group"><label>Landing Frequency (in days)</label><input type="number" id="new-location-frequency" placeholder="e.g., 14"></div>
            </div>
            <div class="modal-footer">
                <button class="button button-outline" data-action="close">Cancel</button>
                <button class="button" id="save-new-location-btn">Save Location</button>
            </div>
        </div>
    </div>
     <div id="add-item-to-purchase-list-modal" class="modal">
        <div class="modal-content">
            <h2>Add Item to List</h2>
            <div class="modal-body">
                <div class="search-bar">
                    <input type="text" id="purchase-item-search-input" placeholder="Search for an item to add...">
                </div>
                <div id="purchase-item-search-results"></div>
            </div>
             <div class="modal-footer">
                <button class="button button-outline" data-action="close">Cancel</button>
            </div>
        </div>
    </div>
    <div id="add-vendor-to-location-modal" class="modal">
        <div class="modal-content">
            <h2>Add Vendor to Location</h2>
            <div class="modal-body" id="add-vendor-to-location-modal-body">
                <!-- Vendor list will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="button button-outline" data-action="close">Cancel</button>
            </div>
        </div>
    </div>
    <!-- ======================= PASSWORD AUTH MODAL ======================= -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h2 id="password-modal-title">Enter Password</h2>
            <div class="modal-body">
                <div class="password-icon-container">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                </div>
                <div class="form-group" id="password-form-group">
                    <label for="password-input">Password Required</label>
                    <input type="password" id="password-input" placeholder="">
                </div>
                <p id="password-error-message" style="display: none;">Incorrect Password. Please try again.</p>
            </div>
            <div class="modal-footer">
                <button class="button button-outline" id="password-cancel-btn">Cancel</button>
                <button class="button" id="password-submit-btn">Submit</button>
            </div>
        </div>
    </div>
    <!-- ======================= ATTENDANCE MARKING MODAL ======================= -->
    <div id="attendance-modal" class="modal">
        <div class="modal-content">
            <h2 id="attendance-modal-title">Mark Attendance for [User]</h2>
            <div class="modal-body" id="attendance-modal-body" style="text-align: center;">
                <!-- The IN or OUT button will be injected here by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="button button-outline" data-action="close-attendance">Cancel</button>
            </div>
        </div>
    </div>
    <!-- ======================= ATTENDANCE CALENDAR MODAL ======================= -->
    <div id="attendance-calendar-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 id="calendar-modal-title">Attendance Calendar</h2>
            <div class="modal-body">
                <div id="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button id="calendar-prev-month" class="button button-outline" style="padding: 5px 10px; width: auto; min-width: 40px;">&lt;</button>
                    <h3 id="calendar-month-year" style="margin: 0; text-align: center;"></h3>
                    <button id="calendar-next-month" class="button button-outline" style="padding: 5px 10px; width: auto; min-width: 40px;">&gt;</button>
                </div>
                <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center;"></div>
                <div id="calendar-legend" style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; margin-top: 20px; font-size: 0.8rem; border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <div style="display: flex; align-items: center;"><span style="display: inline-block; width: 12px; height: 12px; background-color: var(--success-color); border-radius: 3px; margin-right: 5px;"></span> Present</div>
                    <div style="display: flex; align-items: center;"><span style="display: inline-block; width: 12px; height: 12px; background-color: var(--warning-color); border-radius: 3px; margin-right: 5px;"></span> Half Day</div>
                    <div style="display: flex; align-items: center;"><span style="display: inline-block; width: 12px; height: 12px; background-color: var(--danger-color); border-radius: 3px; margin-right: 5px;"></span> Absent</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button" data-action="close-calendar">Close</button>
            </div>
        </div>
    </div>


<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        if (!window.firebaseDB || !window.firebaseTools) {
            document.body.innerHTML = `<div style="padding: 20px; text-align: center;"><h1>Initialization Error</h1><p>Could not connect to the database. Please check your internet connection and Firebase configuration.</p></div>`;
            return;
        }
        
        const getDefaultDateRange = () => {
            const now = new Date();
            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];
            const today = toYYYYMMDD(now);
            return { startDate: today, endDate: today };
        };

        const { startDate, endDate } = getDefaultDateRange();
        
        let appState = {
            salesman: null, customer: null, items: [], customers: [],
            salesmanItems: [], 
            cashOnlyItems: [],
            orders: {}, payments: {}, customerCarts: {},
            userStatus: {},
            purchaseVendors: [], purchaseLocations: [],
            currentPurchaseListItems: [],
            packerAssistants: ['ANISHAD', 'MUFEEDA'], 
            editingPackingSlipId: null,
            currentPayment: {}, 
            currentView: 'customers',
            currentOrderType: 'credit',
            editing: { type: null, id: null },
            reporting: { 
                salesman: null, 
                customer: null, 
                startDate: startDate, 
                endDate: endDate,
                accountantSalesman: 'UNNI',
            },
            shareableFlyerBlob: null,
            bulkFlyerBlob: null,
            flyerBuilder: { items: [], editingIndex: null },
            currentOrderLocation: null,
            currentOrderStartTime: null,
            outstandingUpdateTimeout: null,
            outstandingSort: 'default',
            billingOrder: null,
            packingOrder: null,
            currentLoadingBatch: [],
            currentDeliveryBatch: null,
            orderToTransfer: null,
            purchaseItemSort: 'alpha',
            currentPurchaseContext: null,
             pendingRole: null,
            managingVendorId: null,
             calendarContext: { username: null, year: null, month: null },
        };

        const { getDocs, getDoc, collection, doc, setDoc, onSnapshot, deleteDoc, writeBatch, query, updateDoc, deleteField, addDoc } = window.firebaseTools;
        const db = window.firebaseDB;

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; // Earth's radius in metres
            const 1 = lat1 * Math.PI / 180;
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const  = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin( / 2) * Math.sin( / 2) +
                      Math.cos(1) * Math.cos(2) *
                      Math.sin( / 2) * Math.sin( / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in metres
        };

        const getActiveCart = () => {
            if (!appState.customer || !appState.customer.id) return [];
            if (!appState.customerCarts[appState.customer.id]) {
                appState.customerCarts[appState.customer.id] = [];
            }
            return appState.customerCarts[appState.customer.id];
        };
       
        const showPage = (pageId) => { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            const page = document.getElementById(pageId);
            if(page) {
                page.classList.add('active'); 
                if (page.querySelector('.between-date-filter')) {
                    updateFilterUI(page.querySelector('.between-date-filter').id);
                }
            }
        };

        const updateUserStatus = async (status, task = 'Idle') => {
            if (!appState.salesman || appState.salesman === 'ADMIN' || appState.salesman === 'NANDU' || appState.salesman === 'SUNNY' || appState.salesman === 'HR') return;
            try {
                const statusRef = doc(db, "user_status", appState.salesman);
                await setDoc(statusRef, {
                    status: status,
                    task: task,
                    lastUpdate: new Date().toISOString()
                }, { merge: true });
            } catch (error) {
                console.error("Failed to update user status:", error);
            }
        };

        const formatCurrency = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
        const formatPreciseCurrency = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(v);
        
        const formatDateForDisplay = (dateString) => {
            if (!dateString) return null;
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const correctedDate = new Date(date.getTime() + userTimezoneOffset);
            return correctedDate.toLocaleDateString('en-GB');
        };
        
        const formatDDMMYYYY = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        };

        const formatDDMMYYYYTime = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-GB', { timeZone: 'Asia/Kolkata' }).replace(',', '');
        };
        
        const createSearchResultItemHTML = (i, showDetails = true) => {
            const margin = i.CostRate > 0 ? (((i.Price2 - i.CostRate) / i.CostRate) * 100) : 0;
            const marginClass = margin >= 0 ? 'profit' : 'loss';
            const stockColor = i.Clstock > 10 ? 'var(--success-color)' : (i.Clstock > 0 ? 'var(--warning-color)' : 'var(--danger-color)');

            return `
                <div class="search-result-item" data-item-code="${i.Code}">
                    <div class="item-name">${i.ItemName}</div>
                    ${showDetails ? `<div class="item-details-grid">
                        <div class="detail-cell"><span class="label">P2</span><span class="value item-p2">${formatPreciseCurrency(i.Price2)}</span></div>
                        <div class="detail-cell"><span class="label">MRP</span><span class="value">${formatPreciseCurrency(i.Mrp)}</span></div>
                        <div class="detail-cell"><span class="label">Margin</span><span class="value item-margin ${marginClass}">${margin.toFixed(1)}%</span></div>
                        <div class="detail-cell"><span class="label">Stock</span><span class="value item-stock" style="color: ${stockColor};">${i.Clstock}</span></div>
                    </div>` : ''}
                </div>`;
        };

        const showProfessionalModal = (title, message, onCloseCallback) => {
            const modal = document.getElementById('professional-modal');
            document.getElementById('professional-modal-title').textContent = title;
            document.getElementById('professional-modal-message').textContent = message;
            const closeBtn = document.getElementById('professional-modal-close-btn');
            const closeModal = () => {
                modal.classList.remove('active');
                if (onCloseCallback && typeof onCloseCallback === 'function') onCloseCallback();
            };
            closeBtn.addEventListener('click', closeModal, { once: true });
            modal.classList.add('active');
        };
        
        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }, 10);
        };

        const getCurrentLocation = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject(new Error("Geolocation is not supported."));
                navigator.geolocation.getCurrentPosition(
                    (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                    (err) => reject(new Error(`Location Error (${err.code}): ${err.message}`)),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        };

        const setupRealtimeListeners = () => {
            onSnapshot(collection(db, "customers"), (snapshot) => { 
                appState.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                if(appState.salesman && !['ADMIN', 'SUNNY', 'ARFATH', 'NANDU', 'SHAJU', 'BENNY', 'FASAL', 'HR', ...appState.packerAssistants].includes(appState.salesman)) renderCurrentView();
                if(document.getElementById('page-outstanding-balances').classList.contains('active')) renderOutstandingBalancesPage();
                if(appState.salesman === 'NANDU') renderAccountantView();
            });
            onSnapshot(collection(db, "items"), (snapshot) => { 
                appState.items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                if (appState.salesman === 'ADMIN' && document.getElementById('admin-dashboard-view').style.display !== 'none') renderAdminDashboard();
                if (appState.salesman === 'FASAL' && document.getElementById('purchase-items-view').classList.contains('active')) renderPurchaseItems();
            });
            onSnapshot(doc(db, "salesman_items", "sharedList"), (docSnap) => {
                appState.salesmanItems = docSnap.exists() ? docSnap.data().itemNames || [] : [];
            });
            onSnapshot(doc(db, "app_config", "cash_items"), (docSnap) => {
                appState.cashOnlyItems = docSnap.exists() ? docSnap.data().itemCodes || [] : [];
            });
            onSnapshot(query(collection(db, "orders")), (snapshot) => { 
                appState.orders = {}; 
                const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allOrders.forEach(order => {
                    if (!appState.orders[order.salesman]) appState.orders[order.salesman] = [];
                    appState.orders[order.salesman].push(order);
                });
                if (document.getElementById('page-order-history').classList.contains('active')) renderHistoryTabs();
                if (document.getElementById('page-billed-orders').classList.contains('active')) renderBilledOrders();
                if (appState.salesman === 'ADMIN' && document.getElementById('admin-dashboard-view').style.display !== 'none') renderAdminDashboard();
                if (appState.salesman === 'ADMIN' && document.getElementById('admin-operations-view').style.display !== 'none') renderAdminOperationsPage();
                if (appState.salesman === 'SUNNY' && document.getElementById('page-packer-home').classList.contains('active')) renderPackerHome();
                if (appState.salesman === 'SUNNY' && document.getElementById('page-packer-history').classList.contains('active')) renderPackerHistory();
                if (appState.packerAssistants.includes(appState.salesman)) renderPackerAssistantHome();
                if (appState.salesman === 'ARFATH' && document.getElementById('page-biller-home').classList.contains('active')) renderBillerHome();
                if (appState.salesman === 'ARFATH' && document.getElementById('page-biller-history').classList.contains('active')) renderBillerHistory();
                if (appState.salesman === 'SHAJU' && document.getElementById('page-loader-home').classList.contains('active')) renderLoaderHome();
                if (appState.salesman === 'SHAJU' && document.getElementById('page-loader-history').classList.contains('active')) renderLoaderHistory();
                if (appState.salesman === 'BENNY' && document.getElementById('page-delivery-home').classList.contains('active')) renderDeliveryHome();
                if (appState.salesman === 'BENNY' && document.getElementById('page-delivery-history').classList.contains('active')) renderDeliveryHistory();
                if (appState.salesman === 'NANDU') renderAccountantView();
                if (document.getElementById('cash-bill-collection-view').style.display !== 'none') {
                    renderCashBillCollectionView();
                }
            });
            onSnapshot(query(collection(db, "payments")), (snapshot) => { 
                appState.payments = {}; 
                const allPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allPayments.forEach(payment => { 
                    if (!appState.payments[payment.salesman]) appState.payments[payment.salesman] = []; 
                    appState.payments[payment.salesman].push(payment); 
                });
                if (appState.salesman === 'ADMIN' && document.getElementById('admin-dashboard-view').style.display !== 'none') renderAdminDashboard();
                if (document.getElementById('page-payment-history').classList.contains('active')) renderHistoryTabs();
                if (appState.salesman === 'NANDU' && document.getElementById('accountant-collection-view').style.display !== 'none') renderAccountantCollectionView();
                if (document.getElementById('cash-bill-collection-view').style.display !== 'none') renderCashBillCollectionView();
            });
            onSnapshot(collection(db, "user_status"), (snapshot) => {
                appState.userStatus = {};
                snapshot.docs.forEach(doc => {
                    appState.userStatus[doc.id] = doc.data();
                });
                if (appState.salesman === 'ADMIN' && document.getElementById('admin-operations-view').style.display !== 'none') {
                    renderAdminOperationsPage();
                }
            });
            onSnapshot(collection(db, "purchaseVendors"), snapshot => {
                appState.purchaseVendors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(appState.salesman === 'FASAL' && document.getElementById('purchase-vendors-view').classList.contains('active')) renderPurchaseVendors();
            });
            onSnapshot(collection(db, "purchaseLocations"), snapshot => {
                appState.purchaseLocations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(appState.salesman === 'FASAL' && document.getElementById('purchase-locations-view').classList.contains('active')) renderPurchaseLocations();
            });
        };

        const populateRoutes = (selectElementId) => {
            const salesmanCustomers = appState.customers.filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman);
            const routes = [...new Set(salesmanCustomers.map(c => c.Route).filter(Boolean))].sort();
            const routeFilter = document.getElementById(selectElementId);
            const currentRoute = routeFilter.value; 
            routeFilter.innerHTML = `<option value="ALL">All Routes</option>` + routes.map(r => `<option value="${r}" ${currentRoute === r ? 'selected' : ''}>${r}</option>`).join('');
        };

        const renderCustomerList = () => {
            const container = document.getElementById('customer-list-container');
            populateRoutes('customer-route-filter');
            const searchFilter = document.getElementById('customer-search-input').value.toLowerCase();
            const selectedRoute = document.getElementById('customer-route-filter').value;
            const filteredCustomers = appState.customers.filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman && (c.Customer || '').toLowerCase().includes(searchFilter) && (selectedRoute === 'ALL' || c.Route === selectedRoute));
            if (filteredCustomers.length === 0) { container.innerHTML = `<div class="card" style="text-align: center;">No customers found.</div>`; return; }
            container.innerHTML = filteredCustomers.map(c => `
                <div class="customer-item-container" data-customer='${JSON.stringify(c)}'>
                    <div class="customer-item-header">
                        <span class="info">${c.Customer}</span>
                        <svg class="arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                    <div class="customer-actions-panel"><button class="action-button" data-action="profile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span>Profile</span></button>
                        <button class="action-button" data-action="ledger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg><span>Ledger</span></button>
                        <button class="action-button" data-action="order"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg><span>Order</span></button>
                        <button class="action-button" data-action="offer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg><span>Offer</span></button>
                    </div>
                </div>`).join('');
        };
        const renderPaymentCustomerList = () => {
            const container = document.getElementById('payment-customer-list-container');
            populateRoutes('payment-route-filter');
            const searchFilter = document.getElementById('payment-customer-search-input').value.toLowerCase();
            const selectedRoute = document.getElementById('payment-route-filter').value;
            const filteredCustomers = appState.customers.filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman && (c.Customer || '').toLowerCase().includes(searchFilter) && (selectedRoute === 'ALL' || c.Route === selectedRoute));
            if (filteredCustomers.length === 0) { container.innerHTML = `<div class="card" style="text-align: center;">No customers found.</div>`; return; }
            container.innerHTML = filteredCustomers.map(c => `
                <div class="list-item">
                    <div class="info">
                        ${c.Customer}
                        <div style="font-size: 0.9rem; color: var(--danger-color); font-weight: 500; margin-top: 4px;">
                           Bal: ${formatCurrency(c.Outstanding || 0)}
                        </div>
                    </div>
                    <button class="list-item-action collect-credit-payment-btn" data-customer='${JSON.stringify(c)}'>Collect</button>
                </div>`).join('');
        };
                // ===============================================
        // START: PACKER ASSISTANT LOGIC
        // ===============================================

        const renderPackerAssistantHome = () => {
            const container = document.getElementById('packer-assistant-order-list');
            const assistantName = appState.salesman;
            
            if (!assistantName) {
                container.innerHTML = `<div class="card">Could not identify the user.</div>`;
                return;
            }

            const assignedOrders = Object.values(appState.orders).flat().filter(o =>
                o.packerAssistant === assistantName && o.status === 'packing'
            );

            assignedOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (assignedOrders.length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No orders assigned to you at the moment.</div>`;
                return;
            }

            container.innerHTML = assignedOrders.map(o => {
                const billTypeBadge = o.billType === 'cash' ? '<span class="bill-type-badge">Cash Bill</span>' : '';
                // Determine button text based on whether packing has been started
                const buttonText = o.packingStartTime ? 'Continue Packing' : 'Start Packing';
                const buttonClass = o.packingStartTime ? 'finish-pack-btn' : 'start-pack-btn';

                return `
                <div class="list-item" data-order-id="${o.id}">
                    <div class="info">
                        <span class="assistant-packing-item-name">${o.customer.Customer} (${o.salesman}) ${billTypeBadge}</span>
                        <span class="assistant-packing-item-details">Assigned: ${formatDDMMYYYYTime(o.date)}</span>
                    </div>
                    <button class="list-item-action ${buttonClass}" data-order-id="${o.id}">${buttonText}</button>
                </div>`;
            }).join('');
        };

        // ===============================================
        // END: PACKER ASSISTANT LOGIC
        // ===============================================
                // NEW: Renders the customer list for starting a new Cash Bill
        const renderCashBillView = () => {
            const container = document.getElementById('cash-bill-customer-list-container');
            const searchFilter = document.getElementById('cash-bill-customer-search-input').value.toLowerCase();
            
            const filteredCustomers = appState.customers.filter(c => 
                c.Salesman && c.Salesman.toUpperCase() === appState.salesman && 
                (c.Customer || '').toLowerCase().includes(searchFilter)
            );

            if (filteredCustomers.length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No customers found.</div>`;
                return;
            }

            container.innerHTML = filteredCustomers.map(c => `
                <div class="cash-bill-item" data-customer='${JSON.stringify(c)}'>
                    <div class="info">${c.Customer}</div>
                    <button class="list-item-action take-cash-order-btn">Take Order</button>
                </div>
            `).join('');
        };

        // NEW: Renders the list of billed cash orders that are pending collection
        const renderCashBillCollectionView = () => {
            const container = document.getElementById('cash-bill-collection-list-container');
            const searchFilter = document.getElementById('cash-collection-customer-search-input').value.toLowerCase();

            // 1. Get all billed cash orders for the current salesman
            const salesmanBilledCashOrders = (appState.orders[appState.salesman] || []).filter(o => 
                o.billType === 'cash' && o.status === 'billed'
            );

            // 2. Get the IDs of cash bill orders that have already been paid
            const paidCashBillOrderIds = new Set(
                Object.values(appState.payments).flat()
                .filter(p => p.paymentType === 'cash_bill' && p.orderId)
                .map(p => p.orderId)
            );

            // 3. Filter out the paid orders to get only pending collections, and apply search filter
            const pendingCollections = salesmanBilledCashOrders.filter(order => 
                !paidCashBillOrderIds.has(order.id) &&
                (order.customer.Customer || '').toLowerCase().includes(searchFilter)
            );
            
            if (pendingCollections.length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No pending cash collections found.</div>`;
                return;
            }

            // --- NEW, CORRECTED CODE ---
            container.innerHTML = pendingCollections.map(order => {
                // Use the authoritative finalBilledTotal saved during billing.
                // The '?? 0' handles any older orders that might not have this field yet.
                const totalToCollect = order.finalBilledTotal ?? 0;

                return `
                <div class="list-item">
                    <div class="info">
                        ${order.customer.Customer}
                        <div style="font-size: 0.9rem; color: #555; font-weight: 500; margin-top: 4px;">
                           Billed: ${formatDDMMYYYYTime(order.billedAt)}
                        </div>
                    </div>
                    <button class="list-item-action collect-cash-payment-btn" style="background-color: var(--danger-color);" data-order='${JSON.stringify(order)}' data-total="${totalToCollect}">
                        Collect ${formatCurrency(totalToCollect)}
                    </button>
                </div>`;
            }).join('');
        };
        
        const renderSalesmanItemSearchResults = (filter = '', resultsContainerId) => {
            const cont = document.getElementById(resultsContainerId);
            if (!filter) { cont.innerHTML = ''; return; }
            const lowerFilter = filter.toLowerCase();
            const filteredNames = appState.salesmanItems.filter(name => name.toLowerCase().includes(lowerFilter));
            const searchResults = filteredNames.map(name => appState.items.find(item => item.ItemName === name)).filter(Boolean);
            cont.innerHTML = searchResults.slice(0, 50).map(i => createSearchResultItemHTML(i)).join('');
        };
        const renderItemSearchResults = (filter = '', resultsContainerId, showDetails = true) => { 
            const cont = document.getElementById(resultsContainerId); 
            if (!filter) { cont.innerHTML = ''; return; }
            const nameFilter = item => (item.ItemName || '').toLowerCase().includes(filter.toLowerCase());
            cont.innerHTML = appState.items.filter(i => nameFilter(i)).slice(0, 50).map(i => createSearchResultItemHTML(i, showDetails)).join('');
        };

        const renderItemTiles = (itemsToDisplay) => {
            const container = document.getElementById('item-tiles-container');
            if (!itemsToDisplay || itemsToDisplay.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center; grid-column: 1 / -1;">No items found matching your search.</p>`;
                return;
            }
            
            const stockColor = (stock) => stock > 10 ? 'var(--success-color)' : (stock > 0 ? 'var(--warning-color)' : 'var(--danger-color)');
            const formatShortCurrency = (v) => `${Number(v).toFixed(2)}`;

            container.innerHTML = itemsToDisplay.map(item => `
                <div class="item-tile" data-item-code="${item.Code}">
                    <div class="item-tile-header">
                        <div class="item-name">${item.ItemName}</div>
                        <div class="item-info-tags"><span>MRP: ${formatPreciseCurrency(item.Mrp)}</span> | <span style="color: ${stockColor(item.Clstock)};">Stock: ${item.Clstock}</span></div>
                    </div>
                    <div class="item-controls">
                        <div class="control-cell"><button class="price-box active" data-price-type="p2">${formatShortCurrency(item.Price2)}</button><span class="control-label">P2</span></div>
                        <div class="control-cell"><button class="price-box" data-price-type="p3">${formatShortCurrency(item.Price3)}</button><span class="control-label">P3</span></div>
                        <div class="control-cell"><input type="number" class="control-input custom-price-input" placeholder="Price" min="0"><span class="control-label">Custom</span></div>
                        <div class="control-cell"><input type="number" class="control-input quantity-input" min="0.01" step="any"><span class="control-label">QTY</span></div>
                        <div class="control-cell"><button class="add-to-cart-btn">Add</button><span class="control-label">&nbsp;</span></div>
                    </div>
                </div>`).join('');
        };

        const renderPreviousItemsAsTiles = () => {
            const customerOrders = (appState.orders[appState.salesman] || []).filter(o => o.customer.Customer === appState.customer.Customer);
            if (customerOrders.length === 0) {
                document.getElementById('item-tiles-container').innerHTML = `<p class="card" style="text-align:center;">No previous items for this customer. Use search to find items.</p>`;
                return;}
            
            const uniqueItemCodes = new Set();
            customerOrders.forEach(order => { (order.items || []).forEach(item => uniqueItemCodes.add(item.item.Code)); });
            const previousItems = [...uniqueItemCodes].map(code => appState.items.find(i => i.Code == code)).filter(Boolean);
            renderItemTiles(previousItems);
        };

        const updateCartBadge = () => {
            const badge = document.getElementById('cart-item-count');
            const cart = getActiveCart();
            const count = cart.length;
            badge.style.display = count > 0 ? 'block' : 'none';
            badge.textContent = count;
        };

        const renderOrderSummaryPage = () => { 
            const listCont = document.getElementById('order-summary-list');
            const totalCont = document.getElementById('order-summary-grand-total'); 
            const cart = getActiveCart();
            let grandTotalRevenue = 0, grandTotalCost = 0;
            if (cart.length === 0) { listCont.innerHTML = '<p class="card" style="text-align:center;">Your cart is empty.</p>'; totalCont.style.display = 'none'; return; } 
            listCont.innerHTML = cart.map((o, idx) => { 
                const lineItemRevenue = o.quantity * o.sellingPrice; 
                const lineItemCost = o.quantity * (parseFloat(o.item.CostRate) || 0); 
                grandTotalRevenue += lineItemRevenue; 
                grandTotalCost += lineItemCost; 
                return `<div class="order-item-card">
                            <div class="item-primary-row">
                                <div class="item-name-group"><span class="item-serial-no">${idx + 1}.</span><div class="item-name">${o.item.ItemName}</div></div>
                                <div class="item-actions"><button class="item-action-btn delete-btn" data-index="${idx}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>
                            </div>
                            <div class="item-details-grid">
                                <div class="detail-item"><div class="label">Qty</div><div class="value">${o.quantity} ${o.item.Unit||""}</div></div>
                                <div class="detail-item"><div class="label">Price</div><div class="value">${formatPreciseCurrency(o.sellingPrice)}</div></div>
                                <div class="detail-item total"><div class="label">Total</div><div class="value">${formatPreciseCurrency(lineItemRevenue)}</div></div>
                            </div>
                        </div>`; 
            }).join(''); 
            let marginPercent = grandTotalCost > 0 ? ((grandTotalRevenue - grandTotalCost) / grandTotalCost) * 100 : 0;
            let marginBgColor = marginPercent >= 5 ? 'var(--success-color)' : marginPercent >= 4 ? 'var(--warning-color)' : 'var(--danger-color)';
            totalCont.innerHTML = `<span>Grand Total: ${formatPreciseCurrency(grandTotalRevenue)}</span><span class="total-margin-badge" style="background-color: ${marginBgColor};">${marginPercent.toFixed(2)}%</span>`;
            totalCont.style.display = 'flex'; 

            const saveUpdateBtn = document.getElementById('save-update-slip-btn');
            
            if(appState.editingPackingSlipId) {
                document.getElementById('order-summary-header').textContent = 'Edit SlipSummary';
                saveUpdateBtn.textContent = 'Save Packing Slip';
            }
        };

        const renderHistoryTabs = () => {
            const isPaymentHistory = document.getElementById('page-payment-history').classList.contains('active');
            const container = isPaymentHistory ? document.getElementById('payment-history-list') : document.getElementById('order-history-list');
            
            let historyData;
            if (isPaymentHistory) {
                historyData = appState.payments[appState.salesman] || [];
            } else {
                historyData = appState.orders[appState.salesman] || [];
            }
            
            const { start, end } = getReportDateRange();
            if (start && end) {
                historyData = historyData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= start && itemDate <= end;
                });
            }

            if (historyData.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center;">No history found for the selected dates.</p>`;
                return;
            }

            historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

            container.innerHTML = historyData.map((item) => {
                const isOrderType = !isPaymentHistory;
                const itemCount = isOrderType && item.items ? item.items.length : 0;
                
                let totalAmount = isOrderType ? item.total : item.amount;
                if (isOrderType && item.billType === 'cash' && item.freight) {
                    totalAmount += item.freight;
                }
                const totalText = isOrderType ? `<strong>Total:</strong> ${formatPreciseCurrency(totalAmount)} (${itemCount} items)` : `<strong>Amount:</strong> ${formatPreciseCurrency(item.amount)}`;
                const itemDetailsHtml = isOrderType ? (item.items || []).map(i => `<tr><td class="col-item-name">${i.item.ItemName}</td><td class="numeric">${i.quantity} ${i.item.Unit || ""}</td><td class="numeric">${formatPreciseCurrency(i.sellingPrice)}</td><td class="numeric"><strong>${formatPreciseCurrency(i.quantity * i.sellingPrice)}</strong></td></tr>`).join('') : '';

                let profitHtml = '';
                if (isOrderType && item.items) {
                    const itemsToCalc = item.billedItems || item.items;
                    const { totalRevenue, totalProfit } = itemsToCalc.reduce((acc, lineItem) => {
                        if (lineItem.wasUnchecked) return acc;
                        const revenue = (lineItem.quantity || 0) * (lineItem.sellingPrice || 0);
                        const itemCost = costMap.get(String(lineItem.item.Code)) || 0;
                        const cost = (lineItem.quantity || 0) * itemCost;
                        acc.totalRevenue += revenue;
                        acc.totalProfit += (revenue - cost);
                        return acc;
                    }, { totalRevenue: 0, totalProfit: 0 });

                    const margin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
                    const profitClass = totalProfit >= 0 ? 'profit' : 'loss';
                    profitHtml = `<p><strong>Profit:</strong> <span class="${profitClass}">${formatPreciseCurrency(totalProfit)} (${margin.toFixed(1)}%)</span></p>`;
                }
                
                const billTypeBadge = item.billType === 'cash' ? '<span class="bill-type-badge">Cash Bill</span>' : '';

                let actionsHtml = '';
                if (isPaymentHistory) {
                     actionsHtml = `<button class="history-action-btn delete-history-btn" data-type="payments" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                } else { // Packing Slips
                    const isBilled = item.status === 'billed';
                    const isLoaded = item.status === 'loaded';
                    const isDelivered = item.status === 'delivered';

                    let statusBadge = '';
                    if (isDelivered) {
                        statusBadge = `<span style="display:flex; align-items:center; gap: 5px; color: var(--delivery-accent);" title="This order has been Delivered."><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> Delivered</span>`;
                    }
                    else if (isLoaded) {
                        statusBadge = `<span style="display:flex; align-items:center; gap: 5px; color: #2980b9;" title="This order has been loaded."><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg> Loaded</span>`;
                    } else if (isBilled) {
                         statusBadge = `<span style="display:flex; align-items:center; gap: 5px; color: var(--success-color);" title="This order has been billed."><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> Billed</span>`;
                    }

                    if (isBilled || isLoaded || isDelivered) {
                         actionsHtml = `<button class="history-action-btn print-history-btn" title="Print Packing Slip"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button> ${statusBadge}`;
                    } else {
                         actionsHtml = `
                            <button class="history-action-btn edit-packing-slip-btn" title="Edit Slip"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="history-action-btn print-history-btn" title="Print Packing Slip"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>
                            <button class="history-action-btn delete-history-btn" data-type="orders" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                    }
                }
                
                return `<div class="history-card" data-id="${item.id}" data-type="${isPaymentHistory ? 'payments' : 'orders'}">
                            <div class="history-card-header">
                                <div class="info">
                                    <p><strong>Customer:</strong> ${item.customer.Customer} ${billTypeBadge}</p>
                                    <p>${totalText}</p>
                                    ${profitHtml}
                                    <p class="date-display">${formatDDMMYYYYTime(item.date)}</p>
                                </div>
                                <div class="actions">${actionsHtml}</div>
                            </div>
                            ${isOrderType ? `<div class="history-card-body" id="details-${item.id}"><div class="table-responsive-wrapper"><table class="history-item-table"><thead><tr><th class="col-item-name">Item</th><th class="numeric">Qty / Unit</th><th class="numeric">Price</th><th class="numeric">Total</th></tr></thead><tbody>${itemDetailsHtml}</tbody></table></div></div><a class="toggle-details" data-target="details-${item.id}">View Details</a>` : ""}
                        </div>`;
            }).join('');
        };
        
        const getReportDateRange = () => {
            const { startDate, endDate } = appState.reporting;
            if (!startDate && !endDate) return { start: null, end: null };

            let start, end;
            if (startDate) {
                start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
            } else {
                start = new Date(0);
            }

            if (endDate) {
                end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
            } else {
                end = new Date();
            }

            return { start, end };
        };

        const processAdminData = () => {
            const { start, end } = getReportDateRange();
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));
            
            let orders = Object.values(appState.orders).flat().filter(o => o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered');
            let payments = Object.values(appState.payments).flat();

            if (start && end) {
                orders = orders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
                payments = payments.filter(p => { const paymentDate = new Date(p.date); return paymentDate >= start && paymentDate <= end; });
            }
            
            let totalRevenue = 0, totalCost = 0, totalOrders = orders.length;
            const salesBySalesman = {};
            const itemsSold = {};
            const customerSet = new Set();

            orders.forEach(order => {
                customerSet.add(order.customer.Customer);
                const salesman = order.salesman || 'N/A';
                if (!salesBySalesman[salesman]) salesBySalesman[salesman] = { revenue: 0, cost: 0, orderCount: 0 };
                salesBySalesman[salesman].orderCount++;

                const itemsToProcess = order.billedItems || order.items;

                (itemsToProcess || []).forEach(item => {
                    if (item.wasUnchecked) return; 
                    const revenue = (item.quantity || 0) * (item.sellingPrice || 0);
                    const cost = (item.quantity || 0) * (costMap.get(String(item.item.Code)) || 0);
                    
                    totalRevenue += revenue; 
                    totalCost += cost;
                    salesBySalesman[salesman].revenue += revenue; 
                    salesBySalesman[salesman].cost += cost;

                    const itemName = item.item.ItemName;
                    if (!itemsSold[itemName]) itemsSold[itemName] = { quantity: 0, revenue: 0 };
                    itemsSold[itemName].quantity += (item.quantity || 0);
                    itemsSold[itemName].revenue += revenue;
                });
            });
            
            const collectionsBySalesman = {};
            let grandTotalCash = 0, grandTotalUPI = 0;
            payments.forEach(p => {
                const salesman = p.salesman || 'N/A';
                if (!collectionsBySalesman[salesman]) collectionsBySalesman[salesman] = { cash: 0, upi: 0 };
                if (p.method === 'Cash') { collectionsBySalesman[salesman].cash += p.amount; grandTotalCash += p.amount; }
                else if (p.method === 'UPI') { collectionsBySalesman[salesman].upi += p.amount; grandTotalUPI += p.amount; }
            });

            return { totalRevenue, totalProfit: totalRevenue - totalCost, totalOrders, uniqueCustomers: customerSet.size, salesBySalesman, itemsSold: Object.entries(itemsSold).sort((a, b) => b.revenue - a.revenue), collectionsBySalesman, grandTotalCash, grandTotalUPI };
        };
        const renderAdminDashboard = () => {
            const dashboardContent = document.getElementById("admin-dashboard-content");
            const data = processAdminData();
            
            const riyasCollection = (data.collectionsBySalesman['RIYAS']?.cash || 0) + (data.collectionsBySalesman['RIYAS']?.upi || 0);
            const unniCollection = (data.collectionsBySalesman['UNNI']?.cash || 0) + (data.collectionsBySalesman['UNNI']?.upi || 0);
            const overallMargin = data.totalRevenue > 0 ? (data.totalProfit / data.totalRevenue) * 100 : 0;

            const kpiItems = [
                { title: 'Total Sales', value: formatPreciseCurrency(data.totalRevenue) },
                { title: 'RIYAS Sales', value: formatPreciseCurrency(data.salesBySalesman['RIYAS']?.revenue || 0) },
                { title: 'RIYAS Collection', value: formatPreciseCurrency(riyasCollection) },
                { title: 'UNNI Sales', value: formatPreciseCurrency(data.salesBySalesman['UNNI']?.revenue || 0) },
                { title: 'UNNI Collection', value: formatPreciseCurrency(unniCollection) },
                { title: 'Overall Profit', value: formatPreciseCurrency(data.totalProfit), class: data.totalProfit >= 0 ? 'profit' : 'loss'},
                { title: 'Overall Margin', value: `${overallMargin.toFixed(1)}%`, class: overallMargin >= 0 ? 'profit' : 'loss' },
                { title: 'Unique Customers', value: data.uniqueCustomers }
            ];

            const kpiListHtml = kpiItems.map(item => `
                <li class="data-list-item" style="cursor:default;">
                    <div class="item-main">${item.title}</div>
                    <div class="item-details"><span class="value-primary ${item.class || ''}">${item.value}</span></div>
                </li>
            `).join('');
            
            const kpiCardHtml = `<div class="data-list-card"><h3>Key Performance Indicators</h3><ul class="data-list-container" style="max-height: none;">${kpiListHtml}</ul></div>`;

            const salesListHtml = Object.entries(data.salesBySalesman).sort((a, b) => b.revenue - a.revenue).map(([salesman, d]) => { const profit = d.revenue - d.cost; const margin = d.revenue > 0 ? profit / d.revenue * 100 : 0; return `<li class="data-list-item" data-salesman="${salesman}"><div class="item-main">${salesman}</div><div class="item-details"><span class="value-primary">${formatPreciseCurrency(d.revenue)}</span><span class="value-secondary"><span class="${profit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(profit)} (${margin.toFixed(1)}%)</span></span></div></li>` }).join("") || '<li style="padding: 15px 5px; text-align: center; color: #6c757d;">No sales data available.</li>';
            const itemsSoldHtml = data.itemsSold.map(([name, d]) => `<li class="data-list-item" style="cursor:default;"><div class="item-main">${name}</div><div class="item-details"><span class="value-primary">${formatPreciseCurrency(d.revenue)}</span><span class="value-secondary">Qty: ${d.quantity.toFixed(2)}</span></div></li>`).join("") || '<li style="padding: 15px 5px; text-align: center; color: #6c757d;">No item data available.</li>';
            const totalCollections = data.grandTotalCash + data.grandTotalUPI;
            const collectionsBreakdownHtml = Object.entries(data.collectionsBySalesman).map(([salesman, d]) => `<div class="salesman-header">${salesman}</div><ul class="salesman-breakdown"><li><span>Cash</span> <span>${formatPreciseCurrency(d.cash)}</span></li><li><span>UPI</span> <span>${formatPreciseCurrency(d.upi)}</span></li><li><span>Sub-Total</span> <span>${formatPreciseCurrency(d.cash + d.upi)}</span></li></ul>`).join("");
            const collectionsHtml = Object.keys(data.collectionsBySalesman).length > 0 ? collectionsBreakdownHtml : '<li style="padding: 15px 5px; text-align: center; color: #6c757d;">No collections in this period.</li>';

            const grid = dashboardContent.querySelector('.dashboard-grid');
            if (grid) grid.remove();
            
            dashboardContent.innerHTML = `<div class="dashboard-grid">
                ${kpiCardHtml}
                <div class="data-list-card"><h3>Sales By Salesman</h3><ul class="data-list-container">${salesListHtml}</ul></div>
                <div class="data-list-card"><h3>Items Sold</h3><ul class="data-list-container">${itemsSoldHtml}</ul></div>
                <div class="data-list-card"><h3>Collections</h3><ul class="payment-summary-list"><li><span>Total Cash</span><strong>${formatPreciseCurrency(data.grandTotalCash)}</strong></li><li><span>Total UPI</span><strong>${formatPreciseCurrency(data.grandTotalUPI)}</strong></li><li style="font-size: 1.1rem;"><span>Grand Total</span><strong>${formatPreciseCurrency(totalCollections)}</strong></li>${collectionsHtml}</ul></div>
                <div class="data-list-card"><h3>Advanced Reports</h3><button class="button button-outline" id="location-report-btn" style="margin-bottom: 10px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Location Report</button><button class="button button-outline" id="crm-module-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>Send Bulk Offer</button></div>
            </div>`;
        };
        
        const renderLocationReportPage = () => { 
            const contentEl = document.getElementById('location-report-content');
            const allSalesmen = ['UNNI', 'RIYAS'];
            const dateFilterHtml = `<div id="location-report-date-filter" class="between-date-filter"><input type="date" class="date-input start-date-input"><button class="date-btn start-date-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="date-label">Start Date</span></button><input type="date" class="date-input end-date-input"><button class="date-btn end-date-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="date-label">End Date</span></button><button class="filter-action-btn clear-btn">Clear</button></div>`;

            const { start, end } = getReportDateRange();
            let filteredOrders = Object.values(appState.orders).flat();
            if (start && end) {
                filteredOrders = filteredOrders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
            }

            let summaryHtml = '<div class="card"><h3>Last Activity Summary</h3><div id="location-summary-list">';
            allSalesmen.forEach(salesman => {
                const lastOrder = filteredOrders.filter(o => o.salesman === salesman && o.location).sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                if (lastOrder) {
                    summaryHtml += `<div class="list-item"><div class="info"><strong style="color: var(--primary-color); font-size: 1.1rem;">${salesman}</strong><p><strong>Last Order:</strong> ${lastOrder.customer.Customer} (${formatPreciseCurrency(lastOrder.total)})</p><p><strong>Time:</strong> ${formatDDMMYYYYTime(lastOrder.date)}</p></div><a href="https://www.google.com/maps?q=${lastOrder.location.lat},${lastOrder.location.lng}" target="_blank" class="button button-outline" style="width: auto; padding: 8px 15px; font-size: 0.9rem;">View Last Location</a></div>`;
                } else {
                    summaryHtml += `<div class="list-item"><strong style="color: var(--primary-color); font-size: 1.1rem;">${salesman}</strong><span>No location data found for this period.</span></div>`;
                }
            });
            summaryHtml += '</div></div>';

            const allOrdersWithLocation = filteredOrders.filter(o => o.location).sort((a, b) => new Date(b.date) - new Date(a.date));
            let detailsHtml = '<div class="card" style="margin-top: 20px;"><h3>Detailed Location Log</h3><div id="location-details-list">';
            if (allOrdersWithLocation.length > 0) {
                detailsHtml += allOrdersWithLocation.map(order => `<div class="list-item"><div class="info"><strong>${order.customer.Customer}</strong><br><small>${order.salesman} - ${formatDDMMYYYYTime(order.date)}</small></div><a href="https://www.google.com/maps?q=${order.location.lat},${order.location.lng}" target="_blank" class="list-item-action">View Map</a></div>`).join('');
            } else {
                detailsHtml += '<p style="text-align: center; padding: 20px;">No orders with location data found for this period.</p>';
            }
            detailsHtml += '</div></div>';
            contentEl.innerHTML = dateFilterHtml + summaryHtml + detailsHtml;
            setupBetweenDateFilter('location-report-date-filter', renderLocationReportPage);
            showPage('page-location-report');
        };
        
        const renderSalesmanReport = (salesman) => {
            appState.reporting.salesman = salesman;
            document.getElementById("salesman-report-header").textContent = `${salesman}'s Report`;
            const contentEl = document.getElementById("salesman-report-content");
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

            const { start, end } = getReportDateRange();
            let salesmanOrders = (appState.orders[salesman] || []).filter(o => o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered');

            if (start && end) {
                salesmanOrders = salesmanOrders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
            }
            const totalOrders = salesmanOrders.length;

            const customerSales = {};
            let totalRevenue = 0, totalProfit = 0;

            salesmanOrders.forEach(order => {
                const customerName = order.customer.Customer || "Unknown";
                if (!customerSales[customerName]) customerSales[customerName] = { revenue: 0, profit: 0, orderCount: 0 };
                customerSales[customerName].orderCount++;
                
                const itemsToProcess = order.billedItems || order.items;

                (itemsToProcess || []).forEach(item => {
                     if (item.wasUnchecked) return;
                    const revenue = (item.quantity || 0) * (item.sellingPrice || 0);
                    const cost = (item.quantity || 0) * (costMap.get(String(item.item.Code)) || 0);
                    const profit = revenue - cost;

                    customerSales[customerName].revenue += revenue;
                    customerSales[customerName].profit += profit;
                    totalRevenue += revenue;
                    totalProfit += profit;
                });
            });

            const customerListHtml = Object.entries(customerSales).sort((a, b) => b.revenue - a.revenue).map(([customerName, data]) => `<li class="data-list-item" data-customer="${customerName}"><div class="item-main">${customerName}</div><div class="item-details"><span class="value-primary">${formatPreciseCurrency(data.revenue)}</span><span class="value-secondary"><span class="${data.profit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(data.profit)} (${(data.revenue > 0 ? (data.profit / data.revenue) * 100 : 0).toFixed(1)}%)</span></span></div></li>`).join('');
            const overallMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            
            contentEl.innerHTML = `
                <div class="report-header-card">
                    <div><div class="label">Total Revenue</div><div class="value">${formatPreciseCurrency(totalRevenue)}</div></div>
                    <div><div class="label">Total Orders</div><div class="value">${totalOrders}</div></div>
                    <div><div class="label">Total Profit</div><div class="value ${totalProfit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(totalProfit)}</div></div>
                    <div><div class="label">Profit Margin</div><div class="value ${overallMargin >= 0 ? "profit" : "loss"}">${overallMargin.toFixed(1)}%</div></div>
                </div>
                <div class="data-list-card">
                    <h3>Sales by Customer</h3>
                    <ul class="data-list-container">${customerListHtml || '<li style="text-align:center;padding:20px;">No customers found.</li>'}</ul>
                </div>`;
            showPage("page-salesman-report");
        };

        const renderCustomerReport = (salesman, customerName) => {
            appState.reporting.customer = customerName;
            document.getElementById("customer-report-header").textContent = `${customerName}`;
            const contentEl = document.getElementById("customer-report-content");
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

            const { start, end } = getReportDateRange();
            let customerOrders = (appState.orders[salesman] || []).filter(o => o.customer.Customer === customerName && (o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered'));
            if (start && end) {
                customerOrders = customerOrders.filter(o => { const orderDate = new Date(o.date); return orderDate >= start && orderDate <= end; });
            }

            const itemsSold = {};
            customerOrders.forEach(order => {
                const itemsToProcess = order.billedItems || order.items;
                (itemsToProcess || []).forEach(item => {
                    if(item.wasUnchecked) return;
                    const itemName = item.item.ItemName;
                    const itemCode = String(item.item.Code);
                    if (!itemsSold[itemName]) itemsSold[itemName] = { quantity: 0, revenue: 0, cost: 0, unit: item.item.Unit };
                    itemsSold[itemName].quantity += (item.quantity || 0);
                    itemsSold[itemName].revenue += (item.quantity || 0) * (item.sellingPrice || 0);
                    itemsSold[itemName].cost += (item.quantity || 0) * (costMap.get(itemCode) || 0);
                });
            });

            let totalRevenue = 0, totalProfit = 0;
            Object.values(itemsSold).forEach(data => { totalRevenue += data.revenue; totalProfit += data.revenue - data.cost; });
            const overallMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            const itemsTableHtml = Object.entries(itemsSold).sort((a, b) => b.revenue - a.revenue).map(([itemName, data]) => { const profit = data.revenue - data.cost; const margin = data.revenue > 0 ? (profit / data.revenue) * 100 : 0; return `<tr><td>${itemName}</td><td class="numeric">${data.quantity} ${data.unit || ""}</td><td class="numeric">${formatPreciseCurrency(data.revenue)}</td><td class="numeric ${profit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(profit)}</td><td class="numeric ${margin >= 0 ? "profit" : "loss"}">${margin.toFixed(1)}%</td></tr>`; }).join('');

            contentEl.innerHTML = `<div class="report-header-card"><div><div class="label">Total Revenue</div><div class="value">${formatPreciseCurrency(totalRevenue)}</div></div><div><div class="label">Total Profit</div><div class="value ${totalProfit >= 0 ? "profit" : "loss"}">${formatPreciseCurrency(totalProfit)}</div></div><div><div class="label">Profit Margin</div><div class="value ${overallMargin >= 0 ? "profit" : "loss"}">${overallMargin.toFixed(1)}%</div></div></div><div class="card"><div class="table-responsive-wrapper"><table class="report-table"><thead><tr><th>Product</th><th class="numeric">Qty / Unit</th><th class="numeric">Revenue</th><th class="numeric">Profit</th><th class="numeric">Margin %</th></tr></thead><tbody>${itemsTableHtml}</tbody></table></div></div>`;
            showPage("page-customer-report");
        };

        document.getElementById('admin-dashboard-content').addEventListener('click', e => { 
            const salesmanBtn = e.target.closest('.data-list-item[data-salesman]'); 
            if (salesmanBtn) { renderSalesmanReport(salesmanBtn.dataset.salesman); return; }
            const crmBtn = e.target.closest('#crm-module-btn');
            if (crmBtn) { renderCrmModule(); showPage('page-crm'); }
            const locationBtn = e.target.closest('#location-report-btn');
            if (locationBtn) { renderLocationReportPage(); }
        });

        document.getElementById('salesman-report-content').addEventListener('click', e => { const t = e.target.closest('.data-list-item[data-customer]'); t && renderCustomerReport(appState.reporting.salesman, t.dataset.customer) });
        document.getElementById('back-to-admin-dashboard-btn').addEventListener('click', () => { showPage('page-admin-dashboard'); document.getElementById('admin-dashboard-view').style.display = 'block'; });
        document.getElementById('back-to-salesman-report-btn').addEventListener('click', () => showPage('page-salesman-report'));
        document.getElementById('back-to-admin-from-location-btn').addEventListener('click', () => { showPage('page-admin-dashboard'); document.getElementById('admin-dashboard-view').style.display = 'block'; });
        const renderCustomerProfile = () => { 
            const c = appState.customer; 
            document.getElementById('customer-profile-name').textContent = c.Customer; 
            const content = document.getElementById('customer-profile-content'); 
            content.innerHTML = `
                <div class="card">
                    <p><strong>Name:</strong> ${c.Customer||'N/A'}</p>
                    <p><strong>Phone:</strong> ${c.Phone||'N/A'}</p>
                    <p><strong>Route:</strong> ${c.Route||'N/A'}</p>
                    <p><strong>Assigned Salesman:</strong> ${c.Salesman||'N/A'}</p>
                    <p><strong>Outstanding Balance:</strong> <span style="font-weight: bold; color: var(--danger-color);">${formatCurrency(c.Outstanding || 0)}</span></p>
                </div>`; 
            showPage('page-customer-profile'); 
        };

        const renderCustomerLedger = () => {
            const c = appState.customer;
            document.getElementById('customer-ledger-name').textContent = `Ledger for ${c.Customer}`;
            const container = document.getElementById('customer-ledger-content');
            
            const customerSales = (appState.orders[appState.salesman] || [])
                .filter(o => o.customer.Customer === c.Customer && (o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered'));

            const customerCollections = (appState.payments[appState.salesman] || [])
                .filter(p => p.customer.Customer === c.Customer);

            const salesTransactions = customerSales.map(s => {
                const finalTotal = (s.billedItems || s.items || []).reduce((acc, item) => {
                    return item.wasUnchecked ? acc : acc + (item.quantity * item.sellingPrice);
                }, 0);
                return {
                    date: new Date(s.date),
                    type: 'Sale',
                    debit: finalTotal,
                    credit: 0,
                    id: s.id,
                    order: s 
                };
            });

            const collectionTransactions = customerCollections.map(p => ({
                date: new Date(p.date),
                type: `Collection (${p.method})`,
                debit: 0,
                credit: p.amount,
                id: p.id
            }));
            const allTransactions = [...salesTransactions, ...collectionTransactions].sort((a, b) => b.date - a.date);

            let transactionRows = '';
            allTransactions.forEach(t => {
                if (t.type === 'Sale') {
                    const itemsHtml = (t.order.billedItems || t.order.items || [])
                        .filter(i => !i.wasUnchecked)
                        .map(i => `<li><span class="ledger-item-name">${i.item.ItemName}</span> <span class="ledger-item-qty">${i.quantity} x ${formatPreciseCurrency(i.sellingPrice)}</span></li>`)
                        .join('');

                    transactionRows += `
                        <tr class="ledger-sale-row" data-target-id="details-${t.id}">
                            <td>${formatDDMMYYYY(t.date)}</td>
                            <td>${t.type}</td>
                            <td class="numeric">${formatPreciseCurrency(t.debit)}</td>
                            <td class="numeric">-</td>
                        </tr>
                        <tr class="ledger-details-row" id="details-${t.id}">
                            <td colspan="4" class="ledger-details-cell">
                                <div class="ledger-details-header">
                                    <h4>Sale Details</h4>
                                    <button class="icon-button print-sale-bill-btn" data-order-id="${t.id}" style="color:var(--primary-color);">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                    </button>
                                </div>
                                <ul class="ledger-item-list">${itemsHtml}</ul>
                            </td>
                        </tr>
                    `;
                } else {
                    transactionRows += `
                        <tr>
                            <td>${formatDDMMYYYY(t.date)}</td>
                            <td>${t.type}</td>
                            <td class="numeric">-</td>
                            <td class="numeric">${formatPreciseCurrency(t.credit)}</td>
                        </tr>
                    `;
                }
            });

            container.innerHTML = `
                <div class="card">
                     <div class="report-header-card">
                        <div>
                            <div class="label">Current Balance</div>
                            <div class="value" style="color: ${c.Outstanding > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">
                                ${formatCurrency(c.Outstanding || 0)}
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive-wrapper"><table class="report-table ledger-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Particulars</th>
                                <th class="numeric">Debit ()</th>
                                <th class="numeric">Credit ()</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactionRows || `<tr><td colspan="4" style="text-align:center; padding: 20px;">No transactions found.</td></tr>`}
                        </tbody>
                    </table></div>
                </div>`;
            showPage('page-customer-ledger');
        };

        const printSaleBill = (orderId) => {
            const orderToPrint = Object.values(appState.orders).flat().find(o => o.id === orderId);
            if (!orderToPrint) { alert('Could not find order to print.'); return; }

            const itemsToPrint = (orderToPrint.billedItems || orderToPrint.items || []).filter(item => !item.wasUnchecked);
            const finalTotal = itemsToPrint.reduce((acc, item) => acc + (item.quantity * item.sellingPrice), 0);
            
            const ITEMS_PER_PAGE = 25; 
            const pages = [];
            for (let i = 0; i < itemsToPrint.length; i += ITEMS_PER_PAGE) {
                pages.push(itemsToPrint.slice(i, i + ITEMS_PER_PAGE));
            }

            let billHtml = '';
            pages.forEach((pageItems, pageIndex) => {
                const pageClass = pageIndex > 0 ? 'bill-page-break' : '';
                const tableBodyHtml = pageItems.map((item, itemIndex) => { 
                    const serialNumber = (pageIndex * ITEMS_PER_PAGE) + itemIndex + 1;
                    const total = item.quantity * item.sellingPrice;
                    return `<tr>
                                <td>${serialNumber}</td>
                                <td class="col-item-name">${item.item.ItemName}</td>
                                <td class="col-mrp">${formatPreciseCurrency(item.item.Mrp)}</td>
                                <td class="col-qty">${item.quantity} ${item.item.Unit || ''}</td>
                                <td class="col-price">${formatPreciseCurrency(item.sellingPrice)}</td>
                                <td class="col-total">${formatPreciseCurrency(total)}</td>
                            </tr>`; 
                }).join('');

                const footerHtml = pageIndex === pages.length - 1 
                    ? `<div class="bill-footer">
                           <div><strong>Grand Total: ${formatPreciseCurrency(finalTotal)}</strong></div>
                       </div>` 
                    : '';

                billHtml += `<div class="${pageClass}">
                                <div class="bill-header"><h2>MF BIGMARKET</h2><p>Sale Bill</p></div>
                                <div class="bill-details">
                                    <div><strong>Customer:</strong> ${orderToPrint.customer.Customer}<br><strong>Salesman:</strong> ${orderToPrint.salesman}</div>
                                    <div style="text-align: right;"><strong>Bill No:</strong> ${orderToPrint.id.slice(-6).toUpperCase()}<br><strong>Date:</strong> ${formatDDMMYYYY(orderToPrint.date)}</div>
                                </div>
                                <div class="slip-page-number">Page ${pageIndex + 1} of ${pages.length}</div>
                                <table class="bill-table">
                                    <thead>
                                        <tr>
                                            <th>S.No.</th>
                                            <th class="col-item-name">ITEM</th>
                                            <th class="col-mrp">MRP</th>
                                            <th class="col-qty">QTY</th>
                                            <th class="col-price">RATE</th>
                                            <th class="col-total">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody>${tableBodyHtml}</tbody>
                                </table>
                                ${footerHtml}
                            </div>`;
            });
            document.getElementById('sale-bill-content').innerHTML = billHtml; 
            document.body.classList.add('printing', 'printing-sale-bill'); 
            setTimeout(() => window.print(), 100);
        };
        
        document.getElementById('customer-ledger-content').addEventListener('click', e => {
            const saleRow = e.target.closest('.ledger-sale-row');
            if (saleRow) {
                const targetId = saleRow.dataset.targetId;
                const detailsRow = document.getElementById(targetId);
                if (detailsRow) {
                    detailsRow.classList.toggle('visible');
                }
            }
            
            const printBtn = e.target.closest('.print-sale-bill-btn');
            if (printBtn) {
                const orderId = printBtn.dataset.orderId;
                printSaleBill(orderId);
            }
        });
        
        const openModalBtn = document.getElementById('open-role-modal');
        const roleModal = document.getElementById('role-modal');

        openModalBtn.addEventListener('click', () => {
            roleModal.classList.add('active');
        });

        roleModal.addEventListener('click', (e) => {
            if (e.target === roleModal) {
                roleModal.classList.remove('active');
            }
        });

                // REPLACEMENT for the entire role selection click listener
        roleModal.querySelector('.role-grid').addEventListener('click', (e) => {
            const roleTile = e.target.closest('.role-tile');
            if (!roleTile || roleTile.classList.contains('dummy')) return;

            const selectedRole = roleTile.dataset.role;
            
            // The list of roles that require a password
            const protectedRoles = ['ADMIN', 'HR', 'FASAL'];

            if (protectedRoles.includes(selectedRole)) {
                // For protected roles, store the role and open the password modal
                appState.pendingRole = selectedRole;
                openPasswordModal(selectedRole);
            } else {
                // For all other roles, log in directly as before
                proceedWithLogin(selectedRole);
            }
        });

        const openPasswordModal = (role) => {
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const errorMessage = document.getElementById('password-error-message');

            document.getElementById('password-modal-title').textContent = `Enter Password for ${role}`;
            passwordInput.value = '';
            errorMessage.style.display = 'none'; // Hide any previous errors
            modal.classList.add('active');
            setTimeout(() => passwordInput.focus(), 100); // Focus after transition
        };

        const handlePasswordSubmit = () => {
            const passwordInput = document.getElementById('password-input');
            const errorMessage = document.getElementById('password-error-message');
            const enteredPassword = passwordInput.value;
            const role = appState.pendingRole;

            const correctPasswords = {
                ADMIN: 'ADMIN456',
                HR: '1234',
                FASAL: '1788'
            };

            if (enteredPassword === correctPasswords[role]) {
                errorMessage.style.display = 'none';
                document.getElementById('password-modal').classList.remove('active');
                proceedWithLogin(role); // Password is correct, proceed
            } else {
                errorMessage.style.display = 'block'; // Show error
                passwordInput.value = ''; // Clear input
                passwordInput.focus();
            }
        };

        // This new function contains the logic to actually switch to a user's page
        const proceedWithLogin = (salesman) => {
            roleModal.classList.remove('active');
            appState.salesman = salesman;
            localStorage.setItem('lastSalesman', salesman);
            const { startDate, endDate } = getDefaultDateRange();
            appState.reporting.startDate = startDate;
            appState.reporting.endDate = endDate;

            updateUserStatus('idle');

            // This is the original logic from the old click listener
            if (salesman === 'ADMIN') { 
                document.getElementById('admin-footer').style.display = 'flex'; 
                document.getElementById('settings-icon-btn').style.display = 'flex';
                showPage('page-admin-dashboard'); 
                renderAdminDashboard();
            } else if (salesman === 'SUNNY') {
                document.getElementById('footer').style.display = 'none';
                showPage('page-packer-home'); 
                renderPackerHome();
            } else if (appState.packerAssistants.includes(salesman)) {
                document.getElementById('footer').style.display = 'none';
                showPage('page-packer-assistant');
                renderPackerAssistantHome();
            } else if (salesman === 'FASAL') {
                document.getElementById('footer').style.display = 'flex';
                showPage('page-purchase-planner');
                renderPurchasePlanner();
            } else if (salesman === 'HR') {
                document.getElementById('footer').style.display = 'none';
                showPage('page-hr');
                renderHRPage();
            } else if (salesman === 'ARFATH') { // Role Swap: ARFATH is Biller
                document.getElementById('footer').style.display = 'none';
                showPage('page-biller-home'); 
                renderBillerHome();
            } else if (salesman === 'SHAJU') {
                document.getElementById('footer').style.display = 'none';
                showPage('page-loader-home');
                renderLoaderHome();
            } else if (salesman === 'NANDU') {
                document.getElementById('footer').style.display = 'flex';
                showPage('page-accountant-dashboard');
                renderAccountantView();
            } else if (salesman === 'BENNY') {
                document.getElementById('footer').style.display = 'none';
                showPage('page-delivery-home');
                renderDeliveryHome();
            } else { // Salesmen (UNNI, RIYAS)
                document.getElementById('footer').style.display = 'flex'; 
                document.getElementById('admin-footer').style.display = 'none';
                document.getElementById('settings-icon-btn').style.display = 'none';
                document.getElementById('billed-orders-btn').style.display = 'flex';
                appState.currentView = 'customers';
                document.querySelectorAll('#footer .footer-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('orders-tab-btn').classList.add('active'); 
                showPage('page-main-view'); 
                renderCurrentView();
            }
        };

        // Add event listeners for the new password modal buttons
        document.getElementById('password-submit-btn').addEventListener('click', handlePasswordSubmit);
        document.getElementById('password-cancel-btn').addEventListener('click', () => {
            document.getElementById('password-modal').classList.remove('active');
        });
        document.getElementById('password-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handlePasswordSubmit();
            }
        });

        const handleLogout = () => { 
            updateUserStatus('idle');
            appState.salesman = null; 
            localStorage.removeItem('lastSalesman'); 
            appState.customerCarts = {}; 
            showPage('page-login'); 
        };

        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('packer-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('packer-assistant-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('purchase-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('accountant-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('biller-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('loader-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('delivery-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('hr-logout-btn').addEventListener('click', handleLogout);
        
        const customerView = document.getElementById('customer-view');
        const paymentView = document.getElementById('payment-view');
        const cashBillView = document.getElementById('cash-bill-view');
        const cashBillCollectionView = document.getElementById('cash-bill-collection-view');
        const mainHeader = document.getElementById('main-view-header');
        const productInfoBtn = document.getElementById('product-info-icon-btn');
        const pendingBalanceBtn = document.getElementById('pending-balance-btn');

        const renderCurrentView = () => {
             if (!appState.salesman || ['ADMIN', 'SUNNY', 'ARFATH', 'NANDU', 'SHAJU', 'BENNY', 'FASAL', 'HR', ...appState.packerAssistants].includes(appState.salesman)) return; 
             
            customerView.style.display = 'none';
            paymentView.style.display = 'none';
            cashBillView.style.display = 'none';
            cashBillCollectionView.style.display = 'none';

             if (appState.currentView === 'customers') { 
                 mainHeader.textContent = 'Customers';
                 productInfoBtn.style.display = 'flex';
                 pendingBalanceBtn.style.display = 'none';
                 document.getElementById('billed-orders-btn').style.display = 'flex';
                 customerView.style.display = 'block';
                 renderCustomerList(); 
            } else if (appState.currentView === 'payments') {
                mainHeader.textContent = 'Credit Payments'; 
                productInfoBtn.style.display = 'none';
                pendingBalanceBtn.style.display = 'flex';
                document.getElementById('billed-orders-btn').style.display = 'none';
                paymentView.style.display = 'block';
                renderPaymentCustomerList();
             } else if (appState.currentView === 'cashBill') {
                mainHeader.textContent = 'Cash Bill';
                productInfoBtn.style.display = 'flex';
                pendingBalanceBtn.style.display = 'none';
                document.getElementById('billed-orders-btn').style.display = 'none';
                cashBillView.style.display = 'block';
                renderCashBillView();
            } else if (appState.currentView === 'cashBillCollection') {
                mainHeader.textContent = 'Cash Collection';
                productInfoBtn.style.display = 'none';
                pendingBalanceBtn.style.display = 'none';
                document.getElementById('billed-orders-btn').style.display = 'none';
                cashBillCollectionView.style.display = 'block';
                renderCashBillCollectionView();
            }
        };
        
        document.getElementById('customer-search-input').addEventListener('input', () => renderCustomerList());
        document.getElementById('customer-route-filter').addEventListener('change', () => renderCustomerList());
        document.getElementById('payment-customer-search-input').addEventListener('input', () => renderPaymentCustomerList());
        document.getElementById('payment-route-filter').addEventListener('change', () => renderPaymentCustomerList());
                // NEW: Event listeners for the Cash Bill tab
        document.getElementById('cash-bill-customer-search-input').addEventListener('input', renderCashBillView);
        document.getElementById('cash-bill-customer-list-container').addEventListener('click', async (e) => {
            const orderBtn = e.target.closest('.take-cash-order-btn');
            if (orderBtn) {
                appState.currentOrderType = 'cash';
                const container = orderBtn.closest('.cash-bill-item');
                appState.customer = JSON.parse(container.dataset.customer);

                orderBtn.disabled = true;
                try {
                    const location = await getCurrentLocation();
                    appState.currentOrderLocation = location;
                    appState.currentOrderStartTime = new Date().toISOString();
                    updateUserStatus('active', `Cash Bill for ${appState.customer.Customer}`);
                    
                    document.getElementById('order-customer-name').textContent = `Cash Bill: ${appState.customer.Customer}`;
                    
                    // Hide search bars for cash bills and preload items
                    document.getElementById('credit-bill-search-container').style.display = 'none';
                    const cashItemsFull = appState.cashOnlyItems.map(code => appState.items.find(i => String(i.Code) === String(code))).filter(Boolean);
                    renderItemTiles(cashItemsFull);

                    updateCartBadge();
                    showPage('page-order');
                } catch (error) {
                    alert(`Could not start order. Location is required.\n\nError: ${error.message}`);
                } finally {
                    orderBtn.disabled = false;
                }
            }
        });

        // NEW: Event listeners for the Cash Bill Collection tab
        document.getElementById('cash-collection-customer-search-input').addEventListener('input', renderCashBillCollectionView);
        document.getElementById('cash-bill-collection-list-container').addEventListener('click', e => {
            const collectBtn = e.target.closest('.collect-cash-payment-btn');
            if (collectBtn) {
                const order = JSON.parse(collectBtn.dataset.order);
                const totalAmount = parseFloat(collectBtn.dataset.total);

                appState.currentPayment = {
                    customer: order.customer,
                    paymentType: 'cash_bill',
                    orderId: order.id,
                    amount: totalAmount // Store the amount for receipt generation
                };

                document.getElementById('payment-customer-name').textContent = `Cash Collection for ${order.customer.Customer}`;
                document.getElementById('payment-amount').value = totalAmount.toFixed(2);
                document.getElementById('confirm-payment-btn').style.display = 'block';
                document.getElementById('payment-actions-container').style.display = 'none';
                showPage('page-payment');
            }
        });

        document.getElementById('footer').addEventListener('click', e => {
            const current = e.target.closest('.footer-button');
            if (!current) return;

            document.querySelectorAll('.footer-button').forEach(b => b.classList.remove('active'));
            current.classList.add('active');

            const viewMap = {
                'orders-tab-btn': 'customers',
                'payments-tab-btn': 'payments',
                'cash-bill-tab-btn': 'cashBill',
                'cash-collection-tab-btn': 'cashBillCollection'
            };
            appState.currentView = viewMap[current.id];
            renderCurrentView();
        });
        
        document.getElementById('history-icon-btn').addEventListener('click', () => {
            const isOrder = ['customers', 'cashBill', 'cashBillCollection'].includes(appState.currentView);
            const pageId = isOrder ? 'page-order-history' : 'page-payment-history';
            showPage(pageId);
            renderHistoryTabs();
        });
        
        document.getElementById('product-info-icon-btn').addEventListener('click', () => showPage('page-product-info'));
        document.getElementById('pending-balance-btn').addEventListener('click', () => {
            renderOutstandingBalancesPage();
            showPage('page-outstanding-balances');
        });

        document.getElementById('back-to-main-from-info-btn').addEventListener('click', () => showPage('page-main-view'));
        document.getElementById('back-to-main-from-outstanding-btn').addEventListener('click', () => showPage('page-main-view'));

        document.getElementById('customer-list-container').addEventListener('click', async (e) => {
            const header = e.target.closest('.customer-item-header');
            const actionButton = e.target.closest('.action-button');
            if (header) { const container = header.closest('.customer-item-container'); document.querySelectorAll('.customer-item-container.expanded').forEach(item => { if (item !== container) item.classList.remove('expanded'); }); container.classList.toggle('expanded'); }
            if (actionButton) {
                const container = actionButton.closest('.customer-item-container');
                appState.customer = JSON.parse(container.dataset.customer);
                const action = actionButton.dataset.action;

                if (action === 'order') {
                    appState.currentOrderType = 'credit';
                    actionButton.disabled = true; 
                    try {
                        const location = await getCurrentLocation();
                        appState.currentOrderLocation = location;
                        appState.currentOrderStartTime = new Date().toISOString(); 
                        updateUserStatus('active', `Ordering for ${appState.customer.Customer}`);
                        document.getElementById('order-customer-name').textContent = `New Order: ${appState.customer.Customer}`; 
                        document.getElementById('credit-bill-search-container').style.display = 'block';
                        updateCartBadge(); renderPreviousItemsAsTiles(); showPage('page-order');
                    } catch (error) { alert(`Could not start order. Location is required.\n\nError: ${error.message}`);
                    } finally { actionButton.disabled = false; }
                } else if (action === 'profile') { renderCustomerProfile();
                } else if (action === 'ledger') { renderCustomerLedger();
                } else if (action === 'offer') { handleGenerateOffer(appState.customer); }
            }
        });
        
        document.getElementById('payment-customer-list-container').addEventListener('click', (e) => { 
            const collectBtn = e.target.closest('.collect-credit-payment-btn');
            if (collectBtn) { 
                appState.currentPayment = {
                    customer: JSON.parse(collectBtn.dataset.customer),
                    paymentType: 'credit'
                };
                document.getElementById('payment-customer-name').textContent = `For ${appState.currentPayment.customer.Customer}`; 
                document.getElementById('payment-amount').value = ''; 
                document.getElementById('confirm-payment-btn').style.display = 'block'; 
                document.getElementById('payment-actions-container').style.display = 'none'; 
                showPage('page-payment'); 
            } 
        });
        
        document.querySelectorAll('[data-action="back-to-main"]').forEach(btn => btn.addEventListener('click', () => showPage('page-main-view')));
        
        const showSettingsPage = () => {
            if (appState.salesman === 'ADMIN') {
                document.getElementById('set-shop-location-btn').style.display = 'flex';
            } else {
                document.getElementById('set-shop-location-btn').style.display = 'none';
            }
            showPage('page-settings');
        };

        document.getElementById('set-shop-location-btn').addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            const btn = document.getElementById('set-shop-location-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Getting Location...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const locationRef = doc(db, "app_config", "shop_location");
                        await setDoc(locationRef, { latitude, longitude });
                        showToast('Shop location has been updated successfully!');
                    } catch (error) {
                        console.error("Error saving shop location:", error);
                        alert("Failed to save location to the database.");
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                },
                (error) => {
                    alert(`Error getting location: ${error.message}`);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            );
        });
        
        document.getElementById('settings-icon-btn').addEventListener('click', showSettingsPage);
        document.getElementById('admin-settings-btn').addEventListener('click', showSettingsPage);
        document.querySelectorAll('#back-to-main-btn-order-history, #back-to-main-btn-payment-history, #back-to-main-btn-payment').forEach(btn => btn.addEventListener('click', () => showPage('page-main-view')));
        
        document.getElementById('back-to-customers-btn').addEventListener('click', () => {
            updateUserStatus('idle');
            const destinationPage = appState.editingPackingSlipId ? 'page-order-history' : 'page-main-view';
            if (appState.editingPackingSlipId) {
                appState.editingPackingSlipId = null;
            }
            showPage(destinationPage);
        });

        document.getElementById('back-from-settings-btn').addEventListener('click', () => { if(appState.salesman === 'ADMIN') { showPage('page-admin-dashboard'); document.getElementById('admin-dashboard-view').style.display = 'block'; document.getElementById('admin-operations-view').style.display = 'none'; } else showPage('page-main-view'); });
        document.getElementById('back-to-settings-btn').addEventListener('click', () => showPage('page-settings'));
        document.getElementById('back-to-payment-history-btn').addEventListener('click', () => showPage('page-payment-history'));
        
        const handleSearchOrToggle = () => {
            if (appState.currentOrderType === 'cash') return;
            const isSalesmanList = document.querySelector('#page-order .toggle-btn[data-search-type="salesman"]').classList.contains('active');
            const searchInput = document.getElementById(isSalesmanList ? 'salesman-item-search-input' : 'item-search-input');
            const filter = searchInput.value.trim().toLowerCase();
            if (filter) {
                const sourceItems = isSalesmanList ? appState.salesmanItems.map(name => appState.items.find(i => i.ItemName === name)).filter(Boolean) : appState.items;
                const filteredItems = sourceItems.filter(item => (item.ItemName || '').toLowerCase().includes(filter));
                renderItemTiles(filteredItems);
            } else { renderPreviousItemsAsTiles(); }
        };

        document.querySelector('#page-order .search-toggle-buttons').addEventListener('click', e => { if (e.target.matches('.toggle-btn')) { const searchType = e.target.dataset.searchType; document.querySelectorAll('#page-order .toggle-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('#page-order .search-view').forEach(view => view.classList.remove('active')); document.getElementById(`${searchType}-search-view`).classList.add('active'); handleSearchOrToggle(); } });
        document.getElementById('salesman-item-search-input').addEventListener('input', handleSearchOrToggle);
        document.getElementById('item-search-input').addEventListener('input', handleSearchOrToggle);
        
        document.getElementById('item-tiles-container').addEventListener('click', e => {
            const priceBox = e.target.closest('.price-box');
            const addBtn = e.target.closest('.add-to-cart-btn');
            if (priceBox) { const tile = priceBox.closest('.item-tile'); tile.querySelectorAll('.price-box').forEach(box => box.classList.remove('active')); priceBox.classList.add('active'); const item = appState.items.find(i => i.Code == tile.dataset.itemCode); const priceType = priceBox.dataset.priceType; tile.querySelector('.custom-price-input').value = item[priceType === 'p2' ? 'Price2' : 'Price3']; }
            if (addBtn) {
                const tile = addBtn.closest('.item-tile'); const qtyInput = tile.querySelector('.quantity-input'); const qty = parseFloat(qtyInput.value); const customPrice = parseFloat(tile.querySelector('.custom-price-input').value);
                if (isNaN(qty) || qty <= 0) { alert('Please enter a valid quantity.'); qtyInput.focus(); return; }
                const item = appState.items.find(i => i.Code == tile.dataset.itemCode); const activePriceBox = tile.querySelector('.price-box.active');
                let price;
                if (!isNaN(customPrice) && customPrice > 0) price = customPrice;
                else if (activePriceBox) price = item[activePriceBox.dataset.priceType === 'p2' ? 'Price2' : 'Price3'];
                else { alert('Please select a price or enter a custom price.'); return; }
                getActiveCart().push({ item, quantity: qty, sellingPrice: price }); updateCartBadge();
                addBtn.textContent = 'Added!'; addBtn.classList.add('added'); setTimeout(() => { addBtn.textContent = 'Add'; addBtn.classList.remove('added'); }, 1000);
                qtyInput.value = ''; tile.querySelector('.custom-price-input').value = ''; tile.querySelectorAll('.price-box').forEach(b => b.classList.remove('active')); tile.querySelector('[data-price-type="p2"]').classList.add('active');
            }
        });
        
        document.getElementById('item-tiles-container').addEventListener('input', e => { if (e.target.matches('.custom-price-input')) e.target.closest('.item-tile').querySelectorAll('.price-box').forEach(box => box.classList.remove('active')); });
        document.getElementById('cart-icon-btn').addEventListener('click', () => { renderOrderSummaryPage(); showPage('page-order-summary'); });
        document.getElementById('back-to-order-btn').addEventListener('click', () => showPage('page-order'));
        document.getElementById('order-summary-list').addEventListener('click', e => { const deleteBtn = e.target.closest('.delete-btn'); if (deleteBtn) { getActiveCart().splice(parseInt(deleteBtn.dataset.index), 1); renderOrderSummaryPage(); updateCartBadge(); } });

        document.getElementById('save-update-slip-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const cart = getActiveCart();
            if (cart.length === 0) { alert('Cannot save an empty packing slip.'); return; }
            if (!appState.currentOrderLocation && !appState.editingPackingSlipId) { 
                alert("Location data is missing. Please start the order again to capture location."); 
                return; 
            }

            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const saveTime = new Date();
                const startTime = new Date(appState.currentOrderStartTime);
                const salesDuration = saveTime - startTime;

                const total = cart.reduce((s, i) => s + (i.quantity * i.sellingPrice), 0);
                const orderData = {
                    customer: { Customer: appState.customer.Customer, Phone: appState.customer.Phone },
                    items: cart.map(i => ({ item: { ItemName: i.item.ItemName, Mrp: i.item.Mrp, Code: i.item.Code, Unit: i.item.Unit, Price1: i.item.Price1, Price2: i.item.Price2, Price3: i.item.Price3, CostRate: i.item.CostRate }, quantity: i.quantity, sellingPrice: i.sellingPrice })),
                    total,
                    salesman: appState.salesman,
                    date: appState.currentOrderStartTime,
                    orderSavedAt: saveTime.toISOString(),
                    salesDuration: salesDuration,
                    location: appState.currentOrderLocation,
                    status: 'pending',
                    billType: appState.currentOrderType
                };
                
                if (appState.editingPackingSlipId) {
                    const updateData = {
                        items: orderData.items,
                        total: orderData.total,
                        billType: orderData.billType
                    };
                    await updateDoc(doc(db, "orders", appState.editingPackingSlipId), updateData);
                    showProfessionalModal('Success', 'The packing slip has been updated.', () => {
                        appState.customerCarts[appState.customer.id] = [];
                        appState.editingPackingSlipId = null;
                        updateCartBadge();
                        showPage('page-order-history');
                        renderHistoryTabs(); 
                    });
                } else {
                    await setDoc(doc(collection(db, "orders")), orderData);
                    showProfessionalModal('Success', 'The packing slip has been saved.', () => {
                        appState.customerCarts[appState.customer.id] = [];
                        updateCartBadge();
                        showPage('page-main-view');
                    });
                }
                updateUserStatus('idle', `Finished order for ${appState.customer.Customer}`);

            } catch (error) {
                console.error("Error saving packing slip:", error);
                alert(`Failed to save slip. Reason: ${error.message}`);
            } finally {
                btn.disabled = false;
                appState.currentOrderLocation = null;
                appState.currentOrderStartTime = null;
            }
        });

        document.querySelector('.payment-method-options').addEventListener('click', e => { if (e.target.matches('.payment-method-option')) { document.querySelectorAll('.payment-method-option').forEach(el => el.classList.remove('selected')); e.target.classList.add('selected'); } });
        
        document.getElementById('confirm-payment-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.textContent = 'Processing...';

            const amount = parseFloat(document.getElementById('payment-amount').value);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount.');
                btn.disabled = false;
                btn.textContent = 'Confirm Payment';
                return;
            }
            const method = document.querySelector('.payment-method-option.selected').dataset.method;
            const paymentInfo = appState.currentPayment;
            
            try {
                const newPayment = {
                    customer: { Customer: paymentInfo.customer.Customer },
                    amount,
                    method,
                    salesman: appState.salesman,
                    date: new Date().toISOString(),
                    paymentType: paymentInfo.paymentType
                };
                if (paymentInfo.orderId) {
                    newPayment.orderId = paymentInfo.orderId;
                }

                await setDoc(doc(collection(db, "payments")), newPayment);
                appState.currentPayment.amount = amount;
                appState.currentPayment.method = method; // Ensure method is saved for receipt
                
                document.getElementById('confirm-payment-btn').style.display = 'none';
                document.getElementById('payment-actions-container').style.display = 'flex';
                showProfessionalModal('Success', 'Payment recorded.', () => {
                    if (paymentInfo.paymentType === 'cash_bill') {
                        appState.currentView = 'cashBillCollection';
                        renderCurrentView();
                        showPage('page-main-view');
                    }
                });

            } catch (error) {
                console.error("Error processing payment: ", error);
                alert("An error occurred. Please check your connection and try again.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm Payment';
            }
        });

        const generateAndShareReceipt = async (receiptType, customer, amount) => {
             const receiptElement = document.querySelector('#payment-receipt-wrapper .receipt-container');
             if (!receiptElement) { alert('Error: Receipt element not found.'); return; }
             
             document.getElementById('receipt-date').textContent = formatDDMMYYYYTime(new Date());
             document.getElementById('receipt-salesman').textContent = appState.salesman;
             document.getElementById('receipt-customer').textContent = customer.Customer;
             document.getElementById('receipt-amount').textContent = formatCurrency(amount);

             if (receiptType === 'payment') {
                 document.getElementById('receipt-title').textContent = 'Payment Receipt';
                 document.getElementById('receipt-amount-label').textContent = 'Amount Received';
                 document.getElementById('receipt-method-container').style.display = 'flex';
                 document.getElementById('receipt-method').textContent = appState.currentPayment.method;
             } else if (receiptType === 'outstanding') {
                 document.getElementById('receipt-title').textContent = 'Outstanding Balance';
                 document.getElementById('receipt-amount-label').textContent = 'Total Amount Due';
                 document.getElementById('receipt-method-container').style.display = 'none';
             }
             const wrapper = document.getElementById('payment-receipt-wrapper');
             const originalStyles = { position: wrapper.style.position, left: wrapper.style.left, top: wrapper.style.top, display: wrapper.style.display, };
             wrapper.style.position = 'absolute'; wrapper.style.left = '-9999px'; wrapper.style.top = '-9999px'; wrapper.style.display = 'block';

             try {
                 const canvas = await html2canvas(receiptElement, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                 const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
                 const fileName = receiptType === 'payment' ? `Receipt-${customer.Customer}.jpg` : `Reminder-${customer.Customer}.jpg`;
                 const file = new File([blob], fileName, { type: 'image/jpeg' });

                 if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: `${receiptType.charAt(0).toUpperCase() + receiptType.slice(1)} for ${customer.Customer}` });
                 } else {
                     alert("Sharing not supported. Please take a screenshot to share.");
                 }
             } catch (error) {
                 console.error('Sharing failed:', error);
                 alert("Could not generate image. Please try taking a screenshot.");
             } finally {
                wrapper.style.position = originalStyles.position; wrapper.style.left = originalStyles.left; wrapper.style.top = originalStyles.top; wrapper.style.display = originalStyles.display;
             }
        };

        document.getElementById('print-receipt-btn').addEventListener('click', () => { 
            const p = appState.currentPayment; 
            document.getElementById('receipt-title').textContent = 'Payment Receipt';
            document.getElementById('receipt-amount-label').textContent = 'Amount Received';
            document.getElementById('receipt-method-container').style.display = 'flex';
            document.getElementById('receipt-method').textContent = p.method;
            document.getElementById('receipt-date').textContent = formatDDMMYYYYTime(p.date || new Date()); 
            document.getElementById('receipt-salesman').textContent = appState.salesman; 
            document.getElementById('receipt-customer').textContent = p.customer.Customer; 
            document.getElementById('receipt-amount').textContent = formatPreciseCurrency(p.amount); 
            document.body.classList.add('printing', 'printing-receipt'); 
            setTimeout(() => window.print(), 100); 
        });
        
        document.getElementById('share-receipt-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            await generateAndShareReceipt('payment', appState.currentPayment.customer, appState.currentPayment.amount);
            btn.disabled = false;
        });


        window.onafterprint = () => { document.body.classList.remove('printing', 'printing-receipt', 'printing-packing-slip', 'printing-summary', 'printing-sale-bill', 'printing-loading-slip', 'printing-purchase-planner'); };
        
        const printSlip = (orderId) => {
            const orderToPrint = Object.values(appState.orders).flat().find(o => o.id === orderId);
            if (!orderToPrint) { alert('Could not find order to print.'); return; }
            
            const ITEMS_PER_PAGE = 27;
            const pages = [];
            for (let i = 0; i < orderToPrint.items.length; i += ITEMS_PER_PAGE) {
                pages.push(orderToPrint.items.slice(i, i + ITEMS_PER_PAGE));
            }
            
            let slipHtml = '';
            pages.forEach((pageItems, pageIndex) => {
                const pageClass = pageIndex > 0 ? 'slip-page-break' : '';
                const tableBodyHtml = pageItems.map((item, itemIndex) => {
                    const serialNumber = (pageIndex * ITEMS_PER_PAGE) + itemIndex + 1;
                    let priceType = '<span class="price-type">C</span>';
                    if (item.item.Price2 && item.sellingPrice === item.item.Price2) priceType = '<span class="price-type">P2</span>';
                    else if (item.item.Price3 && item.sellingPrice === item.item.Price3) priceType = '<span class="price-type">P3</span>';
        
                    const highlightCategories = ['CATTLE FEED', 'RICE', 'SUGAR', 'VELLAM', 'SALT,SUGAR&JAGGERY'];
                    const fullItemData = appState.items.find(i => i.Code === item.item.Code);
                    const itemCategory = (fullItemData?.Category || '').toUpperCase();
                    const highlightStyle = highlightCategories.includes(itemCategory) ? 'font-weight: bold; color: #000;' : '';
        
                    return `<tr style="${highlightStyle}">
                                <td>${serialNumber}</td>
                                <td class="col-mrp">${formatPreciseCurrency(item.item.Mrp)}</td>
                                <td class="col-item-name">${item.item.ItemName}</td>
                                <td class="col-qty">${item.quantity} ${item.item.Unit || ''}</td>
                                <td class="col-price">${formatPreciseCurrency(item.sellingPrice)}${priceType}</td>
                            </tr>`;
                }).join('');
                
                const footerHtml = pageIndex === pages.length - 1 ? `<div class="slip-footer"><div class="sorted-by">Sorted By:<div class="signature-line"></div></div></div>` : '';
                slipHtml += `<div class="${pageClass}">
                                <div class="slip-header"><h2>MF BIGMARKET</h2><p>Packing Slip ${orderToPrint.billType === 'cash' ? '(Cash Bill)' : ''}</p></div>
                                <div class="slip-details">
                                    <div><strong>Customer:</strong> ${orderToPrint.customer.Customer}<br><strong>Salesman:</strong> ${orderToPrint.salesman}</div>
                                    <div style="text-align: right;"><strong>Date:</strong> ${formatDDMMYYYY(orderToPrint.date)}<br><strong>Time:</strong> ${new Date(orderToPrint.date).toLocaleTimeString('en-GB')}</div>
                                </div>
                                <div class="slip-page-number">Page ${pageIndex + 1} of ${pages.length}</div>
                                <table class="slip-table">
                                    <thead><tr><th>S.No.</th><th class="col-mrp">MRP</th><th class="col-item-name">ITEM</th><th class="col-qty">QTY / UNIT</th><th class="col-price">PRICE</th></tr></thead>
                                    <tbody>${tableBodyHtml}</tbody>
                                </table>
                                ${footerHtml}
                             </div>`;
            });
            
            document.getElementById('packing-slip-content').innerHTML = slipHtml;
            document.body.classList.add('printing', 'printing-packing-slip');
            setTimeout(() => window.print(), 100);
        };

                // MODIFIED: Complete and corrected function to handle all history card clicks
        const handleHistoryClick = async (e) => {
            const card = e.target.closest('.history-card');
            if (!card) return;
            const id = card.dataset.id;
            const type = card.dataset.type;

            if (e.target.closest('.delete-history-btn[data-type="orders"]')) {
                if (confirm('Are you sure you want to delete this packing slip? This action cannot be undone.')) {
                    card.classList.add('removing');
                    try {
                        await deleteDoc(doc(db, "orders", id));
                        setTimeout(() => card.remove(), 400);
                    } catch (error) {
                        console.error(`Error deleting from orders:`, error);
                        showProfessionalModal('Error', `Failed to delete the entry.`);
                        card.classList.remove('removing');
                    }
                }
            } 
            else if (e.target.closest('.delete-history-btn[data-type="payments"]')) {
                const paymentToDelete = Object.values(appState.payments).flat().find(p => p.id === id);
                if (!paymentToDelete) {
                    alert('Error: Could not find the payment to delete.');
                    return;
                }
                if (confirm(`Are you sure you want to delete this payment of ${formatCurrency(paymentToDelete.amount)}?`)) {
                    card.classList.add('removing');
                    try {
                        await deleteDoc(doc(db, "payments", id));
                        showToast('Payment deleted.');

                        if (paymentToDelete.paymentType === 'cash_bill') {
                           setTimeout(renderCashBillCollectionView, 500);
                        }

                        setTimeout(() => card.remove(), 400);
                    } catch (error) {
                        console.error('Error deleting payment:', error);
                        showProfessionalModal('Error', 'Failed to delete payment. Please try again.');
                        card.classList.remove('removing');
                    }
                }
            } 
            else if (e.target.closest('.print-history-btn')) {
                printSlip(id, type);
            } else if (e.target.closest('.toggle-details')) {
                e.preventDefault();
                const target = document.getElementById(e.target.dataset.target);
                if (target) target.classList.toggle('visible');
            } else if (e.target.closest('.edit-packing-slip-btn')) {
                const orderData = (appState.orders[appState.salesman] || []).find(o => o.id === id);
                if (orderData) {
                    appState.customer = appState.customers.find(c => c.Customer === orderData.customer.Customer) || orderData.customer;
                    appState.customerCarts[appState.customer.id] = orderData.items.map(i => ({...i}));
                    appState.editingPackingSlipId = id;
                    appState.currentOrderType = orderData.billType || 'credit';
                    appState.currentOrderLocation = orderData.location;
                    appState.currentOrderStartTime = orderData.date;
                    
                    document.getElementById('order-customer-name').textContent = `Edit Order: ${appState.customer.Customer}`;
                    updateCartBadge();

                    if (appState.currentOrderType === 'cash') {
                        document.getElementById('credit-bill-search-container').style.display = 'none';
                        const cashItemsFull = appState.cashOnlyItems.map(code => appState.items.find(i => i.Code == code)).filter(Boolean);
                        renderItemTiles(cashItemsFull);
                    } else {
                        document.getElementById('credit-bill-search-container').style.display = 'block';
                        renderPreviousItemsAsTiles();
                    }
                    showPage('page-order');
                }
            }
        };

        document.getElementById('order-history-list').addEventListener('click', handleHistoryClick);
        document.getElementById('payment-history-list').addEventListener('click', handleHistoryClick);
        
        const updateFilterUI = (filterId) => {
            const filterContainer = document.getElementById(filterId);
            if (!filterContainer) return;
            const startBtn = filterContainer.querySelector('.start-date-btn');
            const endBtn = filterContainer.querySelector('.end-date-btn');
            const startLabel = startBtn.querySelector('.date-label');
            const endLabel = endBtn.querySelector('.date-label');
            const { startDate, endDate } = appState.reporting;

            if (startDate) {
                startLabel.textContent = formatDateForDisplay(startDate);
                startBtn.classList.add('has-date');
            } else {
                startLabel.textContent = 'Start Date';
                startBtn.classList.remove('has-date');
            }
            if (endDate) {
                endLabel.textContent = formatDateForDisplay(endDate);
                endBtn.classList.add('has-date');
            } else {
                endLabel.textContent = 'End Date';
                endBtn.classList.remove('has-date');
            }
        };

        const setupBetweenDateFilter = (filterId, renderFn) => {
            const filterContainer = document.getElementById(filterId);
            if (!filterContainer) return;
            const startBtn = filterContainer.querySelector('.start-date-btn');
            const endBtn = filterContainer.querySelector('.end-date-btn');
            const startInput = filterContainer.querySelector('.start-date-input');
            const endInput = filterContainer.querySelector('.end-date-input');
            const clearBtn = filterContainer.querySelector('.clear-btn');

            

            startInput.addEventListener('change', (e) => { appState.reporting.startDate = e.target.value; updateFilterUI(filterId); renderFn(); });
            endInput.addEventListener('change', (e) => { appState.reporting.endDate = e.target.value; updateFilterUI(filterId); renderFn(); });

            clearBtn.addEventListener('click', () => {
                const { startDate, endDate } = getDefaultDateRange();
                appState.reporting.startDate = startDate; appState.reporting.endDate = endDate;
                startInput.value = startDate; endInput.value = endDate;
                updateFilterUI(filterId); renderFn();
            });
        };

        setupBetweenDateFilter('admin-date-filter', renderAdminDashboard);
        setupBetweenDateFilter('order-history-date-filter', renderHistoryTabs);
        setupBetweenDateFilter('payment-history-date-filter', renderHistoryTabs);
        setupBetweenDateFilter('location-report-date-filter', renderLocationReportPage);

        const printPaymentSummary = (salesman) => {
            const { start, end } = getReportDateRange();
            let salesmanPayments = appState.payments[salesman] || [];
            if (start && end) {
                salesmanPayments = salesmanPayments.filter(p => { const pDate = new Date(p.date); return pDate >= start && pDate <= end; });
            }
            let totalCash = 0, totalUPI = 0;
            salesmanPayments.forEach(p => { if (p.method === 'Cash') totalCash += p.amount; else if (p.method === 'UPI') totalUPI += p.amount; });
            const grandTotal = totalCash + totalUPI;
            salesmanPayments.sort((a, b) => new Date(a.date) - new Date(b.date));

            document.getElementById('print-summary-salesman').textContent = `Salesman: ${salesman}`;
            const dateRangeText = start && end ? `Date Range: ${formatDDMMYYYY(start)} - ${formatDDMMYYYY(end)}` : 'Date Range: All Time';
            document.getElementById('print-summary-daterange').textContent = dateRangeText;
            document.getElementById('print-summary-cash').textContent = formatPreciseCurrency(totalCash);
            document.getElementById('print-summary-upi').textContent = formatPreciseCurrency(totalUPI);
            document.getElementById('print-summary-grandtotal').textContent = formatPreciseCurrency(grandTotal);

            document.getElementById('print-summary-table-body').innerHTML = salesmanPayments.map(p => `<tr><td>${formatDDMMYYYYTime(p.date)}</td><td>${p.customer.Customer}</td><td>${p.method}</td><td class="numeric">${formatPreciseCurrency(p.amount)}</td></tr>`).join('');
            document.body.classList.add('printing', 'printing-summary'); setTimeout(() => window.print(), 100);
        };

        const renderSalesmanSummaryPage = () => { 
            const { start, end } = getReportDateRange();
            let salesmanPayments = appState.payments[appState.salesman] || []; 
            if (start && end) { salesmanPayments = salesmanPayments.filter(p => { const pDate = new Date(p.date); return pDate >= start && pDate <= end; }); }
            
            let totalCash = 0, totalUPI = 0; 
            salesmanPayments.forEach(p => { if (p.method === 'Cash') totalCash += p.amount; else if (p.method === 'UPI') totalUPI += p.amount; }); 
            const grandTotal = totalCash + totalUPI; 
            salesmanPayments.sort((a, b) => new Date(b.date) - new Date(a.date)); 
            
            const transactionRowsHtml = salesmanPayments.length > 0 ? salesmanPayments.map(p => `<tr><td class="col-customer">${p.customer.Customer}</td><td class="col-mode">${p.method}</td><td class="col-amount">${formatPreciseCurrency(p.amount)}</td></tr>`).join('') : `<tr><td colspan="3" style="text-align:center; padding: 20px 0; color: #666;">No transactions in this period.</td></tr>`; 
            document.getElementById('payment-summary-content').innerHTML = `<div class="card"><div class="summary-totals-card"><div class="kpi-card-small grand-total"><div class="value">${formatPreciseCurrency(grandTotal)}</div><div class="label">Total Collected</div></div><div class="kpi-card-small"><div class="value">${formatPreciseCurrency(totalCash)}</div><div class="label">Total Cash</div></div><div class="kpi-card-small"><div class="value">${formatPreciseCurrency(totalUPI)}</div><div class="label">Total UPI</div></div></div></div><div class="card"><h3>All Transactions</h3><div class="table-responsive-wrapper"><table class="summary-table"><thead><tr><th class="col-customer">Customer</th><th class="col-mode">Mode</th><th class="col-amount">Amount</th></tr></thead><tbody>${transactionRowsHtml}</tbody></table></div></div>`; 
            
            const startLabel = appState.reporting.startDate ? formatDateForDisplay(appState.reporting.startDate) : 'Start';
            const endLabel = appState.reporting.endDate ? formatDateForDisplay(appState.reporting.endDate) : 'End';
            document.getElementById('summary-date-range').textContent = `(${startLabel} - ${endLabel})`;
            showPage('page-payment-summary'); 
        };
        document.getElementById('view-collection-summary-btn').addEventListener('click', renderSalesmanSummaryPage);
        document.getElementById('print-summary-btn').addEventListener('click',() => printPaymentSummary(appState.salesman));

        const offerModal = document.getElementById('offer-modal'), offerModalBody = document.getElementById('offer-modal-body');
        const renderFlyerBuilder = () => { const customer = appState.customer; const customerOrders = (appState.orders[appState.salesman] || []).filter(o => o.customer.Customer === customer.Customer); let previouslyOrderedItemsHtml = ''; appState.flyerBuilder.items = []; if (customerOrders.length > 0) { const uniqueItemCodes = new Set(); customerOrders.forEach(order => {(order.items || []).forEach(item => uniqueItemCodes.add(item.item.Code))}); [...uniqueItemCodes].forEach(code => { const fullItem = appState.items.find(i => i.Code == code); if (fullItem) { appState.flyerBuilder.items.push({ item: fullItem, price: fullItem.Price2, isPrevious: true }); } }); if(appState.flyerBuilder.items.length > 0) { previouslyOrderedItemsHtml = `<h4 style="margin-bottom:10px;">Previously Ordered Items</h4>`; } } offerModalBody.innerHTML = `<div id="offer-flyer-preview-container"></div><div id="offer-builder-content">${previouslyOrderedItemsHtml}<div id="offer-builder-item-list"></div><hr style="border: 1px solid #f0f0f0; margin: 20px 0;"><h4 style="margin-bottom:10px;">Add New Item to Offer</h4><div id="offer-item-search-container" style="position: relative;"><input type="text" id="offer-item-search-input" placeholder="Search for products..."><div id="offer-item-search-results"></div></div></div>`; renderFlyerBuilderItems(); };
        const renderFlyerBuilderItems = () => { const listContainer = document.getElementById('offer-builder-item-list'); if (appState.flyerBuilder.items.length === 0) { listContainer.innerHTML = `<p style="text-align:center; color:#888;">No items added to flyer yet.</p>`; return; } listContainer.innerHTML = appState.flyerBuilder.items.map((flyerItem, index) => `<div class="offer-builder-item"><div class="item-info"><div class="item-name">${flyerItem.item.ItemName}</div><div class="item-price">Offer Price: ${formatPreciseCurrency(flyerItem.price)}</div></div><button class="item-action-btn edit-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="item-action-btn delete-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`).join(''); };
        const handleGenerateOffer = (customer) => { appState.customer = customer; document.getElementById('offer-modal-title').textContent = `Flyer for ${customer.Customer}`; renderFlyerBuilder(); document.getElementById('generate-flyer-btn').style.display = 'block'; document.getElementById('share-flyer-btn').style.display = 'none'; appState.shareableFlyerBlob = null; offerModal.classList.add('active'); };
        offerModalBody.addEventListener('input', e => { if(e.target.id === 'offer-item-search-input') { renderItemSearchResults(e.target.value, 'offer-item-search-results'); } });
        offerModalBody.addEventListener('click', e => { const resultItem = e.target.closest('.search-result-item'); if(resultItem) { const code = resultItem.dataset.itemCode; const fullItem = appState.items.find(i => i.Code == code); if (fullItem && !appState.flyerBuilder.items.some(fi => fi.item.Code === fullItem.Code)) { appState.flyerBuilder.items.push({ item: fullItem, price: fullItem.Price2, isPrevious: false }); renderFlyerBuilderItems(); } document.getElementById('offer-item-search-input').value = ''; document.getElementById('offer-item-search-results').innerHTML = ''; } const deleteBtn = e.target.closest('.delete-btn'); if(deleteBtn) { appState.flyerBuilder.items.splice(parseInt(deleteBtn.dataset.index), 1); renderFlyerBuilderItems(); } const editBtn = e.target.closest('.edit-btn'); if (editBtn) { const index = parseInt(editBtn.dataset.index); const flyerItem = appState.flyerBuilder.items[index]; const newPrice = prompt(`Enter new offer price for ${flyerItem.item.ItemName}:`, flyerItem.price); if (newPrice !== null && !isNaN(parseFloat(newPrice))) { flyerItem.price = parseFloat(newPrice); renderFlyerBuilderItems(); } } });
        document.getElementById('generate-flyer-btn').addEventListener('click', async () => { const generateBtn = document.getElementById('generate-flyer-btn'); const previewContainer = document.getElementById('offer-flyer-preview-container'); if (appState.flyerBuilder.items.length === 0) { alert("Please add at least one item to the flyer."); return; } generateBtn.disabled = true; generateBtn.innerHTML = 'Generating...'; previewContainer.innerHTML = '...'; document.getElementById('offer-builder-content').style.display = 'none'; let headline = `A Special Offer For <span class="customer-name-highlight">${appState.customer.Customer}</span>!`; if(appState.flyerBuilder.items.some(i => i.isPrevious)) { headline = `Your Favorites Are On Offer, <span class="customer-name-highlight">${appState.customer.Customer}</span>!`; } const itemsHtml = appState.flyerBuilder.items.map(item => `<li class="flyer-item"><span class="flyer-item-name">${item.item.ItemName}</span><span class="flyer-item-price">${formatPreciseCurrency(item.price)}</span></li>`).join(''); document.getElementById('flyer-template-wrapper').innerHTML = `<div id="flyer-content"><div id="flyer-header"><h2 id="flyer-logo">MF BIGMARKET</h2><p id="flyer-tagline">Quality Products, Delivered.</p></div><div id="flyer-offer-details"><h3 id="flyer-headline">${headline}</h3><ul id="flyer-item-list">${itemsHtml}</ul></div><div id="flyer-footer"><p>Contact your salesman to order today!</p></div></div>`; try { const canvas = await html2canvas(document.getElementById('flyer-template-wrapper'), { scale: 2, useCORS: true, backgroundColor: null }); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9)); appState.shareableFlyerBlob = blob; const imgEl = document.createElement('img'); imgEl.src = URL.createObjectURL(blob); previewContainer.innerHTML = ''; previewContainer.appendChild(imgEl); generateBtn.style.display = 'none'; document.getElementById('share-flyer-btn').style.display = 'block'; } catch (error) { console.error("Flyer generation error:", error); previewContainer.innerHTML = '<p style="color:red;">Error generating flyer image.</p>'; } finally { generateBtn.disabled = false; generateBtn.innerHTML = 'Generate Flyer'; } });
        document.getElementById('share-flyer-btn').addEventListener('click', async () => { const flyerBlob = appState.shareableFlyerBlob; if (!flyerBlob) { alert('Flyer image is not available.'); return; } try { const file = new File([flyerBlob], 'MF-BigMarket-Offer.jpg', { type: 'image/jpeg' }); if (navigator.share && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: 'Special Offer for ' + appState.customer.Customer }); } else { alert("Sharing not supported. You can save the image by long-pressing it and share manually."); } } catch (error) { console.error('Share failed:', error); alert("Could not share automatically. Please save the image and send it manually."); } });
        document.getElementById('close-offer-modal-btn').addEventListener('click', () => { offerModal.classList.remove('active'); });
        const parseCSV=(t)=>{try{const e=t.trim().split(/\r\n|\n/);if(e.length<2)return[];const n=e[0].split(",").map(t=>t.trim());return e.slice(1).map(t=>{const e={};return n.forEach((n,o)=>{let r=(t.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)[o]||"").trim();r.startsWith('"')&&r.endsWith('"')&&(r=r.slice(1,-1)),e[n]=r}),e})}catch(t){return console.error("Error parsing CSV:",t),alert("There was an error parsing the CSV file. Please check the file for formatting issues."),null}}; const sanitizeAndStructureItems=t=>{const e=t=>parseFloat(String(t).replace(/,/g,""))||0,n=t=>String(t||"").trim();return t.map(t=>({Department:n(t.Department),Category:n(t.Category),Code:n(t.Code),ItemName:n(t.ItemName),CostRate:e(t.CostRate),Mrp:e(t.Mrp),Price1:e(t.Price1),Price2:e(t.Price2),Price3:e(t.Price3),Clstock:e(t.Clstock),Margin1:e(t.Margin1),Margin2:e(t.Margin2),Margin3:e(t.Margin3),Unit:n(t.Unit)}))}; const uploadCSV=async(t,e)=>{if(!t)return;const n=new FileReader;n.onload=async n=>{let o=parseCSV(n.target.result);if(o){if("items"===e&&(o=sanitizeAndStructureItems(o)),"customers"===e&&(!o[0]||!o[0].CustomerCode))return void alert("CSV Error: 'CustomerCode' column is missing or empty. Please add it as the first column.");if("items"===e&&(!o[0]||!o[0].Code))return void alert("CSV Error: 'Code' column is missing or empty.");try{const n=writeBatch(db);o.forEach(t=>{const o="items"===e?String(t.Code):String(t.CustomerCode);if(o){const r=doc(db,e,o);n.set(r,t)}}),await n.commit(),alert(`${o.length} ${e} records processed successfully.`)}catch(t){alert("Error uploading to database."),console.error(t)}}},n.readAsText(t)}; const uploadSalesmanItemsCSV=t=>{if(!t)return;const e=new FileReader;e.onload=async e=>{const n=parseCSV(e.target.result);if(n&&n.length>0&&n[0].ItemName){const t=n.map(t=>t.ItemName.trim()).filter(Boolean);try{const e=doc(db,"salesman_items","sharedList");await setDoc(e,{itemNames:t}),alert(`${t.length} salesman items uploaded successfully.`)}catch(t){alert("Error uploading salesman items to database."),console.error(t)}}else alert("CSV Error: 'ItemName' column not found or file is empty.")},e.readAsText(t)};
        const uploadCashItemsCSV = t => {
            if (!t) return;
            const e = new FileReader;
            e.onload = async e => {
                const n = parseCSV(e.target.result);
                if (n && n.length > 0 && n[0].Code) {
                    const t = n.map(t => String(t.Code).trim()).filter(Boolean);
                    try {
                        const e = doc(db, "app_config", "cash_items");
                        await setDoc(e, { itemCodes: t });
                        alert(`${t.length} cash only items uploaded successfully.`);
                    } catch (t) {
                        alert("Error uploading cash items to database."), console.error(t)
                    }
                } else alert("CSV Error: 'Code' column not found or file is empty.")
            }, e.readAsText(t)
        };
        
        document.getElementById('customer-file-upload').addEventListener('change', (e) => { uploadCSV(e.target.files[0], 'customers'); e.target.value = ''; });
        document.getElementById('item-file-upload').addEventListener('change', (e) => { uploadCSV(e.target.files[0], 'items'); e.target.value = ''; });
        document.getElementById('salesman-item-file-upload').addEventListener('change', (e) => { uploadSalesmanItemsCSV(e.target.files[0]); e.target.value = ''; });
        document.getElementById('cash-item-file-upload').addEventListener('change', (e) => { uploadCashItemsCSV(e.target.files[0]); e.target.value = ''; });
        
        const editModal = document.getElementById('edit-modal'); 
        document.getElementById('edit-customers-btn').addEventListener('click', () => { appState.editing.type = 'customers'; showPage('page-edit-data'); renderEditDataList(); }); 
        document.getElementById('edit-items-btn').addEventListener('click', () => { appState.editing.type = 'items'; showPage('page-edit-data'); renderEditDataList(); }); 
        document.getElementById('edit-data-search').addEventListener('input', (e) => renderEditDataList(e.target.value)); 
        
        const renderEditDataList = (filter = '') => { 
            const isCustomers = appState.editing.type === 'customers'; 
            const data = isCustomers ? appState.customers : appState.items; 
            const container = document.getElementById('edit-data-list'); 
            document.getElementById('edit-data-header').textContent = isCustomers ? 'Edit Customers' : 'Edit Items'; 
            const filtered = data.filter(item => ((isCustomers ? item.Customer : item.ItemName) || '').toLowerCase().includes(filter.toLowerCase())); 
            container.innerHTML = filtered.map(item => `<div class="list-item"><span class="info">${isCustomers ? item.Customer : item.ItemName}</span><button class="list-item-action" data-id="${item.id}">Edit</button></div>`).join(''); 
        }; 
        
        document.getElementById('edit-data-list').addEventListener('click', (e) => { 
            if(e.target.matches('.list-item-action')) { 
                appState.editing.id = e.target.dataset.id; 
                openEditModal(); 
            } 
        }); 
        
        const openEditModal = () => { 
            const isCustomers = appState.editing.type === 'customers'; 
            const item = (isCustomers ? appState.customers : appState.items).find(i => i.id === appState.editing.id); 
            if (!item) return; 
            const modalBody = document.getElementById('edit-modal-body'); 
            document.getElementById('edit-modal-title').textContent = `Edit ${isCustomers ? 'Customer' : 'Item'}`; 
            if (isCustomers) { 
                modalBody.innerHTML = `
                    <div class="form-group"><label>Customer Name</label><input type="text" id="edit-Customer" value="${item.Customer || ''}"></div>
                    <div class="form-group"><label>Salesman</label><select id="edit-Salesman"><option>UNNI</option><option>RIYAS</option></select></div>
                    <div class="form-group"><label>Phone</label><input type="text" id="edit-Phone" value="${item.Phone || ''}"></div>
                    <div class="form-group"><label>Outstanding Balance</label><input type="number" id="edit-Outstanding" value="${item.Outstanding || '0'}"></div>
                `; 
                document.getElementById('edit-Salesman').value = item.Salesman; 
            } else { 
                modalBody.innerHTML = `
                    <div class="form-group"><label>Item Name</label><input type="text" id="edit-ItemName" value="${item.ItemName}"></div>
                    <div class="form-group"><label>Cost Rate</label><input type="number" id="edit-CostRate" value="${item.CostRate}"></div>
                    <div class="form-group"><label>Price 1</label><input type="number" id="edit-Price1" value="${item.Price1}"></div>
                    <div class="form-group"><label>Price 2</label><input type="number" id="edit-Price2" value="${item.Price2}"></div>
                    <div class="form-group"><label>Price 3</label><input type="number" id="edit-Price3" value="${item.Price3}"></div>
                `; 
            } 
            editModal.classList.add('active'); 
        };
        const closeEditModal = () => { editModal.classList.remove('active'); }; document.getElementById('close-edit-modal-btn').addEventListener('click', closeEditModal); document.getElementById('save-edit-btn').addEventListener('click', async () => { const isCustomers = appState.editing.type === 'customers'; const id = appState.editing.id; let updatedData = {}; if (isCustomers) { updatedData = { Customer: document.getElementById('edit-Customer').value, Salesman: document.getElementById('edit-Salesman').value, Phone: document.getElementById('edit-Phone').value, Outstanding: parseFloat(document.getElementById('edit-Outstanding').value) || 0 }; } else { const fields = ['ItemName', 'CostRate', 'Price1', 'Price2', 'Price3']; fields.forEach(field => { const input = document.getElementById(`edit-${field}`); updatedData[field] = input.type === 'number' ? parseFloat(input.value) : input.value; }); } await updateDoc(doc(db, isCustomers ? 'customers' : 'items', id), updatedData); closeEditModal(); if (document.getElementById('page-customer-profile').classList.contains('active')) { appState.customer = { ...appState.customer, ...updatedData }; renderCustomerProfile(); } showProfessionalModal('Success', 'Record updated successfully!'); });
        const pageCrm = document.getElementById('page-crm'); const renderCrmModule = () => { appState.flyerBuilder.items = []; const salesmanFilter = document.getElementById('crm-salesman-filter'); const routeFilter = document.getElementById('crm-route-filter'); const salesmen = [...new Set(appState.customers.map(c => c.Salesman).filter(Boolean))].sort(); salesmanFilter.innerHTML = '<option value="ALL">All Salesmen</option>' + salesmen.map(s => `<option value="${s}">${s}</option>`).join(''); const routes = [...new Set(appState.customers.map(c => c.Route).filter(Boolean))].sort(); routeFilter.innerHTML = '<option value="ALL">All Routes</option>' + routes.map(r => `<option value="${r}">${r}</option>`).join(''); updateCrmCustomerCount(); document.getElementById('crm-flyer-headline').value = ''; document.getElementById('crm-flyer-preview-container').innerHTML = `<p style="color:#888;">Flyer preview will appear here.</p>`; document.getElementById('share-bulk-flyer-btn').style.display = 'none'; document.getElementById('generate-bulk-flyer-btn').style.display = 'block'; document.getElementById('crm-flyer-builder-content').style.display = 'block'; renderCrmFlyerItems(); }; const renderCrmFlyerItems = () => { const listContainer = document.getElementById('crm-flyer-item-list'); if (appState.flyerBuilder.items.length === 0) { listContainer.innerHTML = `<p style="text-align:center; color:#888;">No items added to flyer yet.</p>`; return; } listContainer.innerHTML = appState.flyerBuilder.items.map((flyerItem, index) => `<div class="offer-builder-item"><div class="item-info"><div class="item-name">${flyerItem.item.ItemName}</div><div class="item-price">Offer Price: ${formatPreciseCurrency(flyerItem.price)}</div></div><button class="item-action-btn edit-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="item-action-btn delete-btn" data-index="${index}"><svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`).join(''); }; pageCrm.addEventListener('input', e => { if(e.target.id === 'offer-item-search-input-bulk') { renderItemSearchResults(e.target.value, 'offer-item-search-results-bulk'); } }); pageCrm.addEventListener('click', e => { const resultItem = e.target.closest('#offer-item-search-results-bulk .search-result-item'); if(resultItem) { const code = resultItem.dataset.itemCode; const fullItem = appState.items.find(i => i.Code == code); if (fullItem && !appState.flyerBuilder.items.some(fi => fi.item.Code === fullItem.Code)) { appState.flyerBuilder.items.push({ item: fullItem, price: fullItem.Price2 }); renderCrmFlyerItems(); } document.getElementById('offer-item-search-input-bulk').value = ''; document.getElementById('offer-item-search-results-bulk').innerHTML = ''; } const deleteBtn = e.target.closest('#crm-flyer-item-list .delete-btn'); if(deleteBtn) { appState.flyerBuilder.items.splice(parseInt(deleteBtn.dataset.index), 1); renderCrmFlyerItems(); } const editBtn = e.target.closest('#crm-flyer-item-list .edit-btn'); if (editBtn) { const index = parseInt(editBtn.dataset.index); const flyerItem = appState.flyerBuilder.items[index]; const newPrice = prompt(`Enter new offer price for ${flyerItem.item.ItemName}:`, flyerItem.price); if (newPrice !== null && !isNaN(parseFloat(newPrice))) { flyerItem.price = parseFloat(newPrice); renderCrmFlyerItems(); } } }); const updateCrmCustomerCount = () => { const selectedSalesman = document.getElementById('crm-salesman-filter').value; const selectedRoute = document.getElementById('crm-route-filter').value; const targetCustomers = appState.customers.filter(c => { const hasPhone = c.Phone && c.Phone.trim().length > 5; const matchesSalesman = selectedSalesman === 'ALL' || c.Salesman === selectedSalesman; const matchesRoute = selectedRoute === 'ALL' || c.Route === selectedRoute; return hasPhone && matchesSalesman && matchesRoute; }); document.getElementById('crm-customer-count').textContent = `Targeted Customers: ${targetCustomers.length}`; }; const generateBulkFlyer = async () => { const generateBtn = document.getElementById('generate-bulk-flyer-btn'); const previewContainer = document.getElementById('crm-flyer-preview-container'); if (appState.flyerBuilder.items.length === 0) { alert("Please add at least one item to the flyer."); return; } generateBtn.disabled = true; generateBtn.innerHTML = 'Generating...'; previewContainer.innerHTML = '...'; const headline = document.getElementById('crm-flyer-headline').value.trim() || 'A Special Offer For You!'; const itemsHtml = appState.flyerBuilder.items.map(item => `<li class="flyer-item"><span class="flyer-item-name">${item.item.ItemName}</span><span class="flyer-item-price">${formatPreciseCurrency(item.price)}</span></li>`).join(''); document.getElementById('flyer-template-wrapper').innerHTML = `<div id="flyer-content"><div id="flyer-header"><h2 id="flyer-logo">MF BIGMARKET</h2><p id="flyer-tagline">Quality Products, Delivered.</p></div><div id="flyer-offer-details"><h3 id="flyer-headline">${headline}</h3><ul id="flyer-item-list">${itemsHtml}</ul></div><div id="flyer-footer"><p>Contact your salesman to order today!</p></div></div>`; try { const canvas = await html2canvas(document.getElementById('flyer-template-wrapper'), { scale: 2, useCORS: true, backgroundColor: null }); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9)); appState.bulkFlyerBlob = blob; const imgEl = document.createElement('img'); imgEl.src = URL.createObjectURL(blob); previewContainer.innerHTML = ''; previewContainer.appendChild(imgEl); document.getElementById('share-bulk-flyer-btn').style.display = 'block'; } catch (error) { console.error("Bulk flyer generation error:", error); previewContainer.innerHTML = '<p style="color:red;">Error generating flyer image.</p>'; } finally { generateBtn.disabled = false; generateBtn.innerHTML = 'Generate Flyer Preview'; } };
        document.getElementById('generate-bulk-flyer-btn').addEventListener('click', generateBulkFlyer); document.getElementById('share-bulk-flyer-btn').addEventListener('click', async () => { const flyerBlob = appState.bulkFlyerBlob; if (!flyerBlob) { alert('Please generate a flyer first.'); return; } const targetCount = document.getElementById('crm-customer-count').textContent; if(!confirm(`Your flyer is ready. You will now be prompted to share it with your selected ${targetCount}. Continue?`)){ return; } try { const file = new File([flyerBlob], 'MF-BigMarket-Offer.jpg', { type: 'image/jpeg' }); const shareText = document.getElementById('crm-flyer-headline').value.trim() || 'Check out our latest deals!'; if (navigator.share && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: 'MF BigMarket Offer', text: shareText }); } else { alert("Sharing not supported on this browser. You can save the image by long-pressing it and share manually."); } } catch (error) { console.error('Bulk Share failed:', error); alert("Could not share automatically. Please save the image and send it manually."); } });
        document.getElementById('back-to-admin-from-crm-btn').addEventListener('click', () => { showPage('page-admin-dashboard'); document.getElementById('admin-dashboard-view').style.display = 'block'; document.getElementById('admin-operations-view').style.display = 'none'; }); document.getElementById('crm-salesman-filter').addEventListener('change', updateCrmCustomerCount); document.getElementById('crm-route-filter').addEventListener('change', updateCrmCustomerCount);
        
        document.querySelector('#page-product-info .search-toggle-buttons').addEventListener('click', e => { if (e.target.matches('.toggle-btn')) { const searchType = e.target.dataset.searchType; document.querySelectorAll('#page-product-info .toggle-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('#page-product-info .search-view').forEach(view => view.classList.remove('active')); document.getElementById(`${searchType}-search-view`).classList.add('active'); document.getElementById(`${searchType === 'info-salesman' ? 'info-salesman-item-search-input' : 'info-item-search-input'}`).focus(); } });
        document.getElementById('info-salesman-item-search-input').addEventListener('input', (e) => renderSalesmanItemSearchResults(e.target.value, 'info-salesman-item-search-results'));
        document.getElementById('info-item-search-input').addEventListener('input', (e) => renderItemSearchResults(e.target.value, 'info-item-search-results'));
        
        const renderProductInfoCard = (item) => {
            const container = document.getElementById('product-info-display-card'); if (!item) { container.style.display = 'none'; return; }
            container.innerHTML = `<h3>${item.ItemName}</h3><div class="price-grid"><div class="price-item"><div class="label">Price 1</div><div class="value">${formatPreciseCurrency(item.Price1)}</div></div><div class="price-item"><div class="label">Price 2</div><div class="value">${formatPreciseCurrency(item.Price2)}</div></div><div class="price-item"><div class="label">Price 3</div><div class="value">${formatPreciseCurrency(item.Price3)}</div></div></div><p class="stock-info">Current Stock: ${item.Clstock} ${item.Unit || ''}</p>`; container.style.display = 'block';
        };
        const handleInfoItemSelection = (itemElement) => { if (itemElement) { const code = itemElement.dataset.itemCode; const selectedItem = appState.items.find(i => i.Code == code); document.getElementById('info-item-search-input').value = ''; document.getElementById('info-salesman-item-search-input').value = ''; document.getElementById('info-item-search-results').innerHTML = ''; document.getElementById('info-salesman-item-search-results').innerHTML = ''; renderProductInfoCard(selectedItem); } };
        document.getElementById('info-salesman-item-search-results').addEventListener('click', (e) => handleInfoItemSelection(e.target.closest('.search-result-item')));
        document.getElementById('info-item-search-results').addEventListener('click', (e) => handleInfoItemSelection(e.target.closest('.search-result-item')));

        document.getElementById('back-to-history-from-edit-btn').addEventListener('click', () => showPage('page-order-history'));

        const renderOutstandingBalancesPage = () => {
            const container = document.getElementById('outstanding-list-container');
            const totalValueEl = document.getElementById('total-outstanding-value');
            
            populateRoutes('outstanding-route-filter');
            const searchFilter = document.getElementById('outstanding-search-input').value.toLowerCase();
            const selectedRoute = document.getElementById('outstanding-route-filter').value;

            let filteredCustomers = appState.customers
                .filter(c => c.Salesman && c.Salesman.toUpperCase() === appState.salesman && (c.Customer || '').toLowerCase().includes(searchFilter) && (selectedRoute === 'ALL' || c.Route === selectedRoute));

            const totalOutstanding = filteredCustomers.reduce((sum, c) => sum + (c.Outstanding || 0), 0);
            totalValueEl.textContent = formatCurrency(totalOutstanding);
            
            if (appState.outstandingSort === 'desc') {
                filteredCustomers.sort((a, b) => (b.Outstanding || 0) - (a.Outstanding || 0));
            } else if (appState.outstandingSort === 'asc') {
                filteredCustomers.sort((a, b) => (a.Outstanding || 0) - (b.Outstanding || 0));
            } else {
                filteredCustomers.sort((a, b) => (a.Customer || '').localeCompare(b.Customer || ''));
            }

            if (filteredCustomers.length === 0) {
                container.innerHTML = `<p class="card" style="text-align: center;">No customers found for the selected filters.</p>`;
                return;
            }

            container.innerHTML = filteredCustomers.map(c => `
                <div class="list-item" data-customer-id="${c.id}" data-customer-name="${c.Customer}">
                    <div class="info">${c.Customer}</div>
                    <input type="number" class="outstanding-balance" value="${c.Outstanding || 0}" readonly />
                    <button class="reminder-btn" data-customer='${JSON.stringify(c)}'>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </button>
                </div>
            `).join('');
        };
        
        document.getElementById('outstanding-search-input').addEventListener('input', renderOutstandingBalancesPage);
        document.getElementById('outstanding-route-filter').addEventListener('change', renderOutstandingBalancesPage);
        
        document.getElementById('outstanding-sort-btn').addEventListener('click', (e) => {
            const btn = e.currentTarget;
            if (appState.outstandingSort === 'default') {
                appState.outstandingSort = 'desc';
                btn.textContent = 'Sort: High to Low';
            } else if (appState.outstandingSort === 'desc') {
                appState.outstandingSort = 'asc';
                btn.textContent = 'Sort: Low to High';
            } else {
                appState.outstandingSort = 'default';
                btn.textContent = 'Sort by Amount';
            }
            renderOutstandingBalancesPage();
        });
        
        const outstandingListContainer = document.getElementById('outstanding-list-container');
        
        outstandingListContainer.addEventListener('click', async (e) => {
            const reminderBtn = e.target.closest('.reminder-btn');
            if (reminderBtn) {
                reminderBtn.disabled = true;
                const customer = JSON.parse(reminderBtn.dataset.customer);
                await generateAndShareReceipt('outstanding', customer, customer.Outstanding || 0);
                reminderBtn.disabled = false;
            }
        });
        
        
        const renderPackerHome = () => {
            const container = document.getElementById('packer-order-list');
            const { start, end } = getReportDateRange();
            let allOrders = Object.values(appState.orders).flat().filter(o => o.status === 'pending' && !o.packerAssistant);
            
            if (start && end) {
                allOrders = allOrders.filter(o => {
                    const orderDate = new Date(o.date);
                    return orderDate >= start && orderDate <= end;
                });
            }
             allOrders.sort((a,b) => new Date(b.date) - new Date(a.date));

            if(allOrders.length === 0) {
                 container.innerHTML = `<div class="card" style="text-align: center;">No pending orders found.</div>`;
                 return;
            }

            container.innerHTML = allOrders.map(o => {
                const billTypeBadge = o.billType === 'cash' ? '<span class="bill-type-badge">Cash Bill</span>' : '';
                return `
                <div class="list-item" data-order-id="${o.id}">
                    <div class="info">${o.customer.Customer} (${o.salesman}) ${billTypeBadge}</div>
                    <button class="list-item-action transfer-btn" data-order-id="${o.id}">Transfer</button>
                </div>`;
            }).join('');
        };
        
        document.getElementById('packer-order-list').addEventListener('click', async e => {
            const transferBtn = e.target.closest('.transfer-btn');
            if (transferBtn) {
                appState.orderToTransfer = transferBtn.dataset.orderId;
                document.getElementById('transfer-modal').classList.add('active');
            }
        });

                // REPLACEMENT for the transfer-modal event listener
        document.getElementById('transfer-modal').addEventListener('click', async e => {
            const modal = document.getElementById('transfer-modal');
            if (e.target === modal) {
                modal.classList.remove('active');
                return;
            }
            const assistantBtn = e.target.closest('.button[data-assistant]');
            if (assistantBtn) {
                const assistant = assistantBtn.dataset.assistant;
                const orderId = appState.orderToTransfer;
                
                assistantBtn.disabled = true;
                try {
                    // *** FIX IS HERE: We now add packingStartTime on transfer ***
                    const startTime = new Date().toISOString();
                    await updateDoc(doc(db, "orders", orderId), {
                        packerAssistant: assistant,
                        status: 'packing',
                        packingStartTime: startTime // Start the timer immediately
                    });
                    showToast(`Order transferred to ${assistant}`);
                    modal.classList.remove('active');
                } catch (err) {
                    console.error("Error transferring order:", err);
                    alert("Failed to transfer. Please try again.");
                } finally {
                    assistantBtn.disabled = false;
                    appState.orderToTransfer = null;
                }
            }
        });
        
        const formatDuration = (ms) => {
            if (typeof ms !== 'number' || ms < 0 || isNaN(ms)) return 'N/A';
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor(ms / (1000 * 60 * 60));
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        };
        
        const renderPackerHistory = () => {
             const container = document.getElementById('packer-history-list');
            let allOrders = Object.values(appState.orders).flat().filter(o => o.status === 'packed' || o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered');
             allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
             
            if (allOrders.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center;">No packed orders found.</p>`;
                return;
            }

            container.innerHTML = allOrders.map(o => {
                const billTypeBadge = o.billType === 'cash' ? '<span class="bill-type-badge">Cash Bill</span>' : '';
                return `
                <div class="history-card" data-id="${o.id}">
                    <div class="history-card-header">
                        <div class="info">
                           <p><strong>Customer:</strong> ${o.customer.Customer} ${billTypeBadge}</p>
                           <p><strong>Salesman:</strong> ${o.salesman}</p>
                           <p><strong>Packed By:</strong> ${o.packerAssistant || 'N/A'}</p>
                           <p class="date-display">Packed on: ${formatDDMMYYYYTime(o.packingEndTime || o.date)}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');
        };
        
        document.getElementById('packer-history-btn').addEventListener('click', () => { showPage('page-packer-history'); renderPackerHistory(); });
        document.getElementById('back-to-packer-home-from-history-btn').addEventListener('click', () => showPage('page-packer-home'));
        document.getElementById('billed-orders-btn').addEventListener('click', () => { showPage('page-billed-orders'); renderBilledOrders(); });
        document.getElementById('back-to-main-from-billed-orders-btn').addEventListener('click', () => showPage('page-main-view'));
        setupBetweenDateFilter('packer-date-filter', renderPackerHome);

        const renderBillerHome = () => {
            const container = document.getElementById('biller-order-list');
            const { start, end } = getReportDateRange();
            let allOrders = Object.values(appState.orders).flat().filter(o => o.status === 'packed');
            
            if (start && end) {
                allOrders = allOrders.filter(o => {
                    const orderDate = new Date(o.packingEndTime || o.date);
                    return orderDate >= start && orderDate <= end;
                });
            }
            allOrders.sort((a,b) => new Date(b.packingEndTime) - new Date(a.packingEndTime));

            if(allOrders.length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No orders pending for billing.</div>`;
                return;
            }

            container.innerHTML = allOrders.map(o => {
                 const billTypeBadge = o.billType === 'cash' ? '<span class="bill-type-badge">Cash Bill</span>' : '';
                return `
                <div class="list-item" data-order-id="${o.id}">
                    <div class="info">${o.customer.Customer} (${o.salesman}) ${billTypeBadge}</div>
                    <button class="list-item-action start-bill-btn" data-order-id="${o.id}">Start Billing</button>
                </div>`;
            }).join('');
        };
        
        document.getElementById('biller-order-list').addEventListener('click', async e => {
            const billBtn = e.target.closest('.start-bill-btn');
            if(billBtn) {
                const orderId = billBtn.dataset.orderId;
                const order = Object.values(appState.orders).flat().find(o => o.id === orderId);
                appState.billingOrder = JSON.parse(JSON.stringify(order));
                appState.billingOrder.billingStartTime = new Date().toISOString();
                
                await updateDoc(doc(db, "orders", orderId), {
                    billingStartTime: appState.billingOrder.billingStartTime
                });

                updateUserStatus('active', `Billing for ${order.customer.Customer}`);
                showPage('page-billing-interface');
                renderBillingInterface();
            }
        });

        const renderBillingInterface = () => {
            const order = appState.billingOrder;
            document.getElementById('billing-order-customer').textContent = `Billing for ${order.customer.Customer}`;
            const itemList = document.getElementById('billing-item-list');
            const freightContainer = document.getElementById('freight-input-container');

            if (order.billType === 'cash') {
                freightContainer.style.display = 'block';
                document.getElementById('freight-amount').value = order.freight || '';
            } else {
                freightContainer.style.display = 'none';
            }

            itemList.innerHTML = order.items.map((itemData, index) => `
                <div class="list-item">
                    <input type="checkbox" data-index="${index}" ${itemData.wasUnchecked ? '' : 'checked'}>
                    <div class="info">
                        <span class="billing-item-name">${itemData.item.ItemName}</span>
                        <span class="billing-item-details">
                            QTY: ${itemData.quantity} ${itemData.item.Unit || ''} | MRP: ${formatPreciseCurrency(itemData.item.Mrp)}
                        </span>
                    </div>
                </div>
            `).join('');
        };
        
        document.getElementById('billing-item-search').addEventListener('input', e => {
            renderItemSearchResults(e.target.value, 'billing-item-search-results');
        });

        document.getElementById('billing-item-search-results').addEventListener('click', e => {
            const resultItem = e.target.closest('.search-result-item');
            if (resultItem) {
                const item = appState.items.find(i => i.Code == resultItem.dataset.itemCode);
                const qty = prompt(`Enter quantity for ${item.ItemName}:`);
                const qtyNum = parseFloat(qty);
                if(qty && !isNaN(qtyNum) && qtyNum > 0) {
                    
                    // ADD THIS BLOCK TO PRESERVE CHECKBOX STATE
                    document.querySelectorAll('#billing-item-list input[type="checkbox"]').forEach(checkbox => {
                        const index = parseInt(checkbox.dataset.index);
                        if (!checkbox.checked) {
                            appState.billingOrder.items[index].wasUnchecked = true;
                        } else {
                            delete appState.billingOrder.items[index].wasUnchecked;
                        }
                    });
                    // END OF ADDED BLOCK

                    appState.billingOrder.items.push({ item, quantity: qtyNum, sellingPrice: item.Price2, isNew: true });
                    renderBillingInterface();
                }
                document.getElementById('billing-item-search').value = '';
                document.getElementById('billing-item-search-results').innerHTML = '';
            }
        });
       
       // --- NEW, CORRECTED CODE ---
        document.getElementById('confirm-billing-btn').addEventListener('click', async () => {
            const btn = document.getElementById('confirm-billing-btn');
            btn.disabled = true;

            const billingOrder = appState.billingOrder;
            const billedOrderId = billingOrder.id;

            billingOrder.items.forEach((item, index) => {
                const checkbox = document.querySelector(`#billing-item-list input[data-index="${index}"]`);
                if (checkbox && !checkbox.checked) {
                    item.wasUnchecked = true;
                } else {
                    delete item.wasUnchecked;
                }
            });
            
            const endTime = new Date();
            const startTime = new Date(billingOrder.billingStartTime);
            const billingDuration = endTime - startTime;

            // 1. Calculate the final total from items that are NOT unchecked
            const finalItemsTotal = billingOrder.items.reduce((acc, item) => {
                return item.wasUnchecked ? acc : acc + (item.quantity * item.sellingPrice);
            }, 0);

            // 2. Get freight amount for cash bills, defaulting to 0
            const freightAmount = (billingOrder.billType === 'cash') 
                ? (parseFloat(document.getElementById('freight-amount').value) || 0) 
                : 0;

            const updateData = {
                status: 'billed',
                billedItems: billingOrder.items,
                billedBy: 'ARFATH',
                billedAt: endTime.toISOString(),
                billingDuration: billingDuration,
                finalBilledTotal: finalItemsTotal + freightAmount, // 3. Save the final, authoritative total
            };
            
            if (billingOrder.billType === 'cash') {
                updateData.freight = freightAmount; // Also save the freight amount itself
            }

            try {
                await updateDoc(doc(db, "orders", billedOrderId), updateData);
                updateUserStatus('idle', `Billed for ${billingOrder.customer.Customer}`);
                
                showPage('page-biller-home');
                
                const listItem = document.querySelector(`#biller-order-list .list-item[data-order-id="${billedOrderId}"]`);
                if(listItem) {
                    listItem.classList.add('removing');
                    setTimeout(() => listItem.remove(), 500);
                }

                showProfessionalModal('Success', 'Order has been billed successfully.');
            } catch (error) {
                console.error("Error confirming billing:", error);
                alert("Failed to confirm billing.");
            } finally {
                 appState.billingOrder = null;
                 btn.disabled = false;
            }
        });

        const renderBillerHistory = () => {
            const container = document.getElementById('biller-history-list');
            let allOrders = Object.values(appState.orders).flat().filter(o => o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered');
            allOrders.sort((a, b) => new Date(b.billedAt) - new Date(a.billedAt));
             
            if (allOrders.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center;">No billed orders found.</p>`;
                return;
            }

            container.innerHTML = allOrders.map(o => {
                 const billTypeBadge = o.billType === 'cash' ? '<span class="bill-type-badge">Cash Bill</span>' : '';
                return `
                <div class="history-card" data-id="${o.id}">
                    <div class="history-card-header">
                        <div class="info">
                           <p><strong>Customer:</strong> ${o.customer.Customer} ${billTypeBadge}</p>
                           <p><strong>Salesman:</strong> ${o.salesman}</p>
                           <p><strong>Time Taken:</strong> ${formatDuration(o.billingDuration)}</p>
                           <p class="date-display">${formatDDMMYYYYTime(o.billedAt)}</p>
                        </div>
                        <div class="actions">
                            <button class="history-action-btn download-bill-btn" title="Download Excel"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                            <button class="history-action-btn print-loading-slip-btn" title="Print Loading Slip"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg></button>
                            <button class="button button-outline undo-bill-btn" style="padding: 5px 10px; font-size: 0.8rem;">Undo</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        };
        
        // --- START OF NEW FUNCTION ---
// This function creates a headerless, tab-separated file and gives it an .xls extension.
// --- FIND AND DELETE your old 'downloadDataAsXls' function ---


// --- ADD THIS NEW, REPLACEMENT function in its place ---
const downloadDataAsXls = (jsonData, fileName) => {
    if (!jsonData || jsonData.length === 0) {
        alert("No data to export.");
        return;
    }

    // 1. Convert the array of objects into an array of arrays (e.g., [['Value1', 'Value2'], ['Value3', 'Value4']]).
    // This is necessary to create a sheet without headers, as your previous function did.
    const dataAsArray = jsonData.map(rowObject => Object.values(rowObject));

    // 2. Create a new worksheet from our array of arrays.
    // The XLSX.utils.aoa_to_sheet function is perfect for this.
    const worksheet = XLSX.utils.aoa_to_sheet(dataAsArray);

    // 3. Create a new workbook. A workbook is the Excel file itself.
    const workbook = XLSX.utils.book_new();

    // 4. Append our worksheet to the workbook and give the sheet a name (e.g., "Sheet1").
    XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

    // 5. This is the most important step:
    // Generate the file and trigger the download.
    // The `bookType: 'xls'` option specifically creates the Excel 97-2003 Workbook (BIFF8) format.
    XLSX.writeFile(workbook, fileName + '.xls', { bookType: 'xls' });
};
// --- END OF NEW FUNCTION ---
        
        const printLoadingSlip = (order) => {
             const highlightCategories = ['CATTLE FEED', 'RICE', 'SUGAR', 'VELLAM', 'SALT,SUGAR&JAGGERY'];
             const loadingItems = (order.billedItems || [])
                .filter(itemData => !itemData.wasUnchecked)
                .map(itemData => ({
                    ...itemData,
                    fullItem: appState.items.find(i => i.Code === itemData.item.Code)
                }))
                .filter(itemData => {
                    const category = (itemData.fullItem?.Category || '').toUpperCase();
                    return highlightCategories.includes(category);
                });

            if (loadingItems.length === 0) {
                alert('No items from loading categories found in this order.');
                return;
            }
            
            const tableBodyHtml = loadingItems.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.item.ItemName}</td>
                    <td class="col-qty">${item.quantity} ${item.item.Unit || ''}</td>
                </tr>
            `).join('');

            const slipHtml = `
                <div class="loading-slip-header">
                    <h2>Loading Slip</h2>
                </div>
                <div class="loading-slip-details">
                    <p><strong>Customer:</strong> ${order.customer.Customer}</p>
                    <p><strong>Date:</strong> ${formatDDMMYYYY(order.billedAt)}</p>
                </div>
                <table class="loading-slip-table">
                    <thead>
                        <tr>
                            <th>S.No.</th>
                            <th>Item Name</th>
                            <th class="col-qty">Quantity</th>
                        </tr>
                    </thead>
                    <tbody>${tableBodyHtml}</tbody>
                </table>`;
            
            document.getElementById('loading-slip-content').innerHTML = slipHtml;
            document.body.classList.add('printing', 'printing-loading-slip');
            setTimeout(() => window.print(), 100);
        };

        document.getElementById('biller-history-list').addEventListener('click', async e => {
            const undoBtn = e.target.closest('.undo-bill-btn');
            const downloadBtn = e.target.closest('.download-bill-btn');
            const printBtn = e.target.closest('.print-loading-slip-btn');
            const card = e.target.closest('.history-card');

            if (!card) return;
            const orderId = card.dataset.id;
            const order = Object.values(appState.orders).flat().find(o => o.id === orderId);

            if (undoBtn) {
                if (confirm('Are you sure you want to undo this billing? This will move the order back to the pending for billing list.')) {
                    try {
                        await updateDoc(doc(db, "orders", orderId), { 
                            status: 'packed',
                            billedItems: deleteField(),
                            billedBy: deleteField(),
                            billedAt: deleteField(),
                            billingDuration: deleteField(),
                            billingStartTime: deleteField(),
                            freight: deleteField()
                        });
                        renderAdminOperationsPage();
                        showToast('Billing undone. Order is now pending for billing.');

                    } catch (error) {
                        console.error("Error undoing bill status:", error);
                        alert('Failed to undo billing.');
                    }
                }
            } else if (downloadBtn) {
                if (!order) return;
                const itemsToExport = (order.billedItems || [])
                    .filter(item => !item.wasUnchecked)
                    .map(item => ({
                        'Item Code': item.item.Code,
                        'Item Name': item.item.ItemName,
                        'Quantity': item.quantity,
                    }));
                if (itemsToExport.length > 0) {
                    const formattedDate = new Date(order.billedAt || order.date).toLocaleDateString('en-GB').replace(/\//g, '-');
                    downloadDataAsXls(itemsToExport, `${order.salesman}-${order.customer.Customer}-${formattedDate}`);
                } else {
                    alert('No items to export.');
                }
            } else if (printBtn) {
                 if (order) printLoadingSlip(order);
            }
        });

        document.getElementById('biller-history-btn').addEventListener('click', () => { showPage('page-biller-history'); renderBillerHistory(); });
        document.getElementById('back-to-biller-home-btn').addEventListener('click', () => { updateUserStatus('idle'); showPage('page-biller-home'); });
        document.getElementById('back-to-biller-home-from-history-btn').addEventListener('click', () => showPage('page-biller-home'));
        setupBetweenDateFilter('biller-date-filter', renderBillerHome);


        const renderBilledOrders = () => {
            const container = document.getElementById('billed-orders-list');
            const salesmanOrders = (appState.orders[appState.salesman] || []).filter(o => o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered').sort((a, b) => new Date(b.billedAt || b.date) - new Date(a.billedAt || a.date));
            const costMap = new Map(appState.items.map(i => [String(i.Code), parseFloat(i.CostRate) || 0]));

            if (salesmanOrders.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center;">No billed orders to display.</p>`;
                return;
            }

            container.innerHTML = salesmanOrders.map(order => {
                let finalTotal = 0;
                let finalCost = 0;
                const itemsToProcess = order.billedItems || order.items;
                
                const itemDetailsHtml = (itemsToProcess).map(i => {
                    let style = '';
                    if (i.wasUnchecked) {
                        style = 'background-color: #ffebee; color: #c62828;';
                    } else if (i.isNew) {
                         style = 'background-color: #e8f5e9; color: #2e7d32;';
                    }

                    if (!i.wasUnchecked) {
                        const lineTotal = (i.quantity || 0) * (i.sellingPrice || 0);
                        const lineCost = (i.quantity || 0) * (costMap.get(String(i.item.Code)) || 0);
                        finalTotal += lineTotal;
                        finalCost += lineCost;
                    }
                    
                    return `<tr style="${style}">
                                <td class="col-item-name">${i.item.ItemName}</td>
                                <td class="numeric">${i.wasUnchecked ? 'REMOVED' : `${i.quantity} ${i.item.Unit || ""}`}</td>
                                <td class="numeric">${i.wasUnchecked ? '-' : formatPreciseCurrency(i.sellingPrice)}</td>
                                <td class="numeric"><strong>${i.wasUnchecked ? '-' : formatPreciseCurrency((i.quantity || 0) * (i.sellingPrice || 0))}</strong></td>
                            </tr>`;
                }).join('');

                const totalProfit = finalTotal - finalCost;
                const margin = finalTotal > 0 ? (totalProfit / finalTotal) * 100 : 0;
                const profitClass = totalProfit >= 0 ? 'profit' : 'loss';
                const profitHtml = `<p><strong>Profit:</strong> <span class="${profitClass}">${formatPreciseCurrency(totalProfit)} (${margin.toFixed(1)}%)</span></p>`;
                const billTypeBadge = order.billType === 'cash' ? '<span class="bill-type-badge">Cash Bill</span>' : '';

                return `
                    <div class="history-card">
                        <div class="history-card-header">
                            <div class="info">
                               <p><strong>Customer:</strong> ${order.customer.Customer} ${billTypeBadge}</p>
                               <p><strong>Final Total:</strong> ${formatPreciseCurrency(finalTotal)}</p>
                               ${profitHtml}
                               <p><strong>Time Taken to Order:</strong> ${formatDuration(order.salesDuration)}</p>
                               <p class="date-display">${formatDDMMYYYYTime(order.billedAt || order.date)}</p>
                            </div>
                        </div>
                        <div class="history-card-body" id="billed-details-${order.id}">
                            <div class="table-responsive-wrapper">
                                <table class="history-item-table">
                                    <thead><tr><th class="col-item-name">Item</th><th class="numeric">Qty / Unit</th><th class="numeric">Price</th><th class="numeric">Total</th></tr></thead>
                                    <tbody>${itemDetailsHtml}</tbody>
                                </table>
                            </div>
                        </div>
                        <a class="toggle-details" data-target="billed-details-${order.id}">View Details</a>
                    </div>`;
            }).join('');
            
            container.querySelectorAll('.toggle-details').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.preventDefault();
                    const target = document.getElementById(e.currentTarget.dataset.target);
                    if (target) target.classList.toggle('visible');
                });
            });
        };

        const accountantLedgerView = document.getElementById('accountant-ledger-view');
        const accountantCollectionView = document.getElementById('accountant-collection-view');
        const accountantHeader = document.getElementById('accountant-header');
        const accountantPrintBtn = document.getElementById('accountant-print-collection-btn');

        const renderAccountantView = () => {
            if (appState.salesman !== 'NANDU') return;
            const currentViewIsLedger = accountantCollectionView.style.display === 'none';
            if (currentViewIsLedger) {
                renderAccountantLedgerView();
            } else {
                renderAccountantCollectionView();
            }
        };

        const renderAccountantLedgerView = (filter = '') => {
            const customerList = document.getElementById('accountant-customer-list');
            const lowerFilter = filter.toLowerCase();
            const filteredCustomers = appState.customers.filter(c => (c.Customer || '').toLowerCase().includes(lowerFilter));
            
            customerList.innerHTML = filteredCustomers.map(c => `
                <div class="list-item" data-customer='${JSON.stringify(c)}'>
                    <div class="info">${c.Customer}</div>
                    <button class="list-item-action">View Ledger</button>
                </div>`).join('');
        };
        
        const renderAccountantCollectionView = () => {
            const container = document.getElementById('accountant-collection-content');
            const salesman = appState.reporting.accountantSalesman;
            const { start, end } = getReportDateRange();
            
            let salesmanPayments = appState.payments[salesman] || []; 
            if (start && end) {
                salesmanPayments = salesmanPayments.filter(p => {
                    const pDate = new Date(p.date);
                    return pDate >= start && pDate <= end;
                });
            }
            
            let totalCash = 0, totalUPI = 0;
            const customerCollections = {};
            salesmanPayments.forEach(p => {
                if (p.method === 'Cash') totalCash += p.amount;
                else if (p.method === 'UPI') totalUPI += p.amount;

                if (!customerCollections[p.customer.Customer]) {
                    customerCollections[p.customer.Customer] = { total: 0, payments: [] };
                }
                customerCollections[p.customer.Customer].total += p.amount;
                customerCollections[p.customer.Customer].payments.push(p);
            });
            const grandTotal = totalCash + totalUPI;

            const customerListHtml = Object.entries(customerCollections).sort((a,b) => b.total - a.total).map(([customer, data]) => `
                <div class="customer-item-container">
                    <div class="customer-item-header">
                         <span class="info">${customer}</span>
                         <strong>${formatPreciseCurrency(data.total)}</strong>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="report-header-card" style="margin-bottom: 20px;">
                    <div><div class="label">Total Collected</div><div class="value">${formatPreciseCurrency(grandTotal)}</div></div>
                    <div><div class="label">Total Cash</div><div class="value">${formatPreciseCurrency(totalCash)}</div></div>
                    <div><div class="label">Total UPI</div><div class="value">${formatPreciseCurrency(totalUPI)}</div></div>
                </div>
                <div class="card">
                    <h3>Collections by Customer</h3>
                    ${customerListHtml || '<p style="text-align:center;padding:20px;">No collections for this period.</p>'}
                </div>
            `;
        };

        const renderAccountantCustomerLedger = (customer) => {
            document.getElementById('accountant-customer-ledger-name').textContent = `Ledger for ${customer.Customer}`;
            const container = document.getElementById('accountant-customer-ledger-content');
            
            const allSales = Object.values(appState.orders).flat().filter(o => o.customer.Customer === customer.Customer && (o.status === 'billed' || o.status === 'loaded' || o.status === 'delivered'));
            const allCollections = Object.values(appState.payments).flat().filter(p => p.customer.Customer === customer.Customer);
            
            const salesTransactions = allSales.map(s => {
                const finalTotal = (s.billedItems || s.items || []).reduce((acc, item) => item.wasUnchecked ? acc : acc + (item.quantity * item.sellingPrice), 0);
                return { date: new Date(s.date), type: `Sale (${s.salesman})`, debit: finalTotal, credit: 0, id: s.id, order: s };
            });
            const collectionTransactions = allCollections.map(p => ({ date: new Date(p.date), type: `Collection (${p.method} via ${p.salesman})`, debit: 0, credit: p.amount, id: p.id }));
            const allTransactions = [...salesTransactions, ...collectionTransactions].sort((a, b) => b.date - a.date);

            const transactionRows = allTransactions.map(t => `
                 <tr>
                    <td>${formatDDMMYYYY(t.date)}</td>
                    <td>${t.type}</td>
                    <td class="numeric">${t.debit > 0 ? formatPreciseCurrency(t.debit) : '-'}</td>
                    <td class="numeric">${t.credit > 0 ? formatPreciseCurrency(t.credit) : '-'}</td>
                </tr>`).join('');
            
            container.innerHTML = `
                <div class="card">
                    <div class="report-header-card"><div><div class="label">Current Balance</div><div class="value" style="color: ${customer.Outstanding > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">${formatCurrency(customer.Outstanding || 0)}</div></div></div>
                    <div class="table-responsive-wrapper"><table class="report-table ledger-table">
                        <thead><tr><th>Date</th><th>Particulars</th><th class="numeric">Debit ()</th><th class="numeric">Credit ()</th></tr></thead>
                        <tbody>${transactionRows || `<tr><td colspan="4" style="text-align:center; padding: 20px;">No transactions found.</td></tr>`}</tbody>
                    </table></div>
                </div>`;
            showPage('page-accountant-customer-ledger');
        };

        document.getElementById('accountant-customer-search').addEventListener('input', e => renderAccountantLedgerView(e.target.value));
        document.getElementById('accountant-customer-list').addEventListener('click', e => {
            const customerItem = e.target.closest('.list-item');
            if (customerItem) {
                const customerData = JSON.parse(customerItem.dataset.customer);
                renderAccountantCustomerLedger(customerData);
            }
        });
        
        document.querySelector('#page-accountant-dashboard .footer').addEventListener('click', e => {
            const ledgerTab = e.target.closest('#accountant-ledger-tab');
            const collectionTab = e.target.closest('#accountant-collection-tab');
            if (ledgerTab) {
                document.getElementById('accountant-ledger-tab').classList.add('active');
                document.getElementById('accountant-collection-tab').classList.remove('active');
                accountantHeader.textContent = 'Customer Ledger';
                accountantLedgerView.style.display = 'block';
                accountantCollectionView.style.display = 'none';
                accountantPrintBtn.style.display = 'none';
                renderAccountantLedgerView();
            } else if (collectionTab) {
                 document.getElementById('accountant-collection-tab').classList.add('active');
                 document.getElementById('accountant-ledger-tab').classList.remove('active');
                accountantHeader.textContent = 'Collection Report';
                accountantLedgerView.style.display = 'none';
                accountantCollectionView.style.display = 'block';
                accountantPrintBtn.style.display = 'block';
                renderAccountantCollectionView();
            }
        });

        document.getElementById('accountant-salesman-toggle').addEventListener('click', e => {
            if (e.target.matches('.toggle-btn')) {
                appState.reporting.accountantSalesman = e.target.dataset.salesman;
                document.querySelectorAll('#accountant-salesman-toggle .toggle-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderAccountantCollectionView();
            }
        });

        accountantPrintBtn.addEventListener('click', () => {
            printPaymentSummary(appState.reporting.accountantSalesman);
        });

        document.querySelector('[data-action="back-to-accountant-main"]').addEventListener('click', () => showPage('page-accountant-dashboard'));
        setupBetweenDateFilter('accountant-date-filter', renderAccountantCollectionView);


        document.getElementById('admin-footer').addEventListener('click', e => {
            const clickedTab = e.target.closest('.footer-button');
            if (!clickedTab) return;

            const dashboardView = document.getElementById('admin-dashboard-view');
            const operationsView = document.getElementById('admin-operations-view');
            const adminHeader = document.getElementById('admin-header');

            document.querySelectorAll('#admin-footer .footer-button').forEach(btn => {
                btn.classList.remove('active');
            });

            clickedTab.classList.add('active');

            if (clickedTab.id === 'admin-dashboard-tab') {
                adminHeader.textContent = 'Admin Dashboard';
                dashboardView.style.display = 'block';
                operationsView.style.display = 'none';
                renderAdminDashboard();
            } else if (clickedTab.id === 'admin-operations-tab') {
                adminHeader.textContent = 'Operations';
                dashboardView.style.display = 'none';
                operationsView.style.display = 'block';
                renderAdminOperationsPage();
            }
        });

        const renderAdminOperationsPage = () => {
            const contentEl = document.getElementById('admin-operations-content');
            const { start, end } = getReportDateRange();
            let allOrders = Object.values(appState.orders).flat();

            if (start && end) {
                allOrders = allOrders.filter(o => {
                    const orderDate = new Date(o.date);
                    return orderDate >= start && orderDate <= end;
                });
            }

            const kpis = {
                avgSalesDuration: [],
                avgPackingDuration: [],
                avgBillingDuration: [],
                totalOrders: allOrders.length,
            };

            allOrders.forEach(o => {
                if(o.salesDuration) kpis.avgSalesDuration.push(o.salesDuration);
                if(o.packingDuration) kpis.avgPackingDuration.push(o.packingDuration);
                if(o.billingDuration) kpis.avgBillingDuration.push(o.billingDuration);
            });

            const avg = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;

            const kpiHtml = `
                <div class="card">
                    <h3>Operational KPIs</h3>
                    <div class="operations-kpi-grid">
                        <div class="kpi-card-small"><div class="value">${kpis.totalOrders}</div><div class="label">Total Orders</div></div>
                        <div class="kpi-card-small"><div class="value">${formatDuration(avg(kpis.avgSalesDuration))}</div><div class="label">Avg. Order Time</div></div>
                        <div class="kpi-card-small"><div class="value">${formatDuration(avg(kpis.avgPackingDuration))}</div><div class="label">Avg. Packing Time</div></div>
                        <div class="kpi-card-small"><div class="value">${formatDuration(avg(kpis.avgBillingDuration))}</div><div class="label">Avg. Billing Time</div></div>
                    </div>
                </div>
            `;

            const userStatusHtml = getUserStatusHtml();
            
            const reportTableHtml = `
                <div class="card">
                    <h3>Order Lifecycle Report</h3>
                    <div class="table-responsive-wrapper">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Customer / Info</th><th>Sales</th><th>Packing</th><th>Billing</th><th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allOrders.sort((a,b) => new Date(b.date) - new Date(a.date)).map(o => {
                                    const items = o.billedItems || o.items || [];
                                    const itemCount = items.filter(i => !i.wasUnchecked).length;
                                    const billedTotal = items.reduce((acc, i) => i.wasUnchecked ? acc : acc + (i.quantity * i.sellingPrice), 0);
                                    
                                    return `<tr>
                                        <td class="customer-info">
                                            <div class="customer-name">${o.customer.Customer}</div>
                                            <small>${o.salesman} | ${itemCount} items | ${formatCurrency(billedTotal)}</small>
                                        </td>
                                        <td class="numeric">${formatDuration(o.salesDuration)}</td>
                                        <td class="numeric">${formatDuration(o.packingDuration)}</td>
                                        <td class="numeric">${formatDuration(o.billingDuration)}</td>
                                        <td class="numeric"><strong>${formatDuration((o.salesDuration||0) + (o.packingDuration||0) + (o.billingDuration||0))}</strong></td>
                                    </tr>`
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            contentEl.innerHTML = kpiHtml + userStatusHtml + reportTableHtml;
        };
                
                const getUserStatusHtml = () => {
            const users = ['UNNI', 'RIYAS', 'ANISHAD', 'MUFEEDA', 'ARFATH', 'SHAJU', 'BENNY'];
            let html = '<h3>Live Status</h3><div class="user-status-grid">';
            const allOrders = Object.values(appState.orders).flat();

            users.forEach(user => {
                const statusData = appState.userStatus[user] || { status: 'idle', task: 'Idle', lastUpdate: null };
                const currentTaskDisplay = (statusData.status === 'active') ? statusData.task : 'Idle';

                let lastActivityInfo = 'N/A';
                
                if (appState.packerAssistants.includes(user)) {
                    const lastPackedOrder = allOrders
                        .filter(o => o.packerAssistant === user && o.packingEndTime)
                        .sort((a, b) => new Date(b.packingEndTime) - new Date(a.packingEndTime))[0]; // <-- ADD [0] HERE
                    if (lastPackedOrder) {
                        lastActivityInfo = `Packed for ${lastPackedOrder.customer.Customer} (${formatDDMMYYYYTime(lastPackedOrder.packingEndTime)})`;
                    }
                } else if (user === 'ARFATH') {
                    const lastBilledOrder = allOrders
                        .filter(o => o.billedBy === 'ARFATH' && o.billedAt)
                        .sort((a, b) => new Date(b.billedAt) - new Date(a.billedAt))[0]; // <-- ADD [0] HERE
                    if (lastBilledOrder) {
                        lastActivityInfo = `Billed for ${lastBilledOrder.customer.Customer} (${formatDDMMYYYYTime(lastBilledOrder.billedAt)})`;
                    }
                } else if (user === 'SHAJU') {
                    // Note: Loading logic might need adjustment if it's batch-based
                    const lastLoadedOrder = allOrders
                        .filter(o => o.loadedAt) // Simplified for now
                        .sort((a, b) => new Date(b.loadedAt) - new Date(a.loadedAt))[0]; // <-- ADD [0] HERE
                    if (lastLoadedOrder) {
                        lastActivityInfo = `Loaded for ${lastLoadedOrder.customer.Customer} (${formatDDMMYYYYTime(lastLoadedOrder.loadedAt)})`;
                    }
                } else if (user === 'BENNY') {
                     const lastDeliveredOrder = allOrders
                        .filter(o => o.deliveredAt)
                        .sort((a, b) => new Date(b.deliveredAt) - new Date(a.deliveredAt))[0]; // <-- ADD [0] HERE
                    if(lastDeliveredOrder) {
                        lastActivityInfo = `Delivered to ${lastDeliveredOrder.customer.Customer} (${formatDDMMYYYYTime(lastDeliveredOrder.deliveredAt)})`;
                    }
                }
                 else { // Salesmen
                    const lastOrder = allOrders
                        .filter(o => o.salesman === user && o.orderSavedAt)
                        .sort((a,b) => new Date(b.orderSavedAt) - new Date(a.orderSavedAt))[0]; // <-- ADD [0] HERE
                    if(lastOrder) {
                        lastActivityInfo = `Order for ${lastOrder.customer.Customer} (${formatDDMMYYYYTime(lastOrder.orderSavedAt)})`;
                    }
                }

                html += `
                    <div class="user-status-card">
                        <h4 data-user="${user}">${user} <span class="status-badge ${statusData.status}">${statusData.status}</span></h4>
                        <p><strong>Current Task:</strong> ${currentTaskDisplay}</p>
                        <p><strong>Last Activity:</strong> ${lastActivityInfo}</p>
                    </div>`;
            });

            html += '</div>';
            return html;
        };
        
        document.getElementById('admin-operations-content').addEventListener('click', e => {
            const userHeader = e.target.closest('h4[data-user]');
            if (userHeader) {
                renderUserTimeline(userHeader.dataset.user);
            }
        });
        
        const renderUserTimeline = (user) => {
            showPage('page-user-timeline');
            document.getElementById('user-timeline-header').textContent = `${user}'s Timeline`;
            const contentEl = document.getElementById('user-timeline-content');
            const { start, end } = getReportDateRange();
            let allOrders = Object.values(appState.orders).flat();

            if (start && end) {
                allOrders = allOrders.filter(o => {
                    const orderDate = new Date(o.date);
                    return orderDate >= start && orderDate <= end;
                });
            }

            const userOrders = allOrders.filter(o => {
                return (o.salesman === user) || (o.packerAssistant === user && o.packingStartTime) || (user === 'ARFATH' && o.billingStartTime) || (user === 'SHAJU' && o.loadingStartTime) || (user === 'BENNY' && o.deliveryStartTime);
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            if(userOrders.length === 0) {
                contentEl.innerHTML = `<div class="card" style="text-align:center; padding: 20px;">No activity found for this user in the selected period.</div>`;
                return;
            }

            let timelineHtml = '';
            if (user === 'SHAJU' || user === 'BENNY') {
                const batches = {};
                const timeKey = user === 'SHAJU' ? 'loadingStartTime' : 'deliveryStartTime';
                const endTimeKey = user === 'SHAJU' ? 'loadedAt' : 'deliveryFinishedAt';

                userOrders.forEach(o => {
                    if (o[timeKey]) {
                        if (!batches[o[timeKey]]) batches[o[timeKey]] = { orders: [], endTime: null };
                        batches[o[timeKey]].orders.push(o);
                        if (o[endTimeKey]) batches[o[timeKey]].endTime = o[endTimeKey];
                    }
                });

                timelineHtml = Object.entries(batches).sort((a,b) => new Date(b) - new Date(a)).map(([startTime, batch]) => `
                     <div class="timeline-order-card">
                        <h4>Batch of ${batch.orders.length} orders</h4>
                         <div class="detail-row"><span class="label">Start:</span> <span class="value">${formatDDMMYYYYTime(startTime)}</span></div>
                        <div class="detail-row"><span class="label">Finish:</span> <span class="value">${batch.endTime ? formatDDMMYYYYTime(batch.endTime) : 'In Progress'}</span></div>
                    </div>
                `).join('');

            } else {
                 timelineHtml = userOrders.map(o => {
                    let detailsHtml = '';
                    if(user === o.salesman) {
                        detailsHtml = `
                            <div class="detail-row"><span class="label">Order Start:</span> <span class="value">${formatDDMMYYYYTime(o.date)}</span></div>
                            <div class="detail-row"><span class="label">Order Finish:</span> <span class="value">${formatDDMMYYYYTime(o.orderSavedAt)}</span></div>
                            <div class="detail-row total-duration"><span class="label">Total Time:</span> <span class="value">${formatDuration(o.salesDuration)}</span></div>
                        `;
                    } else if (appState.packerAssistants.includes(user)) {
                         detailsHtml = `
                            <div class="detail-row"><span class="label">Packing Start:</span> <span class="value">${formatDDMMYYYYTime(o.packingStartTime)}</span></div>
                            <div class="detail-row"><span class="label">Packing Finish:</span> <span class="value">${formatDDMMYYYYTime(o.packingEndTime)}</span></div>
                            <div class="detail-row total-duration"><span class="label">Total Time:</span> <span class="value">${formatDuration(o.packingDuration)}</span></div>
                        `;
                    } else if (user === 'ARFATH') { // Role Swap
                         detailsHtml = `
                            <div class="detail-row"><span class="label">Billing Start:</span> <span class="value">${formatDDMMYYYYTime(o.billingStartTime)}</span></div>
                            <div class="detail-row"><span class="label">Billing Finish:</span> <span class="value">${formatDDMMYYYYTime(o.billedAt)}</span></div>
                            <div class="detail-row total-duration"><span class="label">Total Time:</span> <span class="value">${formatDuration(o.billingDuration)}</span></div>
                        `;
                    } 

                    return `
                        <div class="timeline-order-card">
                            <h4>${o.customer.Customer}</h4>
                            ${detailsHtml}
                        </div>
                    `;
                }).join('');
            }

            contentEl.innerHTML = timelineHtml;
        };
        
        document.getElementById('back-to-operations-from-timeline-btn').addEventListener('click', () => { 
            showPage('page-admin-dashboard'); 
            document.getElementById('admin-dashboard-tab').classList.remove('active');
            document.getElementById('admin-operations-tab').classList.add('active');
            document.getElementById('admin-dashboard-view').style.display = 'none';
            document.getElementById('admin-operations-view').style.display = 'block';
            document.getElementById('admin-header').textContent = 'Operations';
        });

        setupBetweenDateFilter('operations-date-filter', renderAdminOperationsPage);
        
        const renderLoaderHome = () => {
            const container = document.getElementById('loader-order-list');
            const { start, end } = getReportDateRange();

            let pendingLoadOrders = Object.values(appState.orders).flat().filter(o => o.status === 'billed');
            
            if (start && end) {
                 pendingLoadOrders = pendingLoadOrders.filter(o => {
                    const billedDate = new Date(o.billedAt);
                    return billedDate >= start && billedDate <= end;
                });
            }
            
            pendingLoadOrders.sort((a,b) => new Date(b.billedAt) - new Date(a.billedAt));

            if(pendingLoadOrders.length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No orders found for the selected dates.</div>`;
                return;
            }

            container.innerHTML = pendingLoadOrders.map(o => `
                <div class="list-item">
                    <input type="checkbox" data-order-id="${o.id}">
                    <div class="info">
                        <span class="loader-item-name">${o.customer.Customer}</span>
                        <span class="loader-item-details">${o.salesman} | Billed: ${formatDDMMYYYYTime(o.billedAt)}</span>
                    </div>
                </div>`).join('');
        };
        
        document.getElementById('loader-order-list').addEventListener('change', () => {
            const checkedBoxes = document.querySelectorAll('#loader-order-list input[type="checkbox"]:checked');
            document.getElementById('start-loading-batch-btn').disabled = checkedBoxes.length === 0;
        });

        document.getElementById('start-loading-batch-btn').addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('#loader-order-list input[type="checkbox"]:checked');
            appState.currentLoadingBatch = Array.from(checkedBoxes).map(cb => cb.dataset.orderId);
            
            if (appState.currentLoadingBatch.length === 0) return;

            const batch = writeBatch(db);
            const loadingStartTime = new Date().toISOString();
            appState.currentLoadingBatch.forEach(orderId => {
                const orderRef = doc(db, "orders", orderId);
                batch.update(orderRef, { loadingStartTime: loadingStartTime });
            });
            
            await batch.commit();
            await updateUserStatus('active', `Loading Batch (${appState.currentLoadingBatch.length} orders)`);
            renderLoadingInterface();
            showPage('page-loading-interface');
        });
        
        const renderLoadingInterface = () => {
            const container = document.getElementById('loading-batch-customer-list');
            const ordersInBatch = appState.currentLoadingBatch.map(id => Object.values(appState.orders).flat().find(o => o.id === id)).filter(Boolean);
            container.innerHTML = ordersInBatch.map(o => `<div class="list-item" style="padding: 10px 15px;"><div class="info">${o.customer.Customer}</div></div>`).join('');
        };

        document.getElementById('finish-loading-btn').addEventListener('click', async () => {
            const btn = document.getElementById('finish-loading-btn');
            btn.disabled = true;

            const batch = writeBatch(db);
            const loadedAt = new Date().toISOString();

            appState.currentLoadingBatch.forEach(orderId => {
                const orderRef = doc(db, "orders", orderId);
                batch.update(orderRef, { status: 'loaded', loadedAt: loadedAt });
            });

            try {
                await batch.commit();
                await updateUserStatus('idle');
                showToast('Batch loading complete!');
                appState.currentLoadingBatch = [];
                renderLoaderHome();
                showPage('page-loader-home');
            } catch (error) {
                console.error("Error finishing loading batch:", error);
                alert("Failed to update orders. Please try again.");
            } finally {
                btn.disabled = false;
            }
        });
        
        const renderLoaderHistory = () => {
            const container = document.getElementById('loader-history-list');
            const loadedOrders = Object.values(appState.orders).flat().filter(o => o.status === 'loaded' || o.status === 'delivered').sort((a,b) => new Date(b.loadedAt) - new Date(a.loadedAt));

             if(loadedOrders.length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No loading history found.</div>`;
                return;
            }

             container.innerHTML = loadedOrders.map(o => `
                 <div class="history-card">
                    <div class="history-card-header">
                        <div class="info">
                           <p><strong>Customer:</strong> ${o.customer.Customer}</p>
                           <p><strong>Salesman:</strong> ${o.salesman}</p>
                           <p class="date-display">Loaded on: ${formatDDMMYYYYTime(o.loadedAt)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        document.getElementById('loader-history-btn').addEventListener('click', () => { renderLoaderHistory(); showPage('page-loader-history'); });
        document.getElementById('back-to-loader-home-btn').addEventListener('click', () => showPage('page-loader-home'));
        setupBetweenDateFilter('loader-date-filter', renderLoaderHome);

        const renderDeliveryHome = () => {
            const container = document.getElementById('delivery-batch-list');
            const loadedOrders = Object.values(appState.orders).flat().filter(o => o.status === 'loaded');
            
            const batches = {};
            loadedOrders.forEach(o => {
                if (o.loadedAt) {
                    if (!batches[o.loadedAt]) batches[o.loadedAt] = [];
                    batches[o.loadedAt].push(o);
                }
            });

            if (Object.keys(batches).length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No batches pending for delivery.</div>`;
                return;
            }

            container.innerHTML = Object.entries(batches).sort((a, b) => new Date(b) - new Date(a)).map(([loadedAt, orders]) => `
                <div class="list-item">
                    <div class="info">
                        Batch from ${formatDDMMYYYYTime(loadedAt)} (${orders.length} orders)
                    </div>
                    <button class="list-item-action view-delivery-batch-btn" data-batch-id="${loadedAt}">View Batch</button>
                </div>
            `).join('');
        };
        
        document.getElementById('delivery-batch-list').addEventListener('click', e => {
            const viewBtn = e.target.closest('.view-delivery-batch-btn');
            if(viewBtn) {
                const batchId = viewBtn.dataset.batchId;
                const ordersInBatch = Object.values(appState.orders).flat().filter(o => o.loadedAt === batchId);
                const isAlreadyStarted = ordersInBatch.some(o => o.deliveryStartTime);
                appState.currentDeliveryBatch = {
                    id: batchId,
                    orders: ordersInBatch,
                    isStarted: isAlreadyStarted,
                    startTime: isAlreadyStarted ? ordersInBatch.deliveryStartTime : null
                };
                renderDeliveryInterface();
                showPage('page-delivery-interface');
            }
        });
        
        const renderDeliveryInterface = () => {
            const container = document.getElementById('delivery-customer-list');
            const headerActions = document.getElementById('delivery-header-actions');
            const isStarted = appState.currentDeliveryBatch.isStarted;

            headerActions.innerHTML = isStarted 
                ? `<button class="icon-button" id="finish-delivery-btn" title="Finish Trip"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></button>`
                : `<button class="icon-button" id="start-delivery-btn" title="Start Trip"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>`;

            container.innerHTML = appState.currentDeliveryBatch.orders.map(o => `
                 <div class="list-item" data-order-id="${o.id}">
                    <div class="info">${o.customer.Customer}</div>
                    <button class="list-item-action mark-delivered-btn" ${!isStarted || o.status === 'delivered' ? 'disabled' : ''} style="${o.status === 'delivered' ? 'background-color: var(--warning-color); border: 2px solid #c87000; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);' : ''}">${o.status === 'delivered' ? 'Delivered' : 'Completed'}</button>
                </div>
            `).join('');
        };
        
        document.getElementById('delivery-header-actions').addEventListener('click', async e => {
            const startBtn = e.target.closest('#start-delivery-btn');
            const finishBtn = e.target.closest('#finish-delivery-btn');

            if (startBtn) {
                appState.currentDeliveryBatch.isStarted = true;
                const batch = appState.currentDeliveryBatch;
                batch.startTime = new Date().toISOString();
                
                const dbBatch = writeBatch(db);
                batch.orders.forEach(o => {
                    const orderRef = doc(db, "orders", o.id);
                    dbBatch.update(orderRef, { deliveryStartTime: batch.startTime });
                });
                await dbBatch.commit();
                await updateUserStatus('active', `Delivering batch (${batch.orders.length} orders)`);
                renderDeliveryInterface();
            }

            if (finishBtn) {
                const batch = appState.currentDeliveryBatch;
                batch.endTime = new Date().toISOString();
                
                const dbBatch = writeBatch(db);
                batch.orders.forEach(o => {
                    const orderRef = doc(db, "orders", o.id);
                    dbBatch.update(orderRef, { deliveryFinishedAt: batch.endTime });
                });
                await dbBatch.commit();
                await updateUserStatus('idle');
                showToast('Delivery trip finished!');
                appState.currentDeliveryBatch = null;
                renderDeliveryHome();
                showPage('page-delivery-home');
            }
        });

        document.getElementById('delivery-customer-list').addEventListener('click', async e => {
            const markBtn = e.target.closest('.mark-delivered-btn');
            if (markBtn && !markBtn.disabled) {
                const orderId = markBtn.closest('.list-item').dataset.orderId;
                const order = appState.currentDeliveryBatch.orders.find(o => o.id === orderId);
                
                markBtn.disabled = true;
                markBtn.textContent = 'Delivered';
                markBtn.style.backgroundColor = 'var(--warning-color)';
                
                try {
                    await updateDoc(doc(db, "orders", orderId), {
                        status: 'delivered',
                        deliveredAt: new Date().toISOString()
                    });
                     await updateUserStatus('active', `Delivered to ${order.customer.Customer}`);
                } catch(err) {
                     console.error("Failed to mark as delivered:", err);
                     alert('Update failed. Please try again.');
                     markBtn.disabled = false;
                     markBtn.textContent = 'Completed';
                     markBtn.style.backgroundColor = '';
                }
            }
        });
        
        const renderDeliveryHistory = () => {
            const container = document.getElementById('delivery-history-list');
            const deliveredOrders = Object.values(appState.orders).flat().filter(o => o.status === 'delivered' || (o.deliveryStartTime && o.deliveryFinishedAt));
            const batches = {};
            deliveredOrders.forEach(o => {
                if (o.deliveryStartTime) {
                    if (!batches[o.deliveryStartTime]) batches[o.deliveryStartTime] = { orders: [], endTime: null };
                    batches[o.deliveryStartTime].orders.push(o);
                    if (o.deliveryFinishedAt) batches[o.deliveryStartTime].endTime = o.deliveryFinishedAt;
                }
            });
            
             if(Object.keys(batches).length === 0) {
                container.innerHTML = `<div class="card" style="text-align: center;">No delivery history found.</div>`;
                return;
            }

             container.innerHTML = Object.entries(batches).sort((a,b) => new Date(b) - new Date(a)).map(([startTime, batch]) => `
                 <div class="history-card">
                    <div class="history-card-header">
                        <div class="info">
                           <p><strong>Batch of ${batch.orders.length} orders</strong></p>
                           <p class="date-display">Started: ${formatDDMMYYYYTime(startTime)}</p>
                           <p class="date-display">Finished: ${formatDDMMYYYYTime(batch.endTime)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        };
        
        document.getElementById('delivery-history-btn').addEventListener('click', () => { renderDeliveryHistory(); showPage('page-delivery-history'); });
        document.getElementById('back-to-delivery-home-btn').addEventListener('click', () => {
            if (appState.currentDeliveryBatch && appState.currentDeliveryBatch.isStarted) {
                const allDelivered = appState.currentDeliveryBatch.orders.every(o => o.status === 'delivered');
                if(!allDelivered && !confirm("This delivery trip is still in progress. Are you sure you want to go back?")) return;
            }
            updateUserStatus('idle');
            showPage('page-delivery-home');
        });
        document.getElementById('back-to-delivery-home-from-history-btn').addEventListener('click', () => showPage('page-delivery-home'));

        const renderPurchasePlanner = () => {
    // Set "Item Finder" as the active tab by default
    document.querySelectorAll('#page-purchase-planner .footer-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('purchase-item-finder-tab').classList.add('active');

    // Show the "Item Finder" view and hide others
    document.querySelectorAll('.purchase-view').forEach(view => view.classList.remove('active'));
    document.getElementById('purchase-item-finder-view').classList.add('active');

    // Update the header text
    document.getElementById('purchase-planner-header').textContent = 'Item Finder';
    
    // Clear any previous search results
    document.getElementById('item-finder-search-input').value = '';
    document.getElementById('item-finder-search-results').innerHTML = '';
    document.getElementById('item-finder-display-card').style.display = 'none';
};

        const renderPurchaseVendors = (filter = '') => {
        const container = document.getElementById('purchase-vendor-list');
        const lowerFilter = filter.toLowerCase();
        const vendors = appState.purchaseVendors.filter(v => (v.name || '').toLowerCase().includes(lowerFilter));
        if (vendors.length === 0) {
            container.innerHTML = `<p class="card" style="text-align:center; grid-column: 1 / -1;">No vendors found. Add one using the '+' button.</p>`;
            return;
        }
        container.innerHTML = vendors.map(v => `
            <div class="purchase-tile" data-type="vendor" data-id="${v.id}">
                <div class="purchase-tile-info">
                    <h4>${v.name}</h4>
                    <p>Freq: ${v.frequency} days</p>
                </div>
                <button class="icon-button purchase-tile-manage-btn" data-vendor-id="${v.id}" title="Manage Vendor">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        `).join('');
        };

        const renderPurchaseLocations = (filter = '') => {
            const container = document.getElementById('purchase-location-list');
            const lowerFilter = filter.toLowerCase();
            const locations = appState.purchaseLocations.filter(l => (l.name || '').toLowerCase().includes(lowerFilter));
            if (locations.length === 0) {
                container.innerHTML = `<p class="card" style="text-align:center; grid-column: 1 / -1;">No locations found. Add one using the '+' button.</p>`;
                return;
            }
            container.innerHTML = locations.map(l => `
                <div class="purchase-tile" data-type="location" data-id="${l.id}">
                    <h4>${l.name}</h4>
                    <p>Freq: ${l.frequency} days</p>
                </div>
            `).join('');
        };
        const renderPurchaseDetailPage = async (type, id) => {
            const isVendor = type === 'vendor';
            const sourceData = isVendor ? appState.purchaseVendors.find(v => v.id === id) : appState.purchaseLocations.find(l => l.id === id);
            if (!sourceData) {
                alert('Error: Could not find the selected source.');
                return;
            }

            appState.currentPurchaseContext = { type, id, name: sourceData.name, frequency: sourceData.frequency };
            document.getElementById('purchase-detail-header').textContent = sourceData.name;
            const detailList = document.getElementById('purchase-detail-list');
            detailList.innerHTML = `<div class="card">Loading details...</div>`;
            showPage('page-purchase-detail');
            
            // --- Sales Calculation Logic ---
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const salesByItemCode = {};
            Object.values(appState.orders).flat().forEach(order => {
                const orderDate = new Date(order.date);
                if (orderDate >= thirtyDaysAgo) {
                    (order.billedItems || order.items || []).forEach(item => {
                        if (!item.wasUnchecked) {
                            const code = item.item.Code;
                            if (!salesByItemCode[code]) salesByItemCode[code] = 0;
                            salesByItemCode[code] += item.quantity;
                        }
                    });
                }
            });

            // --- Fetch and Render Items/Vendors ---
            if (isVendor) {
                const itemsSnapshot = await getDocs(collection(db, 'purchaseVendors', id, 'vendorItems'));
                const vendorItems = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (vendorItems.length === 0) {
                    detailList.innerHTML = `<p class="card" style="text-align:center;">No items assigned to this vendor. Add one using the '+' button.</p>`;
                    return;
                }

                const tableRowsHtml = vendorItems.map(pItem => {
                    const masterItem = appState.items.find(i => i.Code === pItem.itemCode);
                    if (!masterItem) return '';
                    const totalSalesLast30Days = salesByItemCode[pItem.itemCode] || 0;
                    const avgDailySales = totalSalesLast30Days / 30;
                    const requiredStock = avgDailySales * sourceData.frequency * 1.25; // 25% buffer
                    const suggestedPurchase = Math.max(0, Math.ceil(requiredStock - masterItem.Clstock));
                    return `<tr>
                                <td class="col-item-name">${masterItem.ItemName}</td>
                                <td class="col-stock">${masterItem.Clstock || 0}</td>
                                <td class="col-suggest">${suggestedPurchase}</td>
                            </tr>`;
                }).join('');

                detailList.innerHTML = `<div class="card table-responsive-wrapper"><table class="purchase-detail-table"><thead><tr><th class="col-item-name">Item Name</th><th class="col-stock">Total Stock</th><th class="col-suggest">Suggested</th></tr></thead><tbody>${tableRowsHtml}</tbody></table></div>`;
            } else { // Is Location
                const vendorsSnapshot = await getDocs(collection(db, 'purchaseLocations', id, 'locationVendors'));
                const locationVendors = vendorsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (locationVendors.length === 0) {
                    detailList.innerHTML = `<p class="card" style="text-align:center;">No vendors assigned to this location. Add one using the '+' button.</p>`;
                    return;
                }
                
                detailList.innerHTML = '<div class="tile-grid">' + locationVendors.map(lv => {
                    const masterVendor = appState.purchaseVendors.find(v => v.id === lv.vendorId);
                    if (!masterVendor) return '';
                    return `<div class="purchase-tile" data-type="vendor" data-id="${masterVendor.id}"><h4>${masterVendor.name}</h4><p>Freq: ${masterVendor.frequency} days</p></div>`;
                }).join('') + '</div>';
            }
        };


        const handlePurchaseTileClick = (e) => {
            const tile = e.target.closest('.purchase-tile');
            if (tile) {
                const { type, id } = tile.dataset;
                renderPurchaseDetailPage(type, id);
            }
        };

        document.getElementById('purchase-vendor-list').addEventListener('click', handlePurchaseTileClick);
        document.getElementById('purchase-location-list').addEventListener('click', handlePurchaseTileClick);
        document.getElementById('purchase-detail-list').addEventListener('click', handlePurchaseTileClick);
        document.getElementById('back-to-purchase-planner-btn').addEventListener('click', () => showPage('page-purchase-planner'));

        const addItemToPurchaseListModal = document.getElementById('add-item-to-purchase-list-modal');
        const addVendorToLocationModal = document.getElementById('add-vendor-to-location-modal');
        
        document.getElementById('add-item-to-purchase-list-fab').addEventListener('click', () => {
             const context = appState.currentPurchaseContext;
            if (context.type === 'vendor') {
                document.getElementById('purchase-item-search-input').value = '';
                document.getElementById('purchase-item-search-results').innerHTML = '';
                addItemToPurchaseListModal.classList.add('active');
            } else if (context.type === 'location') {
                renderAddVendorToLocationModal();
                addVendorToLocationModal.classList.add('active');
            }
        });

        [addItemToPurchaseListModal, addVendorToLocationModal].forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal || e.target.closest('[data-action="close"]')) {
                    modal.classList.remove('active');
                }
            });
        });

        document.getElementById('purchase-item-search-input').addEventListener('input', e => {
            renderItemSearchResults(e.target.value, 'purchase-item-search-results', false);
        });

        document.getElementById('purchase-item-search-results').addEventListener('click', async e => {
            const itemElement = e.target.closest('.search-result-item');
            if (itemElement) {
                const itemCode = itemElement.dataset.itemCode;
                const masterItem = appState.items.find(i => i.Code === itemCode);
                if (!masterItem) return;
                
                addItemToPurchaseListModal.classList.remove('active');

                try {
                    const { type, id } = appState.currentPurchaseContext;
                    if (type !== 'vendor') return;
                    await addDoc(collection(db, 'purchaseVendors', id, 'vendorItems'), { itemCode });
                    showToast('Item added successfully.');
                    renderPurchaseDetailPage(type, id);
                } catch (error) {
                    console.error("Error adding item to vendor:", error);
                    alert("Failed to add item. Please try again.");
                }
            }
        });

        const renderAddVendorToLocationModal = async () => {
            const modalBody = document.getElementById('add-vendor-to-location-modal-body');
            modalBody.innerHTML = '<p>Loading vendors...</p>';
            const locationId = appState.currentPurchaseContext.id;
            const existingVendorsSnapshot = await getDocs(collection(db, 'purchaseLocations', locationId, 'locationVendors'));
            const existingVendorIds = new Set(existingVendorsSnapshot.docs.map(doc => doc.data().vendorId));
            
            const availableVendors = appState.purchaseVendors.filter(v => !existingVendorIds.has(v.id));

            if (availableVendors.length === 0) {
                modalBody.innerHTML = '<p>All available vendors have already been added to this location.</p>';
                return;
            }
            modalBody.innerHTML = availableVendors.map(v => `<div class="list-item"><div class="info">${v.name}</div><button class="list-item-action add-vendor-to-location-btn" data-vendor-id="${v.id}">Add</button></div>`).join('');
        };
        
        document.getElementById('add-vendor-to-location-modal-body').addEventListener('click', async e => {
            const addBtn = e.target.closest('.add-vendor-to-location-btn');
            if (addBtn) {
                const vendorId = addBtn.dataset.vendorId;
                addVendorToLocationModal.classList.remove('active');
                try {
                    const { type, id } = appState.currentPurchaseContext;
                    if (type !== 'location') return;
                    await addDoc(collection(db, 'purchaseLocations', id, 'locationVendors'), { vendorId });
                    showToast('Vendor added to location.');
                    renderPurchaseDetailPage(type, id);
                } catch (error) {
                    console.error("Error adding vendor to location:", error);
                    alert("Failed to add vendor. Please try again.");
                }
            }
        });
        
        const addVendorModal = document.getElementById('add-vendor-modal');
        const addLocationModal = document.getElementById('add-location-modal');

        // --- Event Listeners for FABs to OPEN modals ---
        document.getElementById('add-vendor-fab').addEventListener('click', () => {
            document.getElementById('new-vendor-name').value = '';
            document.getElementById('new-vendor-frequency').value = '';
            addVendorModal.classList.add('active');
        });

        document.getElementById('add-location-fab').addEventListener('click', () => {
            document.getElementById('new-location-name').value = '';
            document.getElementById('new-location-frequency').value = '';
            addLocationModal.classList.add('active');
        });

        // --- Generic Event Listeners to CLOSE modals ---
        [addVendorModal, addLocationModal].forEach(modal => {
            modal.addEventListener('click', e => {
                // Close if background or a "cancel" button is clicked
                if (e.target === modal || e.target.closest('[data-action="close"]')) {
                    modal.classList.remove('active');
                }
            });
        });

        // --- Logic to SAVE a new Vendor ---
        document.getElementById('save-new-vendor-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const name = document.getElementById('new-vendor-name').value.trim();
            const frequency = parseInt(document.getElementById('new-vendor-frequency').value);

            if (!name || isNaN(frequency) || frequency <= 0) {
                alert('Please enter a valid name and a positive number for frequency.');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Saving...';
            try {
                await addDoc(collection(db, "purchaseVendors"), { name, frequency });
                showToast('Vendor added successfully!');
                addVendorModal.classList.remove('active');
            } catch (error) {
                console.error("Error adding vendor:", error);
                alert('Failed to add vendor. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Vendor';
            }
        });

        // --- Logic to SAVE a new Location ---
        document.getElementById('save-new-location-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const name = document.getElementById('new-location-name').value.trim();
            const frequency = parseInt(document.getElementById('new-location-frequency').value);

            if (!name || isNaN(frequency) || frequency <= 0) {
                alert('Please enter a valid name and a positive number for frequency.');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Saving...';
            try {
                await addDoc(collection(db, "purchaseLocations"), { name, frequency });
                showToast('Location added successfully!');
                addLocationModal.classList.remove('active');
            } catch (error) {
                console.error("Error adding location:", error);
                alert('Failed to add location. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Location';
            }
        });

        document.getElementById('purchase-vendor-search').addEventListener('input', e => renderPurchaseVendors(e.target.value));
        document.getElementById('purchase-location-search').addEventListener('input', e => renderPurchaseLocations(e.target.value));

        document.querySelector('#page-purchase-planner .footer').addEventListener('click', e => {
            const tab = e.target.closest('.footer-button');
    if (!tab) return;
    
    document.querySelectorAll('#page-purchase-planner .footer-button').forEach(btn => btn.classList.remove('active'));
    tab.classList.add('active');
    
    document.querySelectorAll('.purchase-view').forEach(view => view.classList.remove('active'));
    const header = document.getElementById('purchase-planner-header');

    if (tab.id === 'purchase-item-finder-tab') {
        document.getElementById('purchase-item-finder-view').classList.add('active');
        header.textContent = 'Item Finder';
    } else if (tab.id === 'purchase-vendors-tab') {
        document.getElementById('purchase-vendors-view').classList.add('active');
        header.textContent = 'Vendors';
        renderPurchaseVendors();
    } else if (tab.id === 'purchase-locations-tab') {
        document.getElementById('purchase-locations-view').classList.add('active');
        header.textContent = 'Locations';
        renderPurchaseLocations();
            }
        });
        const renderItemFinderSearchResults = (filter = '') => {
    const resultsContainer = document.getElementById('item-finder-search-results');
    const displayCard = document.getElementById('item-finder-display-card');
    displayCard.style.display = 'none'; // Hide the details card while searching

    if (!filter) {
        resultsContainer.innerHTML = '';
        return;
    }

    const lowerFilter = filter.toLowerCase();
    const filteredItems = appState.items.filter(item =>
        (item.ItemName || '').toLowerCase().includes(lowerFilter)
    ).slice(0, 50); // Limit results for better performance

    if (filteredItems.length === 0) {
        resultsContainer.innerHTML = '<p style="text-align: center; padding: 20px;">No items found.</p>';
        return;
    }

    resultsContainer.innerHTML = filteredItems.map(item => `
        <div class="search-result-item" data-item-code="${item.Code}">
            ${item.ItemName}
        </div>
    `).join('');
};

const renderItemFinderDisplayCard = (item) => {
    const displayCard = document.getElementById('item-finder-display-card');
    if (!item) {
        displayCard.style.display = 'none';
        return;
    }

    const margin = item.Price2 > 0 ? (((item.Price2 - item.CostRate) / item.Price2) * 100) : 0;
    const marginClass = margin >= 0 ? 'profit' : 'loss';
    
    // Helper function for stock color, consistent with other parts of the app
    const stockColor = (stock) => stock > 10 ? 'var(--success-color)' : (stock > 0 ? 'var(--warning-color)' : 'var(--danger-color)');

    displayCard.innerHTML = `
        <h3>${item.ItemName}</h3>
        <div class="price-grid">
            <div class="price-item">
                <div class="label">Cost</div>
                <div class="value">${formatPreciseCurrency(item.CostRate)}</div>
            </div>
            <div class="price-item">
                <div class="label">P2</div>
                <div class="value">${formatPreciseCurrency(item.Price2)}</div>
            </div>
            <div class="price-item">
                <div class="label">P2 Margin</div>
                <div class="value ${marginClass}">${margin.toFixed(1)}%</div>
            </div>
            <div class="price-item">
                <div class="label">MRP</div>
                <div class="value">${formatPreciseCurrency(item.Mrp)}</div>
            </div>
            <div class="price-item">
                <div class="label">Stock</div>
                <div class="value" style="color: ${stockColor(item.Clstock)};">${item.Clstock} ${item.Unit || ''}</div>
            </div>
        </div>
    `;
    displayCard.style.display = 'block';
};

document.getElementById('item-finder-search-input').addEventListener('input', e => {
    renderItemFinderSearchResults(e.target.value);
});

document.getElementById('item-finder-search-results').addEventListener('click', e => {
    const resultItem = e.target.closest('.search-result-item');
    if (resultItem) {
        const itemCode = resultItem.dataset.itemCode;
        const selectedItem = appState.items.find(i => i.Code === itemCode);

        // Hide the search list and show the details card
        document.getElementById('item-finder-search-input').value = selectedItem.ItemName;
        document.getElementById('item-finder-search-results').innerHTML = '';
        renderItemFinderDisplayCard(selectedItem);
    }
});
        // Find your existing printPurchasePlanner function and replace it with this.
const printPurchasePlanner = async () => { // Note: Added 'async'
    const context = appState.currentPurchaseContext;
    if (!context) return;

    let tableBodyHtml;
    
    // Check if we are on a Location's detail page
    if (context.type === 'location') {
        // --- This is the NEW LOGIC for locations ---
        const itemsToPrint = await generateLocationPlannerData(context.id);
        
        if (!itemsToPrint || itemsToPrint.length === 0) {
            alert("There are no items associated with this location to print.");
            return;
        }

        tableBodyHtml = itemsToPrint.map(item => `
            <tr>
                <td class="col-item-name">${item.itemName}</td>
                <td class="col-stock">${item.stock}</td>
                <td class="col-suggest">${item.suggested}</td>
                <td class="blank-col"></td>
            </tr>
        `).join('');

    } else { 
        // --- This is the EXISTING LOGIC for a single vendor ---
        const tableBodyEl = document.querySelector('#page-purchase-detail .purchase-detail-table tbody');
        if (!tableBodyEl) { 
            alert("There are no items to print."); 
            return; 
        }
        tableBodyHtml = tableBodyEl.innerHTML;
    }

    // This final part remains the same for both cases
    const printContent = `
        <div class="print-header">
            <h2>Purchase Planner</h2>
            <p><strong>${context.type.charAt(0).toUpperCase() + context.type.slice(1)}:</strong> ${context.name}</p>
            <p><strong>Date:</strong> ${formatDDMMYYYY(new Date())}</p>
        </div>
        <table class="print-table">
            <thead>
                <tr>
                    <th class="col-item-name">Item Name</th>
                    <th class="col-stock">Total Stock</th>
                    <th class="col-suggest">Suggested</th>
                    <th class="blank-col">Actual</th>
                </tr>
            </thead>
            <tbody>${tableBodyHtml}</tbody>
        </table>`;

    document.getElementById('purchase-planner-print-content').innerHTML = printContent;
    document.body.classList.add('printing', 'printing-purchase-planner');
    setTimeout(() => window.print(), 200);
};
// Add this new helper function to your script
const generateLocationPlannerData = async (locationId) => {
    const location = appState.purchaseLocations.find(l => l.id === locationId);
    if (!location) return [];

    // 1. Get all vendors associated with this location
    const vendorsSnapshot = await getDocs(collection(db, 'purchaseLocations', locationId, 'locationVendors'));
    const vendorIds = vendorsSnapshot.docs.map(doc => doc.data().vendorId);
    if (vendorIds.length === 0) return [];

    // 2. Fetch all items for all those vendors at the same time
    const itemPromises = vendorIds.map(vid => getDocs(collection(db, 'purchaseVendors', vid, 'vendorItems')));
    const vendorItemSnapshots = await Promise.all(itemPromises);

    // 3. Consolidate into a single list of unique item codes
    const allItemCodes = vendorItemSnapshots.flat().map(snapshot => snapshot.docs.map(doc => doc.data().itemCode)).flat();
    const uniqueItemCodes = [...new Set(allItemCodes)];

    // 4. Calculate sales data from the last 30 days (this logic is similar to what you already have)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const salesByItemCode = {};
    Object.values(appState.orders).flat().forEach(order => {
        const orderDate = new Date(order.date);
        if (orderDate >= thirtyDaysAgo && (order.status === 'billed' || order.status === 'loaded' || order.status === 'delivered')) {
            (order.billedItems || order.items || []).forEach(item => {
                if (!item.wasUnchecked) {
                    const code = item.item.Code;
                    if (!salesByItemCode[code]) salesByItemCode[code] = 0;
                    salesByItemCode[code] += item.quantity;
                }
            });
        }
    });

    // 5. Create the final data array for printing
    const plannerData = uniqueItemCodes.map(code => {
        const masterItem = appState.items.find(i => i.Code === code);
        if (!masterItem) return null; // Skip if item not found in master list

        const totalSalesLast30Days = salesByItemCode[code] || 0;
        const avgDailySales = totalSalesLast30Days / 30;
        
        // IMPORTANT: Use the LOCATION's frequency for the calculation
        const requiredStock = avgDailySales * location.frequency * 1.25; // 25% buffer
        const suggestedPurchase = Math.max(0, Math.ceil(requiredStock - masterItem.Clstock));
        
        return {
            itemName: masterItem.ItemName,
            stock: masterItem.Clstock || 0,
            suggested: suggestedPurchase
        };
    }).filter(Boolean); // Filter out any null items

    // Sort the final list alphabetically by item name for a clean printout
    return plannerData.sort((a, b) => a.itemName.localeCompare(b.itemName));
};
        
        document.getElementById('print-planner-btn').addEventListener('click', printPurchasePlanner);

        const renderPackingInterface = () => {
            const order = appState.packingOrder;
            document.getElementById('packing-interface-order-customer').textContent = `Packing for ${order.customer.Customer}`;
            const itemList = document.getElementById('assistant-packing-item-list');
            
            itemList.innerHTML = order.items.map((itemData, index) => `
                <div class="list-item">
                    <input type="checkbox" data-index="${index}" ${itemData.wasUnchecked ? '' : 'checked'}>
                    <div class="info">
                        <span class="assistant-packing-item-name">${itemData.item.ItemName}</span>
                        <span class="assistant-packing-item-details">
                            QTY: ${itemData.quantity} ${itemData.item.Unit || ''} | MRP: ${formatPreciseCurrency(itemData.item.Mrp)}
                        </span>
                    </div>
                </div>
            `).join('');
        };

        document.getElementById('packer-assistant-order-list').addEventListener('click', async e => {
            const startBtn = e.target.closest('.start-pack-btn');
            const finishBtn = e.target.closest('.finish-pack-btn');

            if (startBtn) {
                const orderId = startBtn.dataset.orderId;
                const order = Object.values(appState.orders).flat().find(o => o.id === orderId);
                appState.packingOrder = JSON.parse(JSON.stringify(order));

                await updateDoc(doc(db, "orders", orderId), {
                    packingStartTime: new Date().toISOString()
                });
                
                updateUserStatus('active', `Packing for ${order.customer.Customer}`);
                renderPackingInterface();
                showPage('page-packing-interface');
            }

            if(finishBtn) {
                const orderId = finishBtn.dataset.orderId;
                const order = Object.values(appState.orders).flat().find(o => o.id === orderId);
                appState.packingOrder = JSON.parse(JSON.stringify(order));
                renderPackingInterface();
                showPage('page-packing-interface');
            }
        });

        document.getElementById('assistant-packing-item-search').addEventListener('input', e => {
            renderItemSearchResults(e.target.value, 'assistant-packing-item-search-results');
        });

        document.getElementById('assistant-packing-item-search-results').addEventListener('click', e => {
            const resultItem = e.target.closest('.search-result-item');
            if (resultItem) {
                const item = appState.items.find(i => i.Code == resultItem.dataset.itemCode);
                const qty = prompt(`Enter quantity for ${item.ItemName}:`);
                const qtyNum = parseFloat(qty);
                if(qty && !isNaN(qtyNum) && qtyNum > 0) {
                    
                    // ADD THIS BLOCK TO PRESERVE CHECKBOX STATE
                    document.querySelectorAll('#assistant-packing-item-list input[type="checkbox"]').forEach(checkbox => {
                        const index = parseInt(checkbox.dataset.index);
                        if (!checkbox.checked) {
                            appState.packingOrder.items[index].wasUnchecked = true;
                        } else {
                            delete appState.packingOrder.items[index].wasUnchecked;
                        }
                    });
                    // END OF ADDED BLOCK

                    appState.packingOrder.items.push({ item, quantity: qtyNum, sellingPrice: item.Price2, isNew: true });
                    renderPackingInterface();
                }
                document.getElementById('assistant-packing-item-search').value = '';
                document.getElementById('assistant-packing-item-search-results').innerHTML = '';
            }
        });

        document.getElementById('finish-packing-btn').addEventListener('click', async () => {
             const btn = document.getElementById('finish-packing-btn');
            btn.disabled = true;

            const packingOrder = appState.packingOrder;
            const orderId = packingOrder.id;

            packingOrder.items.forEach((item, index) => {
                const checkbox = document.querySelector(`#assistant-packing-item-list input[data-index="${index}"]`);
                if (checkbox && !checkbox.checked) { item.wasUnchecked = true; } 
                else { delete item.wasUnchecked; }
            });

            const endTime = new Date();
            const startTime = new Date(packingOrder.packingStartTime);
            const packingDuration = endTime - startTime;

            try {
                await updateDoc(doc(db, "orders", orderId), {
                    status: 'packed',
                    items: packingOrder.items,
                    packingEndTime: endTime.toISOString(),
                    packingDuration: packingDuration
                });
                updateUserStatus('idle', `Finished packing for ${packingOrder.customer.Customer}`);
                showToast('Packing Finished!');
                showPage('page-packer-assistant');
            } catch(err) {
                 console.error("Failed to finish packing:", err);
                 alert('Update failed. Please try again.');
            } finally {
                appState.packingOrder = null;
                btn.disabled = false;
            }
        });
        document.getElementById('back-to-packer-assistant-home-btn').addEventListener('click', () => showPage('page-packer-assistant'));
        
        const setupPWA = () => { const manifest = { name: "MF BigMarket Orders", short_name: "BigMarket", start_url: ".", display: "standalone", background_color: "#e0f7fa", theme_color: "#005f73", description: "An order and payment management app.", icons: [{ src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48Y2lyY2xlIGN4PSI5NiIgY3k9Ijk2IiByPSI5NiIgZmlsbD0iIzAwNWY3MyIvPjx0ZXh0IHg9Ijk2IiB5PSIxMzYiIGZvbnQtZm1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iOTAiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIj5NRjwvdGV4dD48L3N2Zz4=", sizes: "192x192", type: "image/svg+xml" }]}; const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'}); const manifestUrl = URL.createObjectURL(manifestBlob); document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`); if ('serviceWorker' in navigator && (location.protocol === 'https' || location.hostname === 'localhost')) { const swCode = `const CACHE_NAME = 'mf-bigmarket-v9'; const URLS_TO_CACHE = []; self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME))); self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('/')))));`; const swBlob = new Blob([swCode], { type: 'application/javascript' }); const swUrl = URL.createObjectURL(swBlob); window.addEventListener('load', () => { navigator.serviceWorker.register(swUrl).then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err)); }); } };
        
        // ===============================================
        // START: HR ATTENDANCE FEATURE LOGIC (REVISED)
        // ===============================================

        const renderHRPage = async () => {
            const gridContainer = document.getElementById('hr-user-grid');
            gridContainer.innerHTML = '<p>Loading employee status...</p>';

            const todayStr = new Date().toISOString().split('T')[0];
            let dailyStatus = {};
            
            try {
                const statusDoc = await getDoc(doc(db, "daily_attendance_status", todayStr));
                if (statusDoc.exists()) {
                    dailyStatus = statusDoc.data();
                }
            } catch (error) {
                console.error("Could not fetch daily attendance status:", error);
            }

            const employees = ['UNNI', 'RIYAS', 'SUNNY', 'SHAJU', 'BENNY', 'ARFATH', 'NANDU', 'ANISHAD', 'MUFEEDA', 'FASAL'];
            
            let tilesHtml = employees.map(name => {
                const status = dailyStatus[name] || 'clock_out'; // Default to clocked out
                return `
                <div class="hr-user-tile" data-username="${name}" data-status="${status}">
                    <button class="calendar-btn" title="View Calendar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </button>
                    <span class="status-dot"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span>${name}</span>
                </div>`;
            }).join('');
            
            tilesHtml += `
                <div class="hr-user-tile admin-tile" data-username="ADMIN">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span>Attendance Report</span>
                </div>`;

            gridContainer.innerHTML = tilesHtml;
        };

        const openAttendanceModal = (username, status) => {
            const modal = document.getElementById('attendance-modal');
            const modalBody = document.getElementById('attendance-modal-body');
            document.getElementById('attendance-modal-title').textContent = `Attendance for ${username}`;
            const timeNow = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            if (status === 'clock_in') {
                modalBody.innerHTML = `<p>Clocked IN. Current time is ${timeNow}.</p><button id="clock-out-btn" class="button" style="background: var(--danger-color); margin-top: 20px;" data-username="${username}">Clock OUT</button>`;
            } else {
                modalBody.innerHTML = `<p>Clocked OUT. Current time is ${timeNow}.</p><button id="clock-in-btn" class="button" style="background: var(--success-color); margin-top: 20px;" data-username="${username}">Clock IN</button>`;
            }
            modal.classList.add('active');
        };
        
        document.getElementById('hr-user-grid').addEventListener('click', e => {
            const tile = e.target.closest('.hr-user-tile');
            if (!tile) return;
            const username = tile.dataset.username;

            if (e.target.closest('.calendar-btn')) {
openAttendanceCalendar(username);
} else if (username === 'ADMIN') {
showPage('page-hr-admin-report');
renderHRAttendanceReport();
} else {
const status = tile.dataset.status;
openAttendanceModal(username, status);
}
});    document.getElementById('attendance-modal').addEventListener('click', async (e) => {
        const modal = document.getElementById('attendance-modal');
        const modalBody = document.getElementById('attendance-modal-body');

        if (e.target === modal || e.target.closest('[data-action="close-attendance"]')) {
            modal.classList.remove('active');
            return;
        }

        const clockInBtn = e.target.closest('#clock-in-btn');
        const clockOutBtn = e.target.closest('#clock-out-btn');
        if (!clockInBtn && !clockOutBtn) return;

        const btn = clockInBtn || clockOutBtn;
        const username = btn.dataset.username;
        const type = clockInBtn ? 'clock_in' : 'clock_out';
        const usersToExcludeFromGeoFence = ['UNNI', 'RIYAS'];

        btn.disabled = true;
        modalBody.innerHTML = '<p>Processing... Please wait.</p>';

        try {
            if (!usersToExcludeFromGeoFence.includes(username)) {
                modalBody.innerHTML = '<p>Getting shop location...</p>';
                const shopLocationDoc = await getDoc(doc(db, "app_config", "shop_location"));
                if (!shopLocationDoc.exists()) throw new Error("Shop location is not set. Admin must set it.");
                
                modalBody.innerHTML = '<p>Getting your current location... Please approve.</p>';
                const userPosition = await getCurrentLocation();
                const distance = calculateDistance(shopLocationDoc.data().latitude, shopLocationDoc.data().longitude, userPosition.lat, userPosition.lng);

                if (distance > 200) { // 200 meters radius
                    throw new Error(`You are ${distance.toFixed(0)}m away. Must be within 200m.`);
                }
            }
            
            modalBody.innerHTML = '<p>Saving attendance...</p>';
const todayStr = new Date().toISOString().split('T')[0]; // Add [0] to get the date string
const statusRef = doc(db, "daily_attendance_status", todayStr); // Use the correct string variable
const batch = writeBatch(db);
const logRef = doc(collection(db, "attendance_logs"));
batch.set(logRef, { username, type, timestamp: new Date().toISOString() });
batch.set(statusRef, { [username]: type }, { merge: true });
await batch.commit();

            showToast(`Successfully ${type.replace('_', ' ')} for ${username}`);
            modal.classList.remove('active');
            await renderHRPage();

        } catch (error) {
            console.error("Attendance marking failed:", error);
            modalBody.innerHTML = `<p style="color: var(--danger-color); font-weight: bold;">Error</p><p>${error.message}</p>`;
        }
    });

    document.getElementById('back-to-hr-dashboard-btn').addEventListener('click', () => showPage('page-hr'));

    const renderHRAttendanceReport = async () => {
        const container = document.getElementById('hr-report-container');
        container.innerHTML = '<p>Loading report...</p>';

        try {
            const logsSnapshot = await getDocs(collection(db, "attendance_logs"));
            if (logsSnapshot.empty) {
                container.innerHTML = '<p style="text-align:center; padding: 20px;">No attendance records found.</p>';
                return;
            }
            const allLogs = logsSnapshot.docs.map(doc => doc.data());
            const { start, end } = getReportDateRange();

            const filteredLogs = allLogs.filter(log => {
                const logDate = new Date(log.timestamp);
                return logDate >= start && logDate <= end;
            });
            
            if (filteredLogs.length === 0) {
                 container.innerHTML = '<p style="text-align:center; padding: 20px;">No records for the selected dates.</p>';
                 return;
            }

            const employeeData = {};
            filteredLogs.forEach(log => {
                if (!employeeData[log.username]) employeeData[log.username] = [];
                employeeData[log.username].push({ type: log.type, time: new Date(log.timestamp) });
            });

            const reportData = {};
            for (const username in employeeData) {
                const userLogs = employeeData[username].sort((a, b) => a.time - b.time);
                const dailyDurations = {};

                userLogs.forEach(log => {
                    const dateStr = log.time.toISOString().split('T');
                    if (!dailyDurations[dateStr]) dailyDurations[dateStr] = { duration: 0, lastIn: null };
                    
                    if (log.type === 'clock_in') {
                        if (!dailyDurations[dateStr].lastIn) dailyDurations[dateStr].lastIn = log.time;
                    } else if (log.type === 'clock_out' && dailyDurations[dateStr].lastIn) {
                        dailyDurations[dateStr].duration += log.time - dailyDurations[dateStr].lastIn;
                        dailyDurations[dateStr].lastIn = null;
                    }
                });

                // Handle cases where a user forgot to clock out
                Object.keys(dailyDurations).forEach(dateStr => {
                    if (dailyDurations[dateStr].lastIn) {
                        const clockInTime = dailyDurations[dateStr].lastIn;
                        const endOfDay = new Date(clockInTime);
                        endOfDay.setHours(20, 0, 0, 0); // 8 PM
                        if (endOfDay > clockInTime) {
                            dailyDurations[dateStr].duration += endOfDay - clockInTime;
                        }
                    }
                });

                reportData[username] = { fullDays: 0, halfDays: 0, totalHours: 0 };
                Object.values(dailyDurations).forEach(day => {
                    const hours = day.duration / (1000 * 60 * 60);
                    reportData[username].totalHours += hours;
                    if (hours >= 5) reportData[username].fullDays++;
                    else if (hours > 0) reportData[username].halfDays++;
                });
            }
            
            const formatTotalHours = (totalHours) => {
                const h = Math.floor(totalHours);
                const m = Math.round((totalHours - h) * 60);
                return `${h}h ${m}m`;
            };

            const tableRowsHtml = Object.keys(reportData).sort().map(username => `
                <tr>
                    <td>${username}</td>
                    <td class="numeric">${reportData[username].fullDays}</td>
                    <td class="numeric">${reportData[username].halfDays}</td>
                    <td class="numeric col-hours">${formatTotalHours(reportData[username].totalHours)}</td>
                </tr>
            `).join('');
            
            container.innerHTML = `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th class="numeric">Full Days</th>
                            <th class="numeric">Half Days</th>
                            <th class="numeric">Total Hours</th>
                        </tr>
                    </thead>
                    <tbody>${tableRowsHtml}</tbody>
                </table>
            `;
        } catch (error) {
            console.error("Error generating attendance report:", error);
            container.innerHTML = '<p style="color: var(--danger-color);">Could not load the report. Please try again.</p>';
        }
    };

    const openAttendanceCalendar = (username) => {
        const now = new Date();
        appState.calendarContext = { username, year: now.getFullYear(), month: now.getMonth() };
        renderAttendanceCalendar();
        document.getElementById('attendance-calendar-modal').classList.add('active');
    };

    const renderAttendanceCalendar = async () => {
        const { username, year, month } = appState.calendarContext;
        document.getElementById('calendar-modal-title').textContent = `${username}'s Calendar`;
        document.getElementById('calendar-month-year').textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '<div class="day-name">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div><div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name">Sat</div>';

        const logsSnapshot = await getDocs(collection(db, "attendance_logs"));
        const allLogs = logsSnapshot.docs.map(doc => doc.data());
        const userLogs = allLogs.filter(log => log.username === username).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

        const dailyDurations = {};
        userLogs.forEach(log => {
            const logDate = new Date(log.timestamp);
            if (logDate.getFullYear() === year && logDate.getMonth() === month) {
                const dateStr = logDate.toISOString().split('T');
                if (!dailyDurations[dateStr]) dailyDurations[dateStr] = { duration: 0, lastIn: null };
                if (log.type === 'clock_in' && !dailyDurations[dateStr].lastIn) dailyDurations[dateStr].lastIn = logDate;
                else if (log.type === 'clock_out' && dailyDurations[dateStr].lastIn) {
                    dailyDurations[dateStr].duration += logDate - dailyDurations[dateStr].lastIn;
                    dailyDurations[dateStr].lastIn = null;
                }
            }
        });

        Object.keys(dailyDurations).forEach(dateStr => {
            if (dailyDurations[dateStr].lastIn) {
                const clockInTime = dailyDurations[dateStr].lastIn;
                const endOfDay = new Date(clockInTime);
                endOfDay.setHours(20, 0, 0, 0);
                if (endOfDay > clockInTime) dailyDurations[dateStr].duration += endOfDay - clockInTime;
            }
        });

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        for (let i = 0; i < firstDay.getDay(); i++) { grid.innerHTML += `<div class="day-cell other-month"></div>`; }

        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month, day);
            const dateStr = date.toISOString().split('T');
            const todayStr = new Date().toISOString().split('T');
            let statusClass = 'absent';
            if (date > new Date()) statusClass = ''; // Future dates
            else if (dailyDurations[dateStr]) {
                const hours = dailyDurations[dateStr].duration / (1000 * 60 * 60);
                if (hours >= 5) statusClass = 'present';
                else if (hours > 0) statusClass = 'half-day';
            }
            const todayClass = dateStr === todayStr ? 'today' : '';
            grid.innerHTML += `<div class="day-cell ${statusClass} ${todayClass}">${day}</div>`;
        }
    };

    document.getElementById('calendar-prev-month').addEventListener('click', () => {
        appState.calendarContext.month--;
        if (appState.calendarContext.month < 0) {
            appState.calendarContext.month = 11;
            appState.calendarContext.year--;
        }
        renderAttendanceCalendar();
    });

    document.getElementById('calendar-next-month').addEventListener('click', () => {
        appState.calendarContext.month++;
        if (appState.calendarContext.month > 11) {
            appState.calendarContext.month = 0;
            appState.calendarContext.year++;
        }
        renderAttendanceCalendar();
    });
    
    document.getElementById('attendance-calendar-modal').addEventListener('click', e => {
        if (e.target.closest('[data-action="close-calendar"]') || e.target === e.currentTarget) {
            e.currentTarget.classList.remove('active');
        }
        
    });
    
    setupBetweenDateFilter('hr-report-date-filter', renderHRAttendanceReport);
    // ===============================================
    // END: HR ATTENDANCE FEATURE LOGIC
    // ===============================================
    const deleteVendor = async (vendorId) => {
        const deleteButton = document.getElementById('manage-vendor-delete-btn');
        deleteButton.disabled = true;
        deleteButton.textContent = 'Deleting...';

        try {
            const vendorRef = doc(db, 'purchaseVendors', vendorId);
            await deleteDoc(vendorRef);
            document.getElementById('vendor-manage-modal').classList.remove('active');
            showToast('Vendor deleted successfully.');
        } catch (error) {
            console.error("Error deleting vendor:", error);
            alert('There was an error deleting the vendor. Please try again.');
        } finally {
            deleteButton.disabled = false;
            deleteButton.textContent = 'Delete Vendor';
            appState.managingVendorId = null;
        }
    };

    const vendorManageModal = document.getElementById('vendor-manage-modal');

    // Listener for opening the modal
    document.getElementById('purchase-vendor-list').addEventListener('click', e => {
        const manageBtn = e.target.closest('.purchase-tile-manage-btn');
        if (manageBtn) {
            e.stopPropagation(); 
            const vendorId = manageBtn.dataset.vendorId;
            const vendor = appState.purchaseVendors.find(v => v.id === vendorId);
            if (vendor) {
                appState.managingVendorId = vendorId;
                document.getElementById('vendor-manage-modal-title').textContent = `Manage: ${vendor.name}`;
                vendorManageModal.classList.add('active');
            }
        }
    });

    // Listener for actions inside the modal (close, delete, etc.)
  // vvvv REPLACE your old 'vendorManageModal' listener with this complete version vvvv

// Listener for actions inside the MAIN management modal (Edit, Delete, Manage Items)
// ========================================================================
// === COMPLETE EVENT LISTENER FOR THE MAIN VENDOR MANAGEMENT MODAL ===
// ========================================================================
//
// Replace your existing 'vendorManageModal.addEventListener' with this block.
// It handles all button clicks within that specific modal.

vendorManageModal.addEventListener('click', e => {

    // --- 1. Handle CLOSING the modal ---
    // This triggers if the user clicks the dark background or the "Close" button.
    if (e.target === vendorManageModal || e.target.closest('[data-action="close-vendor-modal"]')) {
        vendorManageModal.classList.remove('active');
        appState.managingVendorId = null; // Clear the state when closing
    } 

    // --- 2. Handle clicking the DELETE button ---
    else if (e.target.closest('#manage-vendor-delete-btn')) {
        const vendorId = appState.managingVendorId;
        if (!vendorId) {
            alert('Error: No vendor selected. Please close and try again.');
            return;
        }
        const vendor = appState.purchaseVendors.find(v => v.id === vendorId);
        const vendorName = vendor ? vendor.name : 'this vendor';

        // Show a confirmation dialog before proceeding.
        if (confirm(`Are you sure you want to permanently delete ${vendorName}? This action cannot be undone.`)) {
            // Call the separate function that handles the database operation.
            deleteVendor(vendorId);
        }
    }

    // --- 3. Handle clicking the EDIT VENDOR DETAILS button ---
    else if (e.target.closest('#manage-vendor-edit-btn')) {
        const vendorId = appState.managingVendorId;
        const vendor = appState.purchaseVendors.find(v => v.id === vendorId);

        if (vendor) {
            // Populate the input fields in the separate "edit" modal with the vendor's current data.
            document.getElementById('edit-vendor-name').value = vendor.name;
            document.getElementById('edit-vendor-frequency').value = vendor.frequency;
            
            // Show the "edit" modal.
            document.getElementById('vendor-edit-modal').classList.add('active');
            
            // Hide the current management modal.
            vendorManageModal.classList.remove('active');
        } else {
            alert('Error: Could not find vendor details.');
        }
    }

    // --- 4. Handle clicking the MANAGE VENDOR ITEMS button ---
    else if (e.target.closest('#manage-vendor-items-btn')) {
        // This function opens the new page and fetches the items for the current vendor.
        renderVendorItemsPage(); 
        
        // Hide the current management modal.
        vendorManageModal.classList.remove('active');
    }
});
// --- START OF NEW FUNCTION ---
const uploadVendorItemsCSV = async (file, vendorId) => {
    const uploadBtn = document.getElementById('bulk-upload-csv-btn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        Uploading...
    `;

    const fileReader = new FileReader();

    // We wrap the FileReader in a Promise to use async/await
    const fileContents = await new Promise((resolve, reject) => {
        fileReader.onload = e => resolve(e.target.result);
        fileReader.onerror = reject;
        fileReader.readAsText(file);
    });

    try {
        const data = parseCSV(fileContents);
        if (!data || data.length === 0 || !data[0].item_code) {
            throw new Error("Invalid CSV format. Please ensure it has an 'item_code' column and is not empty.");
        }

        // Get a clean list of unique item codes from the CSV
        const itemCodes = [...new Set(data.map(row => row.item_code.trim()).filter(Boolean))];

        if (itemCodes.length === 0) {
            throw new Error("No valid item codes found in the CSV file.");
        }

        // Use a Firestore batch write for efficiency
        const batch = writeBatch(db);
        itemCodes.forEach(code => {
            const newItemRef = doc(collection(db, 'purchaseVendors', vendorId, 'vendorItems'));
            batch.set(newItemRef, { itemCode: code });
        });

        await batch.commit();

        showToast(`${itemCodes.length} items uploaded successfully!`);
        await renderVendorItemsPage(); // Refresh the item list on the page

    } catch (error) {
        console.error("Error during CSV upload:", error);
        alert(`Upload failed: ${error.message}`);
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            Bulk Upload from CSV
        `;
    }
};
// --- START OF NEW EVENT LISTENERS ---

// 1. Listen for clicks on the VISIBLE upload button
document.getElementById('bulk-upload-csv-btn').addEventListener('click', () => {
    // When the visible button is clicked, programmatically click the HIDDEN file input
    document.getElementById('vendor-item-bulk-upload-input').click();
});

// 2. Listen for when a file is selected in the HIDDEN input
document.getElementById('vendor-item-bulk-upload-input').addEventListener('change', e => {
    const file = e.target.files[0];
    const vendorId = appState.managingVendorId;

    if (file && vendorId) {
        // If a file was selected, call our main upload function
        uploadVendorItemsCSV(file, vendorId);
    }

    // Reset the input value so the 'change' event fires even if the same file is selected again
    e.target.value = '';
});

// --- END OF NEW EVENT LISTENERS ---
// --- END OF NEW FUNCTION ---


// ^^^^ The replacement block ends here ^^^^
    // --- START OF NEW CODE BLOCK ---
const vendorEditModal = document.getElementById('vendor-edit-modal');

vendorEditModal.addEventListener('click', async e => {
    // Handle closing the edit modal
    if (e.target === vendorEditModal || e.target.closest('[data-action="close-vendor-edit-modal"]')) {
        vendorEditModal.classList.remove('active');
        return;
    }

    // Handle clicking the "Save Changes" button
    const saveBtn = e.target.closest('#save-vendor-changes-btn');
    if (saveBtn) {
        const vendorId = appState.managingVendorId;
        const newName = document.getElementById('edit-vendor-name').value.trim();
        const newFrequency = parseInt(document.getElementById('edit-vendor-frequency').value);

        if (!newName || isNaN(newFrequency) || newFrequency <= 0) {
            alert('Please provide a valid name and a positive frequency number.');
            return;
        }

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            const vendorRef = doc(db, 'purchaseVendors', vendorId);
            await updateDoc(vendorRef, {
                name: newName,
                frequency: newFrequency
            });
            
            vendorEditModal.classList.remove('active');
            showToast('Vendor details updated successfully.');

        } catch (error) {
            console.error("Error updating vendor:", error);
            alert('Failed to update vendor. Please try again.');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
            appState.managingVendorId = null; // Clear state after action is complete
        }
    }
});
// --- END OF NEW CODE BLOCK ---

// --- START OF NEW CODE BLOCK FOR VENDOR ITEM MANAGEMENT ---

const renderVendorItemsPage = async () => {
    const vendorId = appState.managingVendorId;
    if (!vendorId) return;

    const vendor = appState.purchaseVendors.find(v => v.id === vendorId);
    if (!vendor) return;

    document.getElementById('vendor-items-header').textContent = `Items for ${vendor.name}`;
    const listContainer = document.getElementById('vendor-current-items-list');
    listContainer.innerHTML = '<p>Loading items...</p>';
    showPage('page-vendor-items');

    // Fetch the items from the subcollection
    const itemsSnapshot = await getDocs(collection(db, 'purchaseVendors', vendorId, 'vendorItems'));
    const vendorItems = itemsSnapshot.docs.map(doc => ({
        docId: doc.id,
        ...doc.data()
    }));

    if (vendorItems.length === 0) {
        listContainer.innerHTML = '<p style="text-align:center; color:#888;">No items have been assigned to this vendor yet.</p>';
        return;
    }

    listContainer.innerHTML = vendorItems.map(vItem => {
        const masterItem = appState.items.find(i => i.Code === vItem.itemCode);
        const itemName = masterItem ? masterItem.ItemName : `Unknown Item (Code: ${vItem.itemCode})`;
        
        return `
            <div class="list-item">
                <span class="info">${itemName}</span>
                <button class="delete-vendor-item-btn" data-item-doc-id="${vItem.docId}" title="Remove Item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
    }).join('');
};

// Listener for the back button on the new page
document.getElementById('back-to-purchase-planner-from-items-btn').addEventListener('click', () => {
    showPage('page-purchase-planner');
    appState.managingVendorId = null; // Clear state when going back
});

// Listener for the search input to add items
document.getElementById('vendor-add-item-search-input').addEventListener('input', e => {
    renderItemSearchResults(e.target.value, 'vendor-add-item-search-results', false);
});

// Listener for clicking a search result to add it
document.getElementById('vendor-add-item-search-results').addEventListener('click', async e => {
    const resultItem = e.target.closest('.search-result-item');
    if (resultItem) {
        const itemCode = resultItem.dataset.itemCode;
        const vendorId = appState.managingVendorId;
        if (!vendorId) return;

        // Hide the search results
        document.getElementById('vendor-add-item-search-input').value = '';
        document.getElementById('vendor-add-item-search-results').innerHTML = '';

        try {
            await addDoc(collection(db, 'purchaseVendors', vendorId, 'vendorItems'), { itemCode });
            showToast('Item added to vendor.');
            await renderVendorItemsPage(); // Refresh the list
        } catch (error) {
            console.error("Error adding item to vendor:", error);
            alert('Failed to add item. Please try again.');
        }
    }
});

// Listener for deleting an item from the vendor's list
document.getElementById('vendor-current-items-list').addEventListener('click', async e => {
    const deleteBtn = e.target.closest('.delete-vendor-item-btn');
    if (deleteBtn) {
        const itemDocId = deleteBtn.dataset.itemDocId;
        const vendorId = appState.managingVendorId;
        const listItem = deleteBtn.closest('.list-item');

        if (confirm('Are you sure you want to remove this item from the vendor?')) {
            try {
                await deleteDoc(doc(db, 'purchaseVendors', vendorId, 'vendorItems', itemDocId));
                
                // Animate and remove the item from the view
                listItem.classList.add('removing');
                setTimeout(() => listItem.remove(), 500);

                showToast('Item removed.');
            } catch (error) {
                console.error("Error removing item:", error);
                alert('Failed to remove item. Please try again.');
            }
        }
    }
});

// --- END OF NEW CODE BLOCK ---
    setupPWA();
    setupRealtimeListeners(); 

});</script>
<!-- ======================= VENDOR ITEMS MANAGE PAGE (NEW) ======================= -->
    <div id="page-vendor-items" class="page">
        <div class="header">
            <button class="icon-button" id="back-to-purchase-planner-from-items-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 id="vendor-items-header">Manage Items</h1>
            <div class="header-actions" style="width: 24px;"></div>
        </div>
        <div class="content">
           <div class="card">
     <h3>Add Items</h3>
     <!-- Single Item Search -->
     <div class="search-bar" style="position: relative; margin-bottom: 15px;">
         <input type="text" id="vendor-add-item-search-input" placeholder="Search and add one item...">
         <div id="vendor-add-item-search-results"></div>
     </div>

     <!-- Bulk Upload Button and Hidden Input -->
     <button class="button button-outline" id="bulk-upload-csv-btn">
         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
         Bulk Upload from CSV
     </button>
     <input type="file" id="vendor-item-bulk-upload-input" accept=".csv" style="display: none;">
 </div>
            <div class="card">
                <h3>Current Vendor Items</h3>
                <div id="vendor-current-items-list">
                    <!-- Items will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- This is where your other modals like vendor-manage-modal are -->
<!-- ======================= VENDOR MANAGE MODAL (NEW) ======================= -->
    <div id="vendor-manage-modal" class="modal">
        <div class="modal-content">
            <h2 id="vendor-manage-modal-title">Manage Vendor</h2>
            <div class="modal-body">
                <div class="vendor-manage-options">
                    <button class="button button-outline" id="manage-vendor-edit-btn">Edit Vendor Details</button>
                    <button class="button button-outline" id="manage-vendor-items-btn">Manage Vendor Items</button>
                    <button class="button button-danger" id="manage-vendor-delete-btn">Delete Vendor</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button button-outline" data-action="close-vendor-modal">Close</button>
            </div>
        </div>
    </div>
    <!-- ======================= VENDOR EDIT MODAL (NEW) ======================= -->
<div id="vendor-edit-modal" class="modal">
    <div class="modal-content">
        <h2>Edit Vendor Details</h2>
        <div class="modal-body">
            <div class="form-group">
                <label for="edit-vendor-name">Vendor Name</label>
                <input type="text" id="edit-vendor-name">
            </div>
            <div class="form-group">
                <label for="edit-vendor-frequency">Landing Frequency (in days)</label>
                <input type="number" id="edit-vendor-frequency">
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-outline" data-action="close-vendor-edit-modal">Cancel</button>
            <button class="button" id="save-vendor-changes-btn">Save Changes</button>
        </div>
    </div>
</div>

</body> <!-- <<< Add the code block just before this tag -->
</html>